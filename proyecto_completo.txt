REPORTE DE CODIGO DEL PROYECTO
=================================


--- INICIO ARCHIVO: app\admin\dashboard\page.tsx ---
'use client'

import { useEffect, useState } from 'react'
import { createClient } from '@/utils/supabase/client'
import { useRouter } from 'next/navigation'
import { 
  Users, DollarSign, Settings, BarChart3, LogOut, 
  Search, Trash2, Edit, Save, CheckCircle, XCircle, Loader2 
} from 'lucide-react'

const ADMIN_EMAIL = "azureusvip@proton.me"

// --- TIPOS BASADOS EN TU SCHEMA ---
interface Profile {
  id: string
  email: string | null
  first_name: string | null
  last_name: string | null
  role: 'student' | 'teacher' | 'admin'
}

interface DepositRequest {
  id: string
  student_id: string
  amount: number
  method: string
  reference_id: string | null
  status: string
  created_at: string
  // Join manual
  student_email?: string
}

interface PayoutRequest {
  id: string
  teacher_id: string
  amount: number
  method: string
  payment_address: string
  status: string
  created_at: string
  // Join manual
  teacher_email?: string
}

export default function AdminDashboard() {
  const router = useRouter()
  const [supabase] = useState(() => createClient())
  const [loading, setLoading] = useState(true)
  const [section, setSection] = useState<'overview' | 'users' | 'finance' | 'settings'>('overview')
  const [activeTab, setActiveTab] = useState<'deposits' | 'payouts'>('deposits')
  
  // DATOS GLOBALES
  const [users, setUsers] = useState<Profile[]>([])
  const [deposits, setDeposits] = useState<DepositRequest[]>([])
  const [payouts, setPayouts] = useState<PayoutRequest[]>([])
  const [config, setConfig] = useState({ platformFee: 15 }) 
  const [processingId, setProcessingId] = useState<string | null>(null)

  useEffect(() => {
    checkAuthAndLoad()
  }, [])

  const checkAuthAndLoad = async () => {
    const { data: { user } } = await supabase.auth.getUser()
    if (!user || user.email !== ADMIN_EMAIL) {
      router.push('/login')
      return
    }
    await loadAllData()
    setLoading(false)
  }

  const loadAllData = async () => {
    // 1. Cargar Usuarios
    const { data: allUsers } = await supabase.from('profiles').select('*')
    if (allUsers) setUsers(allUsers as any)

    // 2. Cargar Finanzas (Hacemos las consultas simples y cruzamos datos manualmente para evitar errores de JOIN complejos)
    
    // -- Depósitos --
    const { data: deps } = await supabase.from('deposit_requests').select('*').order('created_at', { ascending: false })
    if (deps) {
        // Enriquecemos con el email del usuario buscando en el array de users que ya cargamos
        const enrichedDeposits = deps.map((d: any) => ({
            ...d,
            student_email: allUsers?.find(u => u.id === d.student_id)?.email || 'Desconocido'
        }))
        setDeposits(enrichedDeposits)
    }

    // -- Pagos --
    const { data: pays } = await supabase.from('payout_requests').select('*').order('created_at', { ascending: false })
    if (pays) {
         const enrichedPayouts = pays.map((p: any) => ({
            ...p,
            teacher_email: allUsers?.find(u => u.id === p.teacher_id)?.email || 'Desconocido'
        }))
        setPayouts(enrichedPayouts)
    }
  }

  // --- ACCIONES DE FINANZAS ---
  const handleApproveDeposit = async (deposit: DepositRequest) => {
      if(!confirm(`¿Aprobar $${deposit.amount}?`)) return
      setProcessingId(deposit.id)
      try {
          // 1. Buscar o crear wallet
          let { data: wallet } = await supabase.from('wallets').select('*').eq('user_id', deposit.student_id).single()
          
          if (!wallet) {
             const { data: newWallet, error } = await supabase.from('wallets').insert({ user_id: deposit.student_id, balance: 0 }).select().single()
             if (error) throw error
             wallet = newWallet
          }

          // 2. Sumar saldo
          await supabase.from('wallets').update({ balance: (wallet.balance || 0) + deposit.amount }).eq('user_id', deposit.student_id)
          // 3. Actualizar estado
          await supabase.from('deposit_requests').update({ status: 'approved' }).eq('id', deposit.id)
          
          await loadAllData()
      } catch (e: any) { alert("Error: " + e.message) } finally { setProcessingId(null) }
  }

  const handleMarkPaid = async (payout: PayoutRequest) => {
      if(!confirm("¿Confirmar pago enviado?")) return
      setProcessingId(payout.id)
      try {
          await supabase.from('payout_requests').update({ status: 'paid', processed_at: new Date() }).eq('id', payout.id)
          await loadAllData()
      } catch (e: any) { alert("Error: " + e.message) } finally { setProcessingId(null) }
  }

  // --- COMPONENTES DE SECCIÓN ---

  const OverviewSection = () => {
    const totalDeposited = deposits.filter(d => d.status === 'approved').reduce((acc, curr) => acc + curr.amount, 0)
    const platformFees = totalDeposited * (config.platformFee / 100)

    return (
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div className="bg-white p-6 rounded-lg shadow border-l-4 border-blue-500">
          <h3 className="text-gray-500 text-sm font-bold uppercase">Usuarios</h3>
          <p className="text-3xl font-bold">{users.length}</p>
        </div>
        <div className="bg-white p-6 rounded-lg shadow border-l-4 border-green-500">
          <h3 className="text-gray-500 text-sm font-bold uppercase">Ingresos</h3>
          <p className="text-3xl font-bold">${totalDeposited.toFixed(2)}</p>
        </div>
        <div className="bg-white p-6 rounded-lg shadow border-l-4 border-purple-500">
          <h3 className="text-gray-500 text-sm font-bold uppercase">Ganancias ({config.platformFee}%)</h3>
          <p className="text-3xl font-bold">${platformFees.toFixed(2)}</p>
        </div>
      </div>
    )
  }

  const UsersSection = () => (
    <div className="bg-white rounded-lg shadow overflow-hidden">
      <div className="p-4 border-b flex justify-between items-center">
        <h3 className="font-bold text-lg">Directorio</h3>
        <div className="relative">
          <Search className="w-4 h-4 absolute left-3 top-3 text-gray-400"/>
          <input type="text" placeholder="Buscar..." className="pl-9 pr-4 py-2 border rounded bg-slate-50 text-sm w-64"/>
        </div>
      </div>
      <table className="w-full text-sm text-left">
        <thead className="bg-slate-50 text-gray-500 font-bold uppercase text-xs">
          <tr><th className="p-4">Nombre</th><th className="p-4">Email</th><th className="p-4">Rol</th><th className="p-4 text-right">Acción</th></tr>
        </thead>
        <tbody>
          {users.map(u => (
            <tr key={u.id} className="border-t hover:bg-slate-50">
              <td className="p-4 font-bold">{u.first_name || 'Sin nombre'} {u.last_name || ''}</td>
              <td className="p-4 text-gray-600">{u.email}</td>
              <td className="p-4"><span className={`px-2 py-1 rounded text-xs font-bold uppercase ${u.role==='teacher'?'bg-purple-100 text-purple-700': u.role==='admin'?'bg-red-100 text-red-700':'bg-blue-100 text-blue-700'}`}>{u.role}</span></td>
              <td className="p-4 text-right"><button className="text-blue-600 hover:underline">Editar</button></td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  )

  const FinanceSection = () => (
    <div className="bg-white rounded-lg shadow p-6">
        <div className="flex gap-4 mb-6 border-b">
            <button onClick={() => setActiveTab('deposits')} className={`pb-2 px-4 font-bold border-b-2 ${activeTab==='deposits' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-400'}`}>Depósitos</button>
            <button onClick={() => setActiveTab('payouts')} className={`pb-2 px-4 font-bold border-b-2 ${activeTab==='payouts' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-400'}`}>Pagos</button>
        </div>

        {activeTab === 'deposits' ? (
            <table className="w-full text-sm text-left">
                <thead className="bg-slate-50 font-bold text-gray-500 uppercase text-xs">
                    <tr><th className="p-3">Usuario</th><th className="p-3">Monto</th><th className="p-3">Ref</th><th className="p-3">Estado</th><th className="p-3">Acción</th></tr>
                </thead>
                <tbody>
                    {deposits.map(d => (
                        <tr key={d.id} className="border-t">
                            <td className="p-3">{d.student_email}</td>
                            <td className="p-3 font-bold text-green-600">+${d.amount}</td>
                            <td className="p-3 font-mono text-xs">{d.reference_id}</td>
                            <td className="p-3"><span className={`px-2 py-1 rounded text-xs font-bold ${d.status==='approved'?'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-800'}`}>{d.status}</span></td>
                            <td className="p-3">
                                {d.status === 'pending' && (
                                    <button disabled={!!processingId} onClick={() => handleApproveDeposit(d)} className="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-green-700">
                                        {processingId === d.id ? <Loader2 className="animate-spin w-4 h-4"/> : 'Aprobar'}
                                    </button>
                                )}
                            </td>
                        </tr>
                    ))}
                    {deposits.length === 0 && <tr><td colSpan={5} className="p-4 text-center text-gray-400">Sin registros</td></tr>}
                </tbody>
            </table>
        ) : (
            <table className="w-full text-sm text-left">
                <thead className="bg-slate-50 font-bold text-gray-500 uppercase text-xs">
                    <tr><th className="p-3">Maestro</th><th className="p-3">Monto</th><th className="p-3">Destino</th><th className="p-3">Estado</th><th className="p-3">Acción</th></tr>
                </thead>
                <tbody>
                    {payouts.map(p => (
                        <tr key={p.id} className="border-t">
                            <td className="p-3">{p.teacher_email}</td>
                            <td className="p-3 font-bold text-slate-800">${p.amount}</td>
                            <td className="p-3 font-mono text-xs">{p.payment_address}</td>
                            <td className="p-3"><span className={`px-2 py-1 rounded text-xs font-bold ${p.status==='paid'?'bg-blue-100 text-blue-700':'bg-yellow-100 text-yellow-800'}`}>{p.status}</span></td>
                            <td className="p-3">
                                {p.status === 'pending' && (
                                    <button disabled={!!processingId} onClick={() => handleMarkPaid(p)} className="bg-slate-900 text-white px-3 py-1 rounded text-xs font-bold hover:bg-slate-700">
                                        {processingId === p.id ? <Loader2 className="animate-spin w-4 h-4"/> : 'Pagar'}
                                    </button>
                                )}
                            </td>
                        </tr>
                    ))}
                     {payouts.length === 0 && <tr><td colSpan={5} className="p-4 text-center text-gray-400">Sin registros</td></tr>}
                </tbody>
            </table>
        )}
    </div>
  )

  const SettingsSection = () => (
    <div className="max-w-xl bg-white p-8 rounded-lg shadow">
      <h3 className="font-bold text-xl mb-6">Configuración</h3>
      <div className="mb-6">
        <label className="block text-sm font-bold mb-2">Comisión (%)</label>
        <div className="flex gap-4">
          <input type="number" value={config.platformFee} onChange={(e) => setConfig({...config, platformFee: Number(e.target.value)})} className="border p-2 rounded w-32 font-bold"/>
          <button className="bg-indigo-600 text-white px-4 py-2 rounded font-bold">Guardar</button>
        </div>
      </div>
    </div>
  )

  if (loading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-indigo-600 w-10 h-10"/></div>

  return (
    <div className="flex min-h-screen bg-slate-100 font-sans text-slate-900">
      <aside className="w-64 bg-slate-900 text-white flex flex-col fixed h-full z-10">
        <div className="p-6 font-bold text-xl tracking-tight">Tutorio<span className="text-indigo-400">Admin</span></div>
        <nav className="flex-1 px-4 space-y-2 mt-4">
          <button onClick={() => setSection('overview')} className={`w-full flex items-center gap-3 px-4 py-3 rounded text-sm font-medium ${section==='overview' ? 'bg-indigo-600' : 'hover:bg-slate-800'}`}><BarChart3 size={18}/> Resumen</button>
          <button onClick={() => setSection('users')} className={`w-full flex items-center gap-3 px-4 py-3 rounded text-sm font-medium ${section==='users' ? 'bg-indigo-600' : 'hover:bg-slate-800'}`}><Users size={18}/> Usuarios</button>
          <button onClick={() => setSection('finance')} className={`w-full flex items-center gap-3 px-4 py-3 rounded text-sm font-medium ${section==='finance' ? 'bg-indigo-600' : 'hover:bg-slate-800'}`}><DollarSign size={18}/> Finanzas</button>
          <button onClick={() => setSection('settings')} className={`w-full flex items-center gap-3 px-4 py-3 rounded text-sm font-medium ${section==='settings' ? 'bg-indigo-600' : 'hover:bg-slate-800'}`}><Settings size={18}/> Configuración</button>
        </nav>
        <div className="p-4 border-t border-slate-800">
          <button onClick={() => { supabase.auth.signOut(); router.push('/') }} className="flex items-center gap-2 text-slate-400 hover:text-white text-sm"><LogOut size={16}/> Salir</button>
        </div>
      </aside>

      <main className="flex-1 ml-64 p-8">
        <header className="flex justify-between items-center mb-8">
          <h1 className="text-2xl font-bold text-slate-800">
            {section === 'overview' && 'Visión General'}
            {section === 'users' && 'Gestión de Usuarios'}
            {section === 'finance' && 'Control Financiero'}
            {section === 'settings' && 'Ajustes'}
          </h1>
        </header>

        {section === 'overview' && <OverviewSection />}
        {section === 'users' && <UsersSection />}
        {section === 'finance' && <FinanceSection />}
        {section === 'settings' && <SettingsSection />}
      </main>
    </div>
  )
}

--- FIN ARCHIVO: app\admin\dashboard\page.tsx ---

--- INICIO ARCHIVO: app\api\translate\route.ts ---
import { NextResponse } from 'next/server';
// Usaremos una librería ligera que no requiere API Key
const { translate } = require('google-translate-api-x'); 

export async function POST(request: Request) {
    try {
        const body = await request.json();
        const { text, source, target } = body;

        if (!text) {
            return NextResponse.json({ error: 'Falta texto para traducir' }, { status: 400 });
        }

        // Traducir usando el motor de Google (Gratis & Robusto)
        const res = await translate(text, {
            from: source === 'auto' ? undefined : source,
            to: target,
            autoCorrect: true, // Corrige typos pequeños del dictado por voz
        });

        return NextResponse.json({ 
            original: text,
            translatedText: res.text,
            from: res.from.language.iso 
        });

    } catch (error) {
        console.error('Translation Error:', error);
        return NextResponse.json(
            { error: 'Error interno de traducción', details: String(error) }, 
            { status: 500 }
        );
    }
}

--- FIN ARCHIVO: app\api\translate\route.ts ---

--- INICIO ARCHIVO: app\become-teacher\page.tsx ---
import Link from 'next/link';
import { CheckCircle, DollarSign, Calendar, ArrowRight } from 'lucide-react';

export default function BecomeTeacherPage() {
  return (
    <main className="min-h-screen bg-white font-sans text-slate-900">
      {/* Navbar Simple */}
      <nav className="p-6 border-b border-slate-100 flex justify-between items-center">
        <Link href="/" className="text-2xl font-bold text-indigo-600">Tutorio</Link>
        <Link href="/login" className="font-medium text-slate-600 hover:text-indigo-600">Login</Link>
      </nav>

      {/* Hero Teacher */}
      <section className="py-20 bg-slate-50">
        <div className="max-w-5xl mx-auto px-6 text-center">
          <h1 className="text-5xl font-extrabold mb-6 text-slate-900">
            Share your knowledge. <span className="text-indigo-600">Earn on your terms.</span>
          </h1>
          <p className="text-xl text-slate-600 mb-10 max-w-2xl mx-auto">
            Join the platform that handles the boring stuff (payments, scheduling, video) so you can focus on teaching.
          </p>
          <Link href="/register" className="inline-flex items-center gap-2 px-8 py-4 bg-indigo-600 text-white rounded-full font-bold text-lg hover:bg-indigo-700 transition-all shadow-xl">
            Start Teaching Today <ArrowRight className="w-5 h-5"/>
          </Link>
        </div>
      </section>

      {/* Benefits */}
      <section className="py-20">
        <div className="max-w-6xl mx-auto px-6 grid md:grid-cols-3 gap-12">
            {[
                { icon: <DollarSign className="w-8 h-8 text-green-600"/>, title: "Set Your Rates", desc: "You decide how much your time is worth. We take a small commission only when you earn." },
                { icon: <Calendar className="w-8 h-8 text-blue-600"/>, title: "Flexible Schedule", desc: "Open your calendar only when you want to work. Perfect for side hustles or full-time careers." },
                { icon: <CheckCircle className="w-8 h-8 text-indigo-600"/>, title: "Guaranteed Payments", desc: "No more chasing students for money. We secure the payment before the class starts." }
            ].map((b, i) => (
                <div key={i} className="bg-white p-8 rounded-2xl border border-slate-100 shadow-sm text-center">
                    <div className="bg-slate-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6">{b.icon}</div>
                    <h3 className="text-xl font-bold mb-3">{b.title}</h3>
                    <p className="text-slate-500">{b.desc}</p>
                </div>
            ))}
        </div>
      </section>
    </main>
  )
}
--- FIN ARCHIVO: app\become-teacher\page.tsx ---

--- INICIO ARCHIVO: app\browse\page.tsx ---
import Link from 'next/link';
import { Star, MapPin, CheckCircle } from 'lucide-react';

export default function PublicBrowse() {
  // DATOS FALSOS PERO REALISTAS (Perfil Latino/Hispano)
  // Sin precios, solo calidad y valor.
  const previewTutors = [
    { 
      name: "Alejandro Rivera", 
      lang: "Spanish Native & English C1", 
      rating: "5.0", 
      reviews: "120",
      location: "San Salvador, SV",
      img: "https://images.unsplash.com/photo-1566492031773-4f4e44671857?auto=format&fit=crop&w=200&h=200&q=80" // Rostro latino masculino
    },
    { 
      name: "Valentina Gómez", 
      lang: "English Native (Bilingual)", 
      rating: "4.9", 
      reviews: "85",
      location: "Mexico City, MX",
      img: "https://images.unsplash.com/photo-1589156280159-27698a70f29e?auto=format&fit=crop&w=200&h=200&q=80" // Rostro latino femenino profesional
    },
    { 
      name: "Carlos Mendoza", 
      lang: "Spanish & English", 
      rating: "5.0", 
      reviews: "210",
      location: "Bogotá, CO",
      img: "https://images.unsplash.com/photo-1547425260-76bcadfb4f2c?auto=format&fit=crop&w=200&h=200&q=80" // Rostro latino masculino
    },
    { 
      name: "Gabriela Torres", 
      lang: "Spanish Native", 
      rating: "4.8", 
      reviews: "45",
      location: "Santa Tecla, SV",
      img: "https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=crop&w=200&h=200&q=80" // Rostro femenino
    },
    { 
      name: "Javier Hernández", 
      lang: "English B2 & Spanish", 
      rating: "4.9", 
      reviews: "92",
      location: "Lima, PE",
      img: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?auto=format&fit=crop&w=200&h=200&q=80" // Rostro masculino sonriente
    },
    { 
      name: "Lucía Morales", 
      lang: "Advanced English", 
      rating: "5.0", 
      reviews: "150",
      location: "San José, CR",
      img: "https://images.unsplash.com/photo-1573496359142-b8d87734a5a2?auto=format&fit=crop&w=200&h=200&q=80" // Rostro femenino profesional
    },
  ];

  return (
    <main className="min-h-screen bg-slate-50 font-sans text-slate-900">
       {/* Navbar Simple */}
       <nav className="p-6 bg-white border-b border-slate-200 sticky top-0 z-20 flex justify-between items-center shadow-sm">
        <Link href="/" className="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-violet-600">
            Tutorio
        </Link>
        <div className="flex gap-4">
             <Link href="/login" className="hidden sm:block font-medium text-slate-600 hover:text-indigo-600 px-4 py-2">Login</Link>
             <Link href="/register" className="font-bold bg-indigo-600 text-white px-6 py-2 rounded-full hover:bg-indigo-700 transition-all shadow-md hover:shadow-lg">
                Sign Up
             </Link>
        </div>
      </nav>

      {/* Header Section */}
      <div className="bg-white border-b border-slate-200 py-16 px-6">
        <div className="max-w-5xl mx-auto text-center">
            <h1 className="text-4xl font-extrabold text-slate-900 mb-4">Find your perfect tutor</h1>
            <p className="text-xl text-slate-500 max-w-2xl mx-auto">
                Connect with certified tutors from Latin America and beyond. Learn at your own pace with native speakers.
            </p>
        </div>
      </div>

      {/* Grid de Tutores */}
      <div className="max-w-6xl mx-auto px-6 py-12">
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
            {previewTutors.map((t, i) => (
                <div key={i} className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden hover:shadow-xl hover:-translate-y-1 transition-all duration-300 group">
                    
                    {/* Header de la Tarjeta */}
                    <div className="p-6 flex items-start gap-4">
                        <div className="relative">
                            <img src={t.img} alt={t.name} className="w-20 h-20 rounded-full object-cover border-4 border-slate-50 shadow-sm" />
                            <div className="absolute bottom-0 right-0 bg-green-500 w-4 h-4 rounded-full border-2 border-white"></div>
                        </div>
                        <div>
                            <h3 className="font-bold text-lg text-slate-900 group-hover:text-indigo-600 transition-colors">{t.name}</h3>
                            <div className="flex items-center gap-1 text-slate-500 text-xs mb-1">
                                <MapPin className="w-3 h-3" /> {t.location}
                            </div>
                            <p className="text-sm font-medium text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-md inline-block">
                                {t.lang}
                            </p>
                        </div>
                    </div>

                    {/* Stats */}
                    <div className="px-6 pb-4 flex items-center gap-4 text-sm">
                        <div className="flex items-center gap-1 font-bold text-slate-900">
                            <Star className="w-4 h-4 text-amber-500 fill-current"/> {t.rating}
                        </div>
                        <span className="text-slate-400">|</span>
                        <div className="text-slate-500">
                            {t.reviews} reviews
                        </div>
                    </div>

                    {/* Footer / CTA (SIN PRECIO) */}
                    <div className="p-4 bg-slate-50 border-t border-slate-100 flex justify-between items-center gap-3">
                        <Link href="/register" className="flex-1 bg-white border border-slate-200 text-slate-700 py-2.5 rounded-xl font-bold text-sm text-center hover:bg-slate-100 transition-colors">
                            View Profile
                        </Link>
                        <Link href="/register" className="flex-1 bg-indigo-600 text-white py-2.5 rounded-xl font-bold text-sm text-center hover:bg-indigo-700 shadow-indigo-200 shadow-md transition-all">
                            Book Trial
                        </Link>
                    </div>
                </div>
            ))}
        </div>

        {/* Bloqueo "Ver Más" */}
        <div className="mt-16 text-center">
            <div className="inline-block p-1 bg-white rounded-full border border-slate-200 shadow-sm mb-6">
                <div className="flex -space-x-2 px-4 py-2">
                    {previewTutors.slice(0,4).map((t,i) => (
                        <img key={i} src={t.img} className="w-8 h-8 rounded-full border-2 border-white" />
                    ))}
                    <div className="w-8 h-8 rounded-full border-2 border-white bg-slate-100 flex items-center justify-center text-xs font-bold text-slate-500">+99</div>
                </div>
            </div>
            <h2 className="text-2xl font-bold text-slate-900 mb-4">Want to see more tutors?</h2>
            <Link href="/register" className="inline-flex items-center gap-2 px-8 py-4 bg-slate-900 text-white rounded-full font-bold hover:bg-slate-800 transition-all shadow-xl hover:scale-105">
                Create Free Account to Browse All
            </Link>
        </div>
      </div>
    </main>
  )
}
--- FIN ARCHIVO: app\browse\page.tsx ---

--- INICIO ARCHIVO: app\cookies\page.tsx ---
import Link from 'next/link';
import { ArrowLeft } from 'lucide-react';

export default function CookiesPage() {
  return (
    <main className="min-h-screen bg-slate-50 font-sans text-slate-900">
      <nav className="bg-white border-b border-slate-200 p-6 sticky top-0 z-10">
        <div className="max-w-4xl mx-auto flex items-center gap-4">
            <Link href="/" className="text-slate-500 hover:text-indigo-600 flex items-center gap-2 text-sm font-bold">
                <ArrowLeft className="w-4 h-4" /> Back to Home
            </Link>
            <span className="text-xl font-bold text-slate-900">Cookie Policy</span>
        </div>
      </nav>

      <div className="max-w-4xl mx-auto p-8 md:p-12 bg-white mt-8 mb-20 shadow-sm rounded-xl border border-slate-200">
        <h1 className="text-4xl font-extrabold mb-2 text-slate-900">Cookie Policy</h1>
        <p className="text-slate-500 mb-10">Last updated: December 16, 2025</p>

        <div className="space-y-8 text-slate-700 leading-relaxed">
            <section>
                <h2 className="text-xl font-bold text-slate-900 mb-3">1. What are cookies?</h2>
                <p>Cookies are small text files that are stored on your device when you visit a website. They are widely used to make websites work more efficiently and to provide information to the owners of the site.</p>
            </section>

            <section>
                <h2 className="text-xl font-bold text-slate-900 mb-3">2. How we use cookies</h2>
                <p>Tutorio uses cookies for the following purposes:</p>
                <div className="mt-4 space-y-4">
                    <div className="p-4 bg-slate-50 rounded-lg border border-slate-100">
                        <h3 className="font-bold text-indigo-700">Essential Cookies</h3>
                        <p className="text-sm">These are necessary for the website to function (e.g., logging in, keeping your session active). You cannot opt-out of these.</p>
                    </div>
                    <div className="p-4 bg-slate-50 rounded-lg border border-slate-100">
                        <h3 className="font-bold text-indigo-700">Performance Cookies</h3>
                        <p className="text-sm">These help us understand how visitors interact with the website by collecting and reporting information anonymously.</p>
                    </div>
                </div>
            </section>

            <section>
                <h2 className="text-xl font-bold text-slate-900 mb-3">3. Managing Cookies</h2>
                <p>Most web browsers allow you to control cookies through their settings preferences. However, if you limit the ability of websites to set cookies, you may worsen your overall user experience, since it will no longer be personalized to you.</p>
            </section>
        </div>
      </div>
    </main>
  )
}
--- FIN ARCHIVO: app\cookies\page.tsx ---

--- INICIO ARCHIVO: app\dashboard\student\find-tutors\page.tsx ---
'use client'

import { useEffect, useState } from 'react'
import { createClient } from '@/utils/supabase/client'
import { Search, MapPin, Star, Calendar, Clock, CheckCircle, Loader2, User, CreditCard } from 'lucide-react'
import { useRouter } from 'next/navigation'

export default function FindTutorsPage() {
  const router = useRouter()
  // Asegúrate de usar tu createClient personalizado
  const [supabase] = useState(() => createClient())
  
  const [loading, setLoading] = useState(true)
  const [tutors, setTutors] = useState<any[]>([])
  const [selectedTutor, setSelectedTutor] = useState<any>(null)
  const [availableSlots, setAvailableSlots] = useState<any[]>([])
  const [bookingLoading, setBookingLoading] = useState<string | null>(null)

  // 1. Fetch Tutors (Teachers)
  useEffect(() => {
    const fetchTutors = async () => {
      try {
        const { data, error } = await supabase
          .from('profiles')
          .select('*')
          .eq('role', 'teacher')
        
        if (data) setTutors(data)
      } catch (error) {
        console.error("Error fetching tutors:", error)
      } finally {
        setLoading(false)
      }
    }
    fetchTutors()
  }, [supabase])

  // 2. Fetch Schedule (VERSIÓN DEBUG: SIN FILTRO DE FECHA)
  const handleViewSchedule = async (tutor: any) => {
    setSelectedTutor(tutor)
    setAvailableSlots([])
    
    // const today = new Date().toISOString().split('T')[0]

    const { data } = await supabase
        .from('bookings')
        .select('*')
        .eq('teacher_id', tutor.id)
        .is('student_id', null) // Only free slots
        // .gte('date', today) <--- COMENTADO TEMPORALMENTE PARA VERIFICAR TODO
        .order('date', { ascending: true })
        .order('time', { ascending: true })
    
    if (data) setAvailableSlots(data)
  }

  // 3. Book Slot logic (CON COBRO REAL)
  const handleBookSlot = async (slotId: string) => {
    if (!selectedTutor) return;
    setBookingLoading(slotId)

    try {
        // A. Obtener Usuario Actual
        const { data: { user } } = await supabase.auth.getUser()
        if (!user) return router.push('/login')

        // B. Obtener Saldo del Estudiante
        const { data: wallet } = await supabase
            .from('wallets')
            .select('balance')
            .eq('user_id', user.id)
            .single()

        const studentBalance = Number(wallet?.balance || 0)
        const classPrice = Number(selectedTutor.hourly_rate || 15) // Precio del maestro (o 15 base)

        // C. Verificar Fondos
        if (studentBalance < classPrice) {
            alert(`⚠️ Saldo insuficiente.\n\nTu saldo: $${studentBalance.toFixed(2)}\nPrecio clase: $${classPrice.toFixed(2)}\n\nPor favor recarga tu billetera en el Dashboard.`)
            return // Detener si no hay dinero
        }

        // D. TRANSACCIÓN: Descontar Saldo
        const { error: walletError } = await supabase
            .from('wallets')
            .update({ balance: studentBalance - classPrice })
            .eq('user_id', user.id)

        if (walletError) throw new Error("Error procesando el pago en billetera.")

        // E. Reservar Clase (Guardando precio pagado para el maestro)
        const { error: bookingError } = await supabase
            .from('bookings')
            .update({ 
                student_id: user.id,
                status: 'confirmed',
                topic: 'Clase Reservada',
                price_paid: classPrice
            })
            .eq('id', slotId)

        if (bookingError) {
            // Rollback simple si falla la reserva (devolver dinero)
            await supabase.from('wallets').update({ balance: studentBalance }).eq('user_id', user.id)
            throw new Error("Error al reservar la hora. Se ha devuelto tu saldo.")
        }

        alert(`✅ ¡Clase reservada con éxito!\nSe descontaron $${classPrice.toFixed(2)} de tu saldo.`)
        
        // F. Redirigir al Dashboard
        setSelectedTutor(null)
        router.push('/dashboard/student')

    } catch (error: any) {
        console.error(error)
        alert("Error: " + error.message)
    } finally {
        setBookingLoading(null)
    }
  }

  if (loading) return <div className="min-h-screen flex items-center justify-center bg-slate-50"><Loader2 className="w-8 h-8 animate-spin text-indigo-600"/></div>

  return (
    <div className="min-h-screen bg-slate-50 p-6 md:p-8 font-sans text-slate-900">
        
        {/* Header */}
        <div className="mb-8">
            <h1 className="text-3xl font-bold text-slate-900">Find a Tutor</h1>
            <p className="text-slate-500">Explore our list of experts and book your class today.</p>
        </div>

        {/* Tutors Grid */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {tutors.length === 0 ? (
                <div className="col-span-full text-center py-12 bg-white rounded-2xl border border-dashed border-slate-300">
                    <p className="text-slate-500">No tutors registered yet.</p>
                </div>
            ) : (
                tutors.map((tutor) => (
                    <div key={tutor.id} className="bg-white rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-all overflow-hidden flex flex-col">
                        <div className="p-6 flex flex-col items-center text-center border-b border-slate-50">
                            <div className="w-24 h-24 bg-indigo-100 rounded-full mb-4 flex items-center justify-center text-3xl font-bold text-indigo-600 overflow-hidden">
                                {tutor.avatar_url ? <img src={tutor.avatar_url} alt="Avatar" className="w-full h-full object-cover"/> : tutor.first_name?.charAt(0)}
                            </div>
                            <h2 className="text-xl font-bold text-slate-900">{tutor.first_name} {tutor.last_name}</h2>
                            <p className="text-sm text-slate-500 flex items-center gap-1 mt-1">
                                <MapPin className="w-3 h-3"/> {tutor.location || 'Online'}
                            </p>
                            
                            <div className="flex gap-2 mt-3 items-center justify-center flex-wrap">
                                <span className="px-3 py-1 bg-green-100 text-green-700 text-xs font-bold rounded-full flex items-center gap-1">
                                    <CreditCard className="w-3 h-3"/> ${tutor.hourly_rate || 15}/h
                                </span>
                                <span className="px-3 py-1 bg-indigo-50 text-indigo-700 text-xs font-bold rounded-full capitalize">
                                    {tutor.specialty || 'General'}
                                </span>
                            </div>
                        </div>
                        
                        <div className="p-4 bg-slate-50 flex-1 flex items-end">
                            <button 
                                onClick={() => handleViewSchedule(tutor)}
                                className="w-full bg-white border border-slate-300 hover:bg-indigo-600 hover:text-white hover:border-indigo-600 text-slate-700 font-bold py-3 rounded-xl transition-all flex items-center justify-center gap-2"
                            >
                                <Calendar className="w-4 h-4"/> View Schedule
                            </button>
                        </div>
                    </div>
                ))
            )}
        </div>

        {/* MODAL: AVAILABLE SLOTS */}
        {selectedTutor && (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
                    
                    {/* Modal Header */}
                    <div className="p-6 bg-slate-900 text-white flex justify-between items-center">
                        <div>
                            <h3 className="text-xl font-bold">Book with {selectedTutor.first_name}</h3>
                            <p className="text-slate-400 text-xs">Price per class: <span className="text-green-400 font-bold">${selectedTutor.hourly_rate || 15}</span></p>
                        </div>
                        <button onClick={() => setSelectedTutor(null)} className="p-2 hover:bg-white/10 rounded-full transition-colors">
                            ✕
                        </button>
                    </div>

                    {/* Slots List */}
                    <div className="p-6 overflow-y-auto">
                        {availableSlots.length === 0 ? (
                            <div className="text-center py-8">
                                <Calendar className="w-12 h-12 text-slate-200 mx-auto mb-3"/>
                                <p className="text-slate-600 font-bold">No slots available</p>
                                <p className="text-sm text-slate-400">This tutor hasn't posted any free slots recently.</p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 gap-3">
                                {availableSlots.map((slot) => (
                                    <div key={slot.id} className="border border-slate-200 rounded-xl p-4 flex items-center justify-between hover:border-indigo-500 hover:bg-indigo-50 transition-all group">
                                        <div className="flex items-center gap-3">
                                            <div className="bg-indigo-100 text-indigo-700 p-2 rounded-lg">
                                                <Clock className="w-5 h-5"/>
                                            </div>
                                            <div>
                                                <p className="font-bold text-slate-900">{slot.time}</p>
                                                <p className="text-xs text-slate-500 uppercase font-bold">{slot.date}</p>
                                            </div>
                                        </div>
                                        <button 
                                            onClick={() => handleBookSlot(slot.id)}
                                            disabled={bookingLoading === slot.id}
                                            className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md transition-all disabled:opacity-50 flex items-center gap-2"
                                        >
                                            {bookingLoading === slot.id ? <Loader2 className="w-4 h-4 animate-spin"/> : "Book & Pay"}
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            </div>
        )}

    </div>
  )
}

--- FIN ARCHIVO: app\dashboard\student\find-tutors\page.tsx ---

--- INICIO ARCHIVO: app\dashboard\student\messages\page.tsx ---
'use client'

import { useState, useEffect, useRef } from 'react'
import { ArrowLeft, Send, Search, MessageSquare, Loader2, User } from 'lucide-react'
import Link from 'next/link'
import { createClient } from '@/utils/supabase/client'

// Tipos reales basados en Supabase
interface Contact {
  id: string
  name: string
  email: string
  lastMsg: string
  time: string
}

interface Message {
  id: string
  sender_id: string
  content: string
  created_at: string
  is_mine: boolean
}

export default function Messages() {
  const [supabase] = useState(() => createClient())
  const [loading, setLoading] = useState(true)
  const [currentUser, setCurrentUser] = useState<any>(null)
  
  const [activeChatId, setActiveChatId] = useState<string | null>(null)
  const [contacts, setContacts] = useState<Contact[]>([]) 
  const [messages, setMessages] = useState<Message[]>([]) 
  const [msgInput, setMsgInput] = useState("")
  
  const messagesEndRef = useRef<HTMLDivElement>(null)

  // 1. CARGAR USUARIO Y CONTACTOS
  useEffect(() => {
    const initData = async () => {
        const { data: { user } } = await supabase.auth.getUser()
        if (!user) return
        setCurrentUser(user)

        // Buscar mensajes donde soy emisor O receptor para sacar contactos únicos
        const { data: allMsgs } = await supabase
            .from('messages')
            .select(`
                *,
                sender:profiles!sender_id(first_name, last_name, email),
                receiver:profiles!receiver_id(first_name, last_name, email)
            `)
            .or(`sender_id.eq.${user.id},receiver_id.eq.${user.id}`)
            .order('created_at', { ascending: false })

        if (allMsgs) {
            // Procesar contactos únicos
            const uniqueContactsMap = new Map()
            
            allMsgs.forEach((msg: any) => {
                const isMeSender = msg.sender_id === user.id
                const otherId = isMeSender ? msg.receiver_id : msg.sender_id
                const otherProfile = isMeSender ? msg.receiver : msg.sender
                
                if (!uniqueContactsMap.has(otherId)) {
                    uniqueContactsMap.set(otherId, {
                        id: otherId,
                        name: otherProfile ? `${otherProfile.first_name || ''} ${otherProfile.last_name || ''}` : 'Usuario',
                        email: otherProfile?.email || '',
                        lastMsg: msg.content,
                        time: new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                    })
                }
            })
            setContacts(Array.from(uniqueContactsMap.values()))
        }
        setLoading(false)
    }
    initData()
  }, [])

  // 2. CARGAR MENSAJES DEL CHAT ACTIVO (POLLING SIMPLE O SUBSCRIPTION)
  useEffect(() => {
      if (!activeChatId || !currentUser) return

      const fetchMessages = async () => {
          const { data } = await supabase
              .from('messages')
              .select('*')
              .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${activeChatId}),and(sender_id.eq.${activeChatId},receiver_id.eq.${currentUser.id})`)
              .order('created_at', { ascending: true })
          
          if (data) {
              setMessages(data.map((m: any) => ({
                  id: m.id,
                  sender_id: m.sender_id,
                  content: m.content,
                  created_at: new Date(m.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                  is_mine: m.sender_id === currentUser.id
              })))
              scrollToBottom()
          }
      }

      fetchMessages()
      // Suscripción en tiempo real (Opcional, pero recomendada)
      const channel = supabase.channel('chat_room')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' },payload => {
            fetchMessages() // Recargar si hay nuevo mensaje
        })
        .subscribe()

      return () => { supabase.removeChannel(channel) }

  }, [activeChatId, currentUser])

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" })
  }

  // 3. ENVIAR MENSAJE
  const sendMessage = async (e: any) => {
    e.preventDefault();
    if (!msgInput.trim() || !activeChatId || !currentUser) return;

    const textToSend = msgInput
    setMsgInput("") // Limpiar UI rápido

    // Optimistic Update (Mostrarlo antes de confirmar)
    const tempId = Date.now().toString()
    setMessages(prev => [...prev, {
        id: tempId,
        sender_id: currentUser.id,
        content: textToSend,
        created_at: "Now",
        is_mine: true
    }])
    
    // Insertar en BD
    const { error } = await supabase.from('messages').insert({
        sender_id: currentUser.id,
        receiver_id: activeChatId,
        content: textToSend
    })

    if (error) {
        alert("Error enviando mensaje")
        // Aquí deberías revertir el optimistic update si falla
    }
  }

  const activeContact = contacts.find(c => c.id === activeChatId)

  if (loading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-indigo-600"/></div>

  return (
    <div className="h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-900 flex flex-col">
      
      {/* Header */}
      <div className="flex items-center gap-4 mb-6 shrink-0">
        <Link href="/dashboard/student" className="p-2 bg-white rounded-lg hover:bg-slate-100 border border-slate-200 text-slate-600">
          <ArrowLeft className="w-5 h-5" />
        </Link>
        <h1 className="text-2xl font-bold text-slate-900">Mensajes</h1>
      </div>

      {/* Chat Layout */}
      <div className="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex">
        
        {/* Sidebar de Contactos */}
        <div className="w-full md:w-1/3 border-r border-slate-100 bg-slate-50/50 flex flex-col">
          <div className="p-4 border-b border-slate-100">
            <div className="relative">
                <Search className="w-4 h-4 absolute left-3 top-3 text-slate-400" />
                <input type="text" placeholder="Buscar contactos..." className="w-full pl-9 pr-4 py-2 bg-white border border-slate-200 rounded-lg text-sm outline-none focus:border-indigo-500" />
            </div>
          </div>
          <div className="flex-1 overflow-y-auto">
            {contacts.length === 0 ? (
                <div className="p-8 text-center text-slate-500">
                    <MessageSquare className="w-8 h-8 mx-auto mb-2 opacity-50"/>
                    <p className="text-sm font-medium">No tienes conversaciones.</p>
                    <p className="text-xs mt-1">Los chats aparecerán aquí cuando hables con alguien.</p>
                </div>
            ) : (
                contacts.map((c) => (
                    <div key={c.id} onClick={() => setActiveChatId(c.id)} className={`p-4 cursor-pointer hover:bg-white transition-colors border-b border-slate-100 ${activeChatId === c.id ? 'bg-white border-l-4 border-l-indigo-600' : ''}`}>
                      <div className="flex justify-between items-start mb-1">
                          <span className={`font-bold ${activeChatId === c.id ? 'text-indigo-900' : 'text-slate-700'}`}>{c.name}</span>
                          <span className="text-[10px] text-slate-400">{c.time}</span>
                      </div>
                      <p className="text-xs text-slate-500 truncate">{c.lastMsg}</p>
                    </div>
                ))
            )}
          </div>
        </div>

        {/* Área de Chat */}
        <div className="hidden md:flex flex-1 flex-col bg-white">
            {!activeChatId ? (
                <div className="flex-1 flex flex-col items-center justify-center text-slate-400">
                    <MessageSquare className="w-12 h-12 mb-4 opacity-20"/>
                    <p className="text-center font-medium">Selecciona un contacto para chatear.</p>
                </div>
            ) : (
                <>
                    {/* Chat Header */}
                    <div className="p-4 border-b border-slate-100 flex items-center gap-3 bg-white shadow-sm z-10">
                        <div className="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold">
                            {activeContact?.name.charAt(0) || <User size={20}/>}
                        </div>
                        <div>
                            <p className="font-bold text-slate-800">{activeContact?.name}</p>
                            <p className="text-xs text-slate-500">{activeContact?.email}</p>
                        </div>
                    </div>
                    
                    {/* Contenedor de Mensajes */}
                    <div className="flex-1 p-6 overflow-y-auto space-y-4 bg-slate-50/30">
                        {messages.length === 0 ? (
                            <div className="text-center text-slate-400 pt-10">
                                <p>¡Es el comienzo de algo grande!</p>
                                <p className="text-sm">Envía un mensaje para empezar.</p>
                            </div>
                        ) : (
                             messages.map((msg) => (
                                <div key={msg.id} className={`flex ${msg.is_mine ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`px-4 py-2 rounded-2xl text-sm max-w-xs shadow-sm ${
                                        msg.is_mine ? 'bg-indigo-600 text-white rounded-tr-sm' : 'bg-white border border-slate-200 text-slate-700 rounded-tl-sm'
                                    }`}>
                                        <p>{msg.content}</p>
                                        <p className={`text-[10px] mt-1 text-right ${msg.is_mine ? 'text-indigo-200' : 'text-slate-400'}`}>{msg.created_at}</p>
                                    </div>
                                </div>
                             ))
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    {/* Input */}
                    <form onSubmit={sendMessage} className="p-4 border-t border-slate-100 bg-white">
                        <div className="flex gap-2">
                            <input 
                                type="text" 
                                placeholder="Escribe un mensaje..." 
                                value={msgInput}
                                onChange={(e) => setMsgInput(e.target.value)}
                                className="flex-1 border border-slate-200 rounded-lg px-4 py-3 text-sm outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all" 
                            />
                            <button type="submit" disabled={!msgInput.trim()} className="p-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                <Send className="w-5 h-5"/>
                            </button>
                        </div>
                    </form>
                </>
            )}
        </div>

      </div>
    </div>
  )
}

--- FIN ARCHIVO: app\dashboard\student\messages\page.tsx ---

--- INICIO ARCHIVO: app\dashboard\student\page.tsx ---
'use client'

import { useEffect, useState } from 'react'
import { useRouter } from 'next/navigation'
import { createClient } from '@/utils/supabase/client'
import { BookOpen, Video, CreditCard, LogOut, User, Loader2, Play, Search, MessageSquare, Bell, X, Zap, CheckCircle } from 'lucide-react'
import Link from 'next/link'

export default function StudentDashboard() {
  const router = useRouter()
  const [supabase] = useState(() => createClient())
  
  const [loading, setLoading] = useState(true)
  const [calling, setCalling] = useState(false)
  
  const [studentName, setStudentName] = useState("Student")
  const [userEmail, setUserEmail] = useState("")
  
  // ESTADOS REALES (Datos de BD)
  const [balance, setBalance] = useState(0.00)
  const [nextClass, setNextClass] = useState<any>(null)
  const [classesCount, setClassesCount] = useState(0)
  
  // UI States
  const [isNotificationsOpen, setIsNotificationsOpen] = useState(false)
  const [notifications, setNotifications] = useState<any[]>([]) 

  // --- 1. CARGA INICIAL DE DATOS ---
  useEffect(() => {
    const initDashboard = async () => {
      try {
        // Verificar Usuario
        const { data: { user }, error } = await supabase.auth.getUser()
        
        if (error || !user) {
          window.location.href = '/login'
          return
        }
        setUserEmail(user.email || "")

        // Obtener/Crear Perfil
        let { data: profile } = await supabase
            .from('profiles')
            .select('first_name, last_name')
            .eq('id', user.id)
            .single()
        
        if (!profile) {
            const { data: newProfile } = await supabase.from('profiles').insert({
                id: user.id,
                email: user.email,
                role: 'student',
                first_name: 'Nuevo',
                last_name: 'Usuario',
                created_at: new Date()
            }).select().single()
            profile = newProfile
        }

        if (profile) setStudentName(`${profile.first_name}`)

        // Obtener/Crear Billetera
        let { data: wallet } = await supabase
            .from('wallets')
            .select('balance')
            .eq('user_id', user.id)
            .single()
        
        if (!wallet) {
            const { data: newWallet } = await supabase.from('wallets').insert({
                user_id: user.id,
                balance: 0.00
            }).select().single()
            wallet = newWallet
        }
        
        if (wallet) setBalance(wallet.balance)

        // Obtener Clases
        const today = new Date().toISOString().split('T')[0]
        
        const { data: upcoming } = await supabase
            .from('bookings')
            .select('date, time, topic, meeting_link')
            .eq('student_id', user.id)
            .gte('date', today)
            .order('date', { ascending: true })
            .order('time', { ascending: true })
            .limit(1)
            .single()

        if (upcoming) setNextClass(upcoming)

        const { count } = await supabase
            .from('bookings')
            .select('*', { count: 'exact', head: true })
            .eq('student_id', user.id)
            .lt('date', today)

        setClassesCount(count || 0)

      } catch (err) {
        console.error(err)
      } finally {
        setLoading(false)
      }
    }

    initDashboard()
  }, [router, supabase])

  // --- 2. NUEVO: ESCUCHA EN TIEMPO REAL (NOTIFICACIONES) ---
  useEffect(() => {
    const setupRealtime = async () => {
        const { data: { user } } = await supabase.auth.getUser()
        if (!user) return

        const channel = supabase.channel('student-dashboard-realtime')

        channel
            // A) Escuchar cuando un profesor acepta la llamada instantánea
            .on(
                'postgres_changes',
                {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'class_requests',
                    filter: `student_id=eq.${user.id}`
                },
                (payload) => {
                    // Si el estado cambia a 'accepted', notificamos
                    if (payload.new.status === 'accepted') {
                        const roomLink = payload.new.room_id
                        
                        // Agregamos notificación visual
                        setNotifications(prev => [{
                            id: Date.now(),
                            title: '¡Profesor Conectado!',
                            message: `Tu solicitud ha sido aceptada.`,
                            actionLabel: 'ENTRAR AHORA',
                            actionLink: roomLink,
                            type: 'urgent'
                        }, ...prev])
                        
                        // Abrimos el panel automáticamente para que lo vea
                        setIsNotificationsOpen(true)
                        
                        // Quitamos el estado de "Llamando" del botón
                        setCalling(false)
                        
                        // Opcional: Sonido de notificación
                        const audio = new Audio('/notification.mp3') // Asegúrate de tener un mp3 o quita esta línea
                        audio.play().catch(() => {}) 
                    }
                }
            )
            // B) Escuchar nuevas reservas confirmadas
            .on(
                'postgres_changes',
                {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'bookings',
                    filter: `student_id=eq.${user.id}`
                },
                (payload) => {
                    if (payload.new.status === 'confirmed') {
                        setNotifications(prev => [{
                            id: Date.now(),
                            title: 'Nueva Clase Confirmada',
                            message: `Clase agendada para el ${payload.new.date} a las ${payload.new.time}`,
                            type: 'info'
                        }, ...prev])
                        setIsNotificationsOpen(true)
                    }
                }
            )
            .subscribe()

        return () => {
            supabase.removeChannel(channel)
        }
    }
    setupRealtime()
  }, [supabase])


  const handleLogout = async () => {
    await supabase.auth.signOut()
    document.cookie.split(";").forEach((c) => {
      document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
    });
    localStorage.clear()
    window.location.href = '/'
  }

  const goToClassroom = () => {
    if (nextClass && nextClass.meeting_link) {
        router.push(`/room/${nextClass.meeting_link}`)
    } else {
        router.push('/room/demo-class')
    }
  }

  const handleInstantCall = async () => {
    setCalling(true)
    try {
        const { data: { user } } = await supabase.auth.getUser()
        if (!user) return

        const { data: teachers } = await supabase.from('profiles').select('id, first_name').eq('role', 'teacher').limit(1)

        if (!teachers || teachers.length === 0) {
            alert("No hay profesores disponibles ahora mismo.")
            setCalling(false)
            return
        }
        
        const targetTeacher = teachers[0]

        // Usamos un ID de sala único
        const uniqueRoomId = `instant-${user.id}-${Date.now().toString().slice(-4)}`

        const { error } = await supabase.from('class_requests').insert({
            student_id: user.id,
            teacher_id: targetTeacher.id,
            student_name: studentName, 
            topic: "Instant Help",
            level: "General",
            room_id: uniqueRoomId,
            status: 'waiting' // Importante para el trigger
        })

        if (error) throw error
        
        // Feedback visual inmediato (No bloqueante)
        setNotifications(prev => [{
            id: Date.now(),
            title: 'Solicitud Enviada',
            message: `Esperando a ${targetTeacher.first_name}... Te avisaremos cuando acepte.`,
            type: 'info'
        }, ...prev])
        setIsNotificationsOpen(true)

    } catch (error: any) {
        alert("Error: " + error.message)
        setCalling(false)
    }
  }

  if (loading) return <div className="min-h-screen flex items-center justify-center bg-slate-50"><Loader2 className="w-8 h-8 animate-spin text-indigo-600" /></div>

  return (
    <div className="min-h-screen bg-slate-50 flex font-sans text-slate-900">
      
      {/* --- SIDEBAR --- */}
      <aside className="w-64 bg-white border-r border-slate-200 hidden md:flex flex-col fixed h-full z-10">
        <div className="p-6 border-b border-slate-100">
          <span className="text-2xl font-bold text-indigo-600">Tutorio</span>
        </div>
        
        <nav className="flex-1 p-4 space-y-2">
          <Link href="/dashboard/student" className="w-full flex items-center gap-3 px-4 py-3 bg-indigo-50 text-indigo-700 rounded-xl font-medium text-left">
            <BookOpen className="w-5 h-5" /> My Classes
          </Link>
          <Link href="/dashboard/student/find-tutors" className="w-full flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-indigo-600 rounded-xl font-medium text-left transition-colors">
            <Search className="w-5 h-5" /> Find Tutors
          </Link>
          <Link href="/dashboard/student/messages" className="w-full flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-indigo-600 rounded-xl font-medium text-left transition-colors">
            <MessageSquare className="w-5 h-5" /> Messages
          </Link>
          <Link href="/dashboard/student/wallet" className="w-full flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-indigo-600 rounded-xl font-medium text-left transition-colors">
            <CreditCard className="w-5 h-5" /> Wallet
          </Link>
          <Link href="/dashboard/student/profile" className="w-full flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-indigo-600 rounded-xl font-medium text-left transition-colors">
            <User className="w-5 h-5" /> My Profile
          </Link>
        </nav>

        <div className="p-4 border-t border-slate-100">
          <button onClick={handleLogout} className="flex items-center gap-3 px-4 py-3 w-full text-left text-red-600 hover:bg-red-50 rounded-xl font-medium transition-colors">
            <LogOut className="w-5 h-5" /> Log Out
          </button>
        </div>
      </aside>

      {/* --- MAIN CONTENT --- */}
      <main className="flex-1 md:ml-64 p-8">
        
        {/* HEADER */}
        <header className="flex justify-between items-center mb-8">
          <div>
            <h1 className="text-2xl font-bold text-slate-900">Hello, {studentName}</h1>
            <p className="text-slate-500">Welcome to your student dashboard.</p>
          </div>
          <div className="flex items-center gap-4">
            <button onClick={() => setIsNotificationsOpen(true)} className="p-3 bg-white rounded-full text-slate-500 hover:text-indigo-600 shadow-md border border-slate-200 relative transition-transform hover:scale-105">
                <Bell className="w-5 h-5"/>
                {notifications.length > 0 && <div className="absolute top-1 right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white animate-pulse"></div>} 
            </button>
            <div className="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-700 font-bold border shadow-sm">
              {studentName.charAt(0).toUpperCase()}
            </div>
          </div>
        </header>

        {/* --- STATS CARDS --- */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4 transition-transform hover:-translate-y-1">
             <div className="p-3 bg-blue-50 text-blue-600 rounded-xl"><Video className="w-6 h-6" /></div>
             <div><p className="text-sm text-slate-500 font-medium">Classes Taken</p><p className="text-2xl font-bold text-slate-900">{classesCount}</p></div>
          </div>
          <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4 transition-transform hover:-translate-y-1">
             <div className="p-3 bg-green-50 text-green-600 rounded-xl"><CreditCard className="w-6 h-6" /></div>
             <div><p className="text-sm text-slate-500 font-medium">Balance</p><p className="text-2xl font-bold text-slate-900">${balance.toFixed(2)}</p></div>
          </div>
          <div className="bg-gradient-to-br from-indigo-600 to-purple-700 p-6 rounded-2xl shadow-lg text-white relative overflow-hidden flex flex-col justify-center">
             <div className="relative z-10 flex items-center justify-between">
               <div><p className="font-bold text-lg leading-tight">Need Help Now?</p><p className="text-xs text-indigo-200 mt-1">Talk to a teacher instantly.</p></div>
               <button onClick={handleInstantCall} disabled={calling} className="bg-white text-indigo-700 p-3 rounded-full hover:bg-indigo-50 shadow-md transition-transform hover:scale-110 disabled:opacity-50 disabled:scale-100">
                  {calling ? <Loader2 className="w-5 h-5 animate-spin"/> : <Zap className="w-5 h-5 fill-current"/>}
               </button>
             </div>
             <div className="absolute -right-4 -bottom-8 opacity-20 rotate-12"><Video className="w-24 h-24" /></div>
          </div>
        </div>

        {/* --- MAIN SECTION: CLASSROOM --- */}
        <section className="mb-10">
          <h2 className="text-lg font-bold text-slate-900 mb-4">Your Virtual Classroom</h2>
          <div className="bg-white rounded-2xl p-8 border border-slate-200 border-dashed text-center flex flex-col items-center justify-center gap-4">
            <div className="p-4 bg-slate-50 rounded-full"><Video className="w-8 h-8 text-slate-400" /></div>
            <div>
                {nextClass ? (
                    <>
                        <h3 className="text-lg font-bold text-slate-900">Your class is ready!</h3>
                        <p className="text-slate-500 max-w-sm mx-auto">Topic: {nextClass.topic}. Click below to join the teacher.</p>
                    </>
                ) : (
                    <>
                        <h3 className="text-lg font-medium text-slate-900">No classes scheduled right now</h3>
                        <p className="text-slate-500 max-w-sm mx-auto">Book a class or use the "Instant Help" button above.</p>
                    </>
                )}
            </div>
            <button onClick={goToClassroom} className={`mt-4 px-8 py-4 font-bold rounded-xl shadow-lg flex items-center gap-2 transition-transform hover:scale-105 ${nextClass ? "bg-green-600 hover:bg-green-700 text-white shadow-green-200 animate-pulse" : "bg-indigo-600 hover:bg-indigo-700 text-white shadow-indigo-200"}`}>
                <Play className="w-5 h-5 fill-current" /> {nextClass ? "JOIN CLASS NOW" : "TEST CLASSROOM NOW"}
            </button>
          </div>
        </section>

      </main>

      {/* --- NOTIFICATIONS MODAL (ACTUALIZADO) --- */}
      {isNotificationsOpen && (
          <div className="fixed inset-0 z-50 flex justify-end">
              <div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick={() => setIsNotificationsOpen(false)}></div>
              <div className="relative w-full max-w-sm h-full bg-white shadow-2xl flex flex-col animate-in slide-in-from-right duration-300">
                  <div className="p-5 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                      <h2 className="text-xl font-bold text-slate-900 flex items-center gap-2"><Bell className="w-5 h-5 text-indigo-600"/> Notifications</h2>
                      <button onClick={() => setIsNotificationsOpen(false)} className="p-1 text-slate-500 hover:text-red-500 transition-colors"><X className="w-6 h-6"/></button>
                  </div>
                  
                  <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50/50">
                      {notifications.length === 0 ? (
                        <div className="flex flex-col items-center justify-center h-48 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl">
                            <Bell className="w-8 h-8 mb-2 opacity-50"/>
                            <p className="text-sm font-medium">No new alerts.</p>
                        </div>
                      ) : (
                          notifications.map((notif) => (
                              <div key={notif.id} className={`p-4 rounded-xl border shadow-sm transition-all hover:shadow-md ${notif.type === 'urgent' ? 'bg-green-50 border-green-200' : 'bg-white border-slate-200'}`}>
                                  <div className="flex justify-between items-start mb-1">
                                      <p className={`text-sm font-bold ${notif.type === 'urgent' ? 'text-green-800' : 'text-slate-800'}`}>{notif.title}</p>
                                      {notif.type === 'urgent' && <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>}
                                  </div>
                                  <p className="text-xs text-slate-600 mb-3 leading-relaxed">{notif.message}</p>
                                  
                                  {/* BOTÓN DE ACCIÓN DINÁMICO */}
                                  {notif.actionLabel && notif.actionLink && (
                                      <button 
                                        onClick={() => router.push(`/room/${notif.actionLink}`)}
                                        className="w-full py-2 bg-green-600 hover:bg-green-700 text-white text-xs font-bold rounded-lg flex items-center justify-center gap-2 transition-colors shadow-sm"
                                      >
                                          <Video className="w-3 h-3"/> {notif.actionLabel}
                                      </button>
                                  )}
                              </div>
                          ))
                      )}
                  </div>
                  
                  {notifications.length > 0 && (
                      <div className="p-4 border-t border-slate-200 bg-white">
                          <button onClick={() => setNotifications([])} className="w-full py-2 text-xs font-bold text-slate-500 hover:text-slate-800 transition-colors">
                              Clear all notifications
                          </button>
                      </div>
                  )}
              </div>
          </div>
      )}
    </div>
  )
}
--- FIN ARCHIVO: app\dashboard\student\page.tsx ---

--- INICIO ARCHIVO: app\dashboard\student\profile\page.tsx ---
'use client'

import { useState, useEffect, useRef } from 'react'
import { User, Mail, Camera, Save, Loader2, MapPin, Calendar, BookOpen, Languages } from 'lucide-react'
import { createClient } from '@supabase/supabase-js' // <--- CAMBIO: Usamos la librería core

// IMPORTANTE: Asegúrate de tener estas variables en tu archivo .env.local
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!

// Estado inicial VACÍO
const EMPTY_FORM = {
    firstName: '',
    lastName: '',
    email: '',
    avatarUrl: '',
    age: '',
    educationLevel: '',
    nativeLanguage: '',
    bio: '',
    location: '',
}

export default function ProfilePage() {
    // Inicializamos el cliente manualmente para evitar errores de importación
    const [supabase] = useState(() => createClient(supabaseUrl, supabaseAnonKey))
    
    const [loading, setLoading] = useState(false)
    const [fetching, setFetching] = useState(true)
    const [uploading, setUploading] = useState(false)
    
    const [formData, setFormData] = useState(EMPTY_FORM)
    const [avatarPreview, setAvatarPreview] = useState<string | null>(null)
    const fileInputRef = useRef<HTMLInputElement>(null)

    // --- 1. CARGAR DATOS AL INICIAR ---
    useEffect(() => {
        const getProfile = async () => {
            try {
                setFetching(true)
                
                // 1. Obtener usuario autenticado
                const { data: { user } } = await supabase.auth.getUser()
                
                if (user) {
                    setFormData(prev => ({ ...prev, email: user.email || '' }))

                    // 2. Buscar perfil existente
                    const { data, error } = await supabase
                        .from('profiles')
                        .select('*')
                        .eq('id', user.id)
                        .single()

                    if (data && !error) {
                        setFormData({
                            firstName: data.first_name || '',
                            lastName: data.last_name || '',
                            email: user.email || '',
                            avatarUrl: data.avatar_url || '',
                            age: data.age || '',
                            educationLevel: data.education_level || '',
                            nativeLanguage: data.native_language || '',
                            bio: data.bio || '',
                            location: data.location || '',
                        })
                        if (data.avatar_url) setAvatarPreview(data.avatar_url)
                    }
                }
            } catch (error) {
                console.error('Error loading user data:', error)
            } finally {
                setFetching(false)
            }
        }

        if (supabaseUrl && supabaseAnonKey) {
            getProfile()
        } else {
            alert("Faltan las variables de entorno de Supabase (NEXT_PUBLIC_SUPABASE_URL). Revisa tu archivo .env.local")
            setFetching(false)
        }
    }, [supabase])

    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
        const { name, value } = e.target
        setFormData(prev => ({ ...prev, [name]: value }))
    }

    // --- LOGICA DE AVATAR ---
    const handleAvatarClick = () => {
        fileInputRef.current?.click()
    }

    const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0]
        if (!file) return

        // Preview inmediato
        const objectUrl = URL.createObjectURL(file)
        setAvatarPreview(objectUrl)
        setUploading(true)

        try {
            const { data: { user } } = await supabase.auth.getUser()
            if (!user) throw new Error('No user')

            const fileExt = file.name.split('.').pop()
            const fileName = `${user.id}-${Math.random()}.${fileExt}`

            // Subida REAL
            const { error: uploadError } = await supabase.storage
                .from('avatars')
                .upload(fileName, file)

            if (uploadError) throw uploadError

            // Obtener URL pública
            const { data: { publicUrl } } = supabase.storage
                .from('avatars')
                .getPublicUrl(fileName)

            setFormData(prev => ({ ...prev, avatarUrl: publicUrl }))
            
        } catch (error) {
            console.error('Error uploading avatar:', error)
            alert('Error uploading image. Make sure you have created the "avatars" bucket in Supabase.')
        } finally {
            setUploading(false)
        }
    }

    // --- GUARDAR PERFIL ---
    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault()
        setLoading(true)

        try {
            const { data: { user } } = await supabase.auth.getUser()
            if (!user) throw new Error('No user found. Please login again.')

            const updates = {
                id: user.id,
                first_name: formData.firstName,
                last_name: formData.lastName,
                age: formData.age,
                education_level: formData.educationLevel,
                native_language: formData.nativeLanguage,
                location: formData.location,
                bio: formData.bio,
                avatar_url: formData.avatarUrl,
                updated_at: new Date().toISOString(),
            }

            const { error } = await supabase.from('profiles').upsert(updates)
            if (error) throw error

            alert("Profile updated successfully!")
        } catch (error) {
            console.error('Error updating profile:', error)
            alert("Error saving profile. Check console for details.")
        } finally {
            setLoading(false)
        }
    }

    if (fetching) {
        return <div className="min-h-screen flex items-center justify-center bg-slate-50"><Loader2 className="w-8 h-8 animate-spin text-indigo-600"/></div>
    }

    return (
        <div className="min-h-screen bg-slate-50 p-6 md:p-12 font-sans">
            <div className="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
                
                {/* Header with Gradient */}
                <div className="h-32 bg-gradient-to-r from-indigo-600 to-purple-600 relative">
                    <div className="absolute -bottom-16 left-8">
                        <div className="relative group cursor-pointer" onClick={handleAvatarClick} title="Change Profile Picture">
                            {/* Avatar Circle */}
                            <div className="w-32 h-32 rounded-full border-4 border-white bg-slate-200 overflow-hidden relative shadow-md">
                                {avatarPreview ? (
                                    <img src={avatarPreview} alt="Avatar" className="w-full h-full object-cover" />
                                ) : (
                                    <div className="w-full h-full flex items-center justify-center bg-slate-100 text-slate-400">
                                        <User className="w-16 h-16" />
                                    </div>
                                )}
                                
                                {uploading && (
                                    <div className="absolute inset-0 bg-black/50 flex items-center justify-center z-20">
                                        <Loader2 className="w-8 h-8 text-white animate-spin" />
                                    </div>
                                )}
                            </div>

                            {/* Camera Icon Overlay */}
                            <div className="absolute bottom-0 right-0 bg-indigo-600 text-white p-2 rounded-full shadow-lg border-2 border-white group-hover:scale-110 transition-transform">
                                <Camera className="w-5 h-5" />
                            </div>
                            
                            <input 
                                type="file" 
                                ref={fileInputRef} 
                                className="hidden" 
                                accept="image/*"
                                onChange={handleFileChange}
                            />
                        </div>
                    </div>
                </div>

                {/* Form Content */}
                <div className="pt-20 px-8 pb-8">
                    <div className="flex justify-between items-center mb-6">
                        <div>
                            <h1 className="text-2xl font-bold text-slate-900">
                                {formData.firstName || 'New Student'} {formData.lastName}
                            </h1>
                            <p className="text-slate-500">Student Profile</p>
                        </div>
                    </div>

                    <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        {/* SECTION 1: PERSONAL INFO */}
                        <div className="col-span-1 md:col-span-2">
                            <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 border-b pb-2">Personal Information</h3>
                        </div>

                        <div className="space-y-2">
                            <label className="text-sm font-medium text-slate-700">First Name</label>
                            <div className="relative">
                                <User className="absolute left-3 top-3 w-5 h-5 text-slate-400" />
                                <input type="text" name="firstName" placeholder="Enter your first name" value={formData.firstName} onChange={handleChange} className="w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all" />
                            </div>
                        </div>

                        <div className="space-y-2">
                            <label className="text-sm font-medium text-slate-700">Last Name</label>
                            <div className="relative">
                                <User className="absolute left-3 top-3 w-5 h-5 text-slate-400" />
                                <input type="text" name="lastName" placeholder="Enter your last name" value={formData.lastName} onChange={handleChange} className="w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all" />
                            </div>
                        </div>

                        <div className="space-y-2">
                            <label className="text-sm font-medium text-slate-700">Email Address</label>
                            <div className="relative">
                                <Mail className="absolute left-3 top-3 w-5 h-5 text-slate-400" />
                                <input type="email" name="email" value={formData.email} disabled className="w-full pl-10 pr-4 py-2.5 border border-slate-200 bg-slate-50 rounded-lg text-slate-500 cursor-not-allowed" />
                            </div>
                        </div>

                        <div className="space-y-2">
                            <label className="text-sm font-medium text-slate-700">Age</label>
                            <div className="relative">
                                <Calendar className="absolute left-3 top-3 w-5 h-5 text-slate-400" />
                                <input type="number" name="age" placeholder="e.g., 24" value={formData.age} onChange={handleChange} className="w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" />
                            </div>
                        </div>

                         <div className="col-span-1 md:col-span-2 mt-4">
                            <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 border-b pb-2">Academic Profile</h3>
                        </div>

                        <div className="space-y-2">
                            <label className="text-sm font-medium text-slate-700">Education Level</label>
                            <div className="relative">
                                <BookOpen className="absolute left-3 top-3 w-5 h-5 text-slate-400" />
                                <select name="educationLevel" value={formData.educationLevel} onChange={handleChange} className="w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                                    <option value="">Select Level...</option>
                                    <option value="HighSchool">High School</option>
                                    <option value="Bachelor">Bachelor's Degree</option>
                                    <option value="Master">Master's Degree</option>
                                    <option value="PhD">PhD / Doctorate</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>

                        <div className="space-y-2">
                            <label className="text-sm font-medium text-slate-700">Native Language</label>
                            <div className="relative">
                                <Languages className="absolute left-3 top-3 w-5 h-5 text-slate-400" />
                                <select name="nativeLanguage" value={formData.nativeLanguage} onChange={handleChange} className="w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                                    <option value="">Select Language...</option>
                                    <option value="English">English</option>
                                    <option value="Spanish">Spanish</option>
                                    <option value="Portuguese">Portuguese</option>
                                    <option value="French">French</option>
                                    <option value="German">German</option>
                                    <option value="Mandarin">Mandarin</option>
                                </select>
                            </div>
                        </div>

                        <div className="space-y-2">
                            <label className="text-sm font-medium text-slate-700">Location</label>
                            <div className="relative">
                                <MapPin className="absolute left-3 top-3 w-5 h-5 text-slate-400" />
                                <input type="text" name="location" value={formData.location} onChange={handleChange} placeholder="City, Country" className="w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" />
                            </div>
                        </div>

                        <div className="col-span-1 md:col-span-2 space-y-2">
                            <label className="text-sm font-medium text-slate-700">About Me & Learning Goals</label>
                            <textarea name="bio" rows={4} value={formData.bio} onChange={handleChange} placeholder="Tell us a bit about yourself and why you want to learn..." className="w-full p-4 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none resize-none" />
                        </div>

                        <div className="col-span-1 md:col-span-2 flex justify-end mt-4">
                            <button type="submit" disabled={loading} className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-xl transition-all shadow-lg shadow-indigo-200 disabled:opacity-70">
                                {loading ? <Loader2 className="w-5 h-5 animate-spin" /> : <Save className="w-5 h-5" />}
                                {loading ? 'Saving...' : 'Save Changes'}
                            </button>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    )
}
--- FIN ARCHIVO: app\dashboard\student\profile\page.tsx ---

--- INICIO ARCHIVO: app\dashboard\student\resources\page.tsx ---
'use client'

import { useState, useEffect } from 'react'
import { createClient } from '@supabase/supabase-js'
import { FileText, Music, Video, Trash2, UploadCloud, Plus, Loader2, ChevronLeft, Clock, Tag, Download } from 'lucide-react'
import Link from 'next/link'

// Credenciales
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!

export default function TeacherResourcesPage() {
  const [supabase] = useState(() => createClient(supabaseUrl, supabaseAnonKey))
  
  const [loading, setLoading] = useState(true)
  const [uploading, setUploading] = useState(false)
  const [resources, setResources] = useState<any[]>([])
  const [isFormOpen, setIsFormOpen] = useState(false)

  // Formulario
  const [form, setForm] = useState({
      title: '',
      content_text: '',
      duration: '',
      resource_type: 'reading',
      file_format: 'PDF',
  })
  const [file, setFile] = useState<File | null>(null)

  // 1. Cargar Recursos
  const loadResources = async () => {
    try {
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) return

      const { data, error } = await supabase
        .from('learning_resources')
        .select('*')
        .eq('teacher_id', user.id)
        .order('id', { ascending: false })

      if (data) setResources(data)
    } catch (error) {
      console.error(error)
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    loadResources()
  }, [])

  // 2. Subir Archivo
  const handleUpload = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!file) return alert('Por favor selecciona un archivo.')

    setUploading(true)
    try {
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) throw new Error('No usuario')

      // A. Subir al Bucket 'materials'
      const fileExt = file.name.split('.').pop()
      const fileName = `${user.id}/${Date.now()}.${fileExt}`
      
      const { error: uploadError } = await supabase.storage
        .from('materials') 
        .upload(fileName, file)

      if (uploadError) throw uploadError

      const { data: { publicUrl } } = supabase.storage
        .from('materials')
        .getPublicUrl(fileName)

      // B. Guardar en BD (Usando file_url)
      const { error: dbError } = await supabase.from('learning_resources').insert({
          teacher_id: user.id,
          title: form.title,
          content_text: form.content_text,
          duration: form.duration,
          resource_type: form.resource_type,
          file_format: fileExt?.toUpperCase() || 'FILE',
          file_url: publicUrl // <--- CORREGIDO: Usamos file_url
      })

      if (dbError) throw dbError

      alert('Recurso creado exitosamente')
      setIsFormOpen(false)
      setForm({ title: '', content_text: '', duration: '', resource_type: 'reading', file_format: '' })
      setFile(null)
      loadResources()

    } catch (error: any) {
      console.error(error)
      alert('Error: ' + error.message)
    } finally {
      setUploading(false)
    }
  }

  // 3. Eliminar
  const handleDelete = async (id: number) => {
      if(!confirm('¿Estás seguro de eliminar este recurso?')) return;
      const { error } = await supabase.from('learning_resources').delete().eq('id', id)
      if (!error) loadResources()
  }

  if (loading) return <div className="min-h-screen flex items-center justify-center bg-slate-50"><Loader2 className="w-8 h-8 animate-spin text-indigo-600"/></div>

  return (
    <div className="min-h-screen bg-slate-50 p-6 md:p-12 font-sans text-slate-900">
        <div className="max-w-6xl mx-auto">
            
            {/* Header */}
            <div className="flex justify-between items-center mb-8">
                <div className="flex items-center gap-4">
                    <Link href="/dashboard/teacher" className="p-2 hover:bg-slate-200 rounded-full transition-colors">
                        <ChevronLeft className="w-6 h-6 text-slate-600"/>
                    </Link>
                    <div>
                        <h1 className="text-3xl font-bold text-slate-900">Biblioteca de Recursos</h1>
                        <p className="text-slate-500">Administra el material de aprendizaje.</p>
                    </div>
                </div>
                <button 
                    onClick={() => setIsFormOpen(!isFormOpen)}
                    className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg flex items-center gap-2"
                >
                    {isFormOpen ? 'Cancelar' : <><Plus className="w-5 h-5"/> Nuevo Recurso</>}
                </button>
            </div>

            {/* Formulario */}
            {isFormOpen && (
                <div className="bg-white p-6 rounded-2xl shadow-lg border border-indigo-100 mb-8 animate-in fade-in slide-in-from-top-4">
                    <h2 className="font-bold text-lg mb-4 text-slate-800">Detalles del Material</h2>
                    <form onSubmit={handleUpload} className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <div className="space-y-4">
                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase">Título</label>
                                <input required type="text" value={form.title} onChange={e => setForm({...form, title: e.target.value})} className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"/>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase">Tipo</label>
                                    <select value={form.resource_type} onChange={e => setForm({...form, resource_type: e.target.value})} className="w-full p-3 border rounded-lg bg-white">
                                        <option value="reading">Lectura (Reading)</option>
                                        <option value="listening">Audio (Listening)</option>
                                        <option value="grammar">Gramática</option>
                                        <option value="vocabulary">Vocabulario</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase">Duración / Pág.</label>
                                    <input placeholder="Ej: 10 min" type="text" value={form.duration} onChange={e => setForm({...form, duration: e.target.value})} className="w-full p-3 border rounded-lg"/>
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase">Descripción / Contenido</label>
                                <textarea rows={3} value={form.content_text} onChange={e => setForm({...form, content_text: e.target.value})} className="w-full p-3 border rounded-lg resize-none"/>
                            </div>
                        </div>

                        <div className="flex flex-col">
                            <label className="text-xs font-bold text-slate-500 uppercase mb-2">Archivo (PDF, MP3, IMG)</label>
                            <div className="flex-1 border-2 border-dashed border-slate-300 rounded-xl flex flex-col items-center justify-center p-6 hover:bg-slate-50 relative cursor-pointer">
                                <input type="file" required onChange={e => setFile(e.target.files?.[0] || null)} className="absolute inset-0 opacity-0 cursor-pointer"/>
                                <UploadCloud className="w-10 h-10 text-indigo-400 mb-2"/>
                                <p className="text-sm font-medium text-slate-600">{file ? file.name : "Click para subir archivo"}</p>
                            </div>
                            <button type="submit" disabled={uploading} className="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl flex justify-center items-center gap-2">
                                {uploading ? <Loader2 className="w-5 h-5 animate-spin"/> : "Guardar en Biblioteca"}
                            </button>
                        </div>
                    </form>
                </div>
            )}

            {/* Lista */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {resources.length === 0 ? (
                    <div className="col-span-full py-12 text-center text-slate-400 bg-white rounded-2xl border border-dashed border-slate-200">
                        <p>No hay recursos. Sube el primero.</p>
                    </div>
                ) : (
                    resources.map((res) => (
                        <div key={res.id} className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm hover:border-indigo-300 transition-all relative group">
                            <div className="flex justify-between items-start mb-3">
                                <span className={`px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider ${
                                    res.resource_type === 'listening' ? 'bg-purple-100 text-purple-700' : 
                                    res.resource_type === 'grammar' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'
                                }`}>
                                    {res.resource_type}
                                </span>
                                <div className="flex items-center gap-1 text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded-full">
                                    <Clock className="w-3 h-3"/> {res.duration || 'N/A'}
                                </div>
                            </div>

                            <h3 className="font-bold text-slate-800 text-lg mb-1 line-clamp-1">{res.title}</h3>
                            <p className="text-sm text-slate-500 mb-4 line-clamp-2">{res.content_text}</p>

                            <div className="flex items-center justify-between border-t border-slate-100 pt-3">
                                <div className="flex items-center gap-2">
                                    {res.resource_type === 'listening' ? <Music className="w-4 h-4 text-slate-400"/> : <FileText className="w-4 h-4 text-slate-400"/>}
                                    <span className="text-xs font-bold text-slate-400">{res.file_format || 'FILE'}</span>
                                </div>
                                <div className="flex gap-2">
                                    {/* CORREGIDO: Usamos file_url */}
                                    <a href={res.file_url} target="_blank" rel="noopener noreferrer" className="text-indigo-600 text-xs font-bold hover:underline flex items-center gap-1">
                                        <Download className="w-3 h-3"/> Descargar
                                    </a>
                                    <button onClick={() => handleDelete(res.id)} className="text-slate-300 hover:text-red-500">
                                        <Trash2 className="w-4 h-4"/>
                                    </button>
                                </div>
                            </div>
                        </div>
                    ))
                )}
            </div>

        </div>
    </div>
  )
}
--- FIN ARCHIVO: app\dashboard\student\resources\page.tsx ---

--- INICIO ARCHIVO: app\dashboard\student\schedule\page.tsx ---

--- FIN ARCHIVO: app\dashboard\student\schedule\page.tsx ---

--- INICIO ARCHIVO: app\dashboard\student\wallet\page.tsx ---
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { createClient } from '@supabase/supabase-js'
import { ArrowLeft, CreditCard, Copy, Check, Coins, Landmark, AlertTriangle, Info, MapPin, UploadCloud, Loader2, X } from 'lucide-react'
import Link from 'next/link'

// Credentials
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!

export default function StudentWallet() {
  const router = useRouter()
  // Manual Supabase Client
  const [supabase] = useState(() => createClient(supabaseUrl, supabaseAnonKey))
  
  // State
  const [activeTab, setActiveTab] = useState<'paypal' | 'bank' | 'crypto'>('paypal')
  const [selectedCrypto, setSelectedCrypto] = useState<'USDT' | 'USDC'>('USDT')
  const [copied, setCopied] = useState(false)

  // Report State
  const [showReportModal, setShowReportModal] = useState(false)
  const [reporting, setReporting] = useState(false)
  const [reportData, setReportData] = useState({ amount: '', reference: '' })

  // --- CONFIGURATION ---
  const CONFIG = {
    paypalLink: "https://paypal.me/angiejimenez3160", 
    
    // USA BANK DATA
    bank: {
      bankName: "LEAD BANK", 
      bankAddress: "1801 Main St, Kansas City, MO 64108",
      accountHolder: "Dora Angelica Jimenez de Portillo", 
      routingNumber: "10109644", 
      accountNumber: "216926848248", 
      accountType: "Checking" 
    },

    // CRYPTO WALLETS
    crypto: {
      USDT: "0x56bC4FD978aE9562cb3e68E6956D79f191f199Ba", 
      USDC: "0x56bC4FD978aE9562cb3e68E6956D79f191f199Ba" 
    }
  }

  const handleCopy = (text: string) => {
    navigator.clipboard.writeText(text)
    setCopied(true)
    setTimeout(() => setCopied(false), 2000)
  }

  // --- REPORT FUNCTION ---
  const handleReportPayment = async (e: React.FormEvent) => {
      e.preventDefault()
      if(!reportData.amount || !reportData.reference) return alert("Please fill all fields")
      
      setReporting(true)
      try {
          const { data: { user } } = await supabase.auth.getUser()
          if(!user) return router.push('/login')

          const { error } = await supabase.from('deposit_requests').insert({
              student_id: user.id,
              amount: parseFloat(reportData.amount),
              method: activeTab,
              reference_id: reportData.reference,
              status: 'pending'
          })

          if(error) throw error

          alert("✅ Payment reported! The admin will verify and update your balance shortly.")
          setShowReportModal(false)
          setReportData({ amount: '', reference: '' })

      } catch (error: any) {
          alert("Error reporting: " + error.message)
      } finally {
          setReporting(false)
      }
  }

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-900 flex justify-center">
      <div className="w-full max-w-5xl">
        
        {/* Header */}
        <div className="flex items-center gap-4 mb-8">
          <Link href="/dashboard/student" className="p-2 bg-white rounded-lg hover:bg-slate-100 border border-slate-200 text-slate-600">
            <ArrowLeft className="w-5 h-5" />
          </Link>
          <div>
            <h1 className="text-2xl font-bold text-slate-900">Wallet & Payments</h1>
            <p className="text-slate-500">Manage your balance and payment methods.</p>
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-12 gap-6">
          
          {/* SIDEBAR MENU */}
          <div className="md:col-span-4 space-y-2">
            
            {/* 1. PAYPAL */}
            <button 
              onClick={() => setActiveTab('paypal')}
              className={`w-full text-left p-4 rounded-xl flex items-center gap-3 transition-all border ${activeTab === 'paypal' ? 'bg-white border-blue-500 shadow-md ring-1 ring-blue-500' : 'bg-transparent border-transparent hover:bg-white'}`}
            >
              <div className={`p-2 rounded-lg ${activeTab === 'paypal' ? 'bg-blue-100 text-blue-600' : 'bg-slate-200 text-slate-500'}`}>
                <CreditCard className="w-5 h-5" />
              </div>
              <div>
                <p className={`font-bold ${activeTab === 'paypal' ? 'text-blue-900' : 'text-slate-600'}`}>PayPal / Card</p>
                <p className="text-xs text-slate-400">Instant transfer</p>
              </div>
            </button>

            {/* 2. USA BANK */}
            <button 
              onClick={() => setActiveTab('bank')}
              className={`w-full text-left p-4 rounded-xl flex items-center gap-3 transition-all border ${activeTab === 'bank' ? 'bg-white border-green-600 shadow-md ring-1 ring-green-600' : 'bg-transparent border-transparent hover:bg-white'}`}
            >
              <div className={`p-2 rounded-lg ${activeTab === 'bank' ? 'bg-green-100 text-green-600' : 'bg-slate-200 text-slate-500'}`}>
                <Landmark className="w-5 h-5" />
              </div>
              <div>
                <p className={`font-bold ${activeTab === 'bank' ? 'text-green-900' : 'text-slate-600'}`}>USA Bank Transfer</p>
                <p className="text-xs text-slate-400">ACH & Wire Transfer</p>
              </div>
            </button>

            {/* 3. CRYPTO */}
            <button 
              onClick={() => setActiveTab('crypto')}
              className={`w-full text-left p-4 rounded-xl flex items-center gap-3 transition-all border ${activeTab === 'crypto' ? 'bg-white border-orange-500 shadow-md ring-1 ring-orange-500' : 'bg-transparent border-transparent hover:bg-white'}`}
            >
              <div className={`p-2 rounded-lg ${activeTab === 'crypto' ? 'bg-orange-100 text-orange-600' : 'bg-slate-200 text-slate-500'}`}>
                <Coins className="w-5 h-5" />
              </div>
              <div>
                <p className={`font-bold ${activeTab === 'crypto' ? 'text-orange-900' : 'text-slate-600'}`}>Crypto</p>
                <p className="text-xs text-slate-400">USDT & USDC</p>
              </div>
            </button>
          </div>

          {/* CONTENT AREA */}
          <div className="md:col-span-8 space-y-6">
            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 min-h-[400px]">
              
              {/* PAYPAL VIEW */}
              {activeTab === 'paypal' && (
                <div className="flex flex-col items-center text-center space-y-6 animate-fadeIn">
                  <img src="https://upload.wikimedia.org/wikipedia/commons/b/b5/PayPal.svg" alt="PayPal" className="h-10 mb-2" />
                  <h2 className="text-xl font-bold text-slate-800">Secure Payment</h2>
                  <p className="text-slate-500 max-w-md text-sm">
                    Pay securely using your PayPal balance or any Credit/Debit Card.
                  </p>
                  
                  <div className="grid grid-cols-3 gap-3 w-full max-w-sm mt-4">
                      {[20, 50, 100].map((amount) => (
                        <a 
                          key={amount}
                          href={`${CONFIG.paypalLink}/${amount}`} 
                          target="_blank" 
                          rel="noopener noreferrer"
                          className="py-3 rounded-xl border border-slate-200 hover:border-blue-500 hover:bg-blue-50 transition-all font-bold text-slate-700 hover:text-blue-700 flex flex-col items-center"
                        >
                          <span className="text-lg">${amount}</span>
                        </a>
                      ))}
                  </div>
                  <a href={CONFIG.paypalLink} target="_blank" className="text-sm text-blue-600 font-semibold hover:underline mt-4">
                    Custom Amount &rarr;
                  </a>
                </div>
              )}

              {/* BANK VIEW */}
              {activeTab === 'bank' && (
                <div className="flex flex-col animate-fadeIn space-y-6">
                  <div className="flex items-center gap-3 mb-2">
                    <div className="p-3 bg-green-100 rounded-full text-green-700"><Landmark className="w-6 h-6"/></div>
                    <div>
                        <h2 className="text-xl font-bold text-slate-800">USA Bank Account</h2>
                        <p className="text-xs text-slate-500">For Wire or ACH Transfers.</p>
                    </div>
                  </div>

                  <div className="bg-slate-50 p-6 rounded-xl border border-slate-200 space-y-4">
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div className="bg-white p-3 rounded-lg border border-slate-200">
                                <p className="text-xs text-slate-400">Bank Name</p>
                                <p className="font-medium text-slate-800">{CONFIG.bank.bankName}</p>
                            </div>
                            <div className="bg-white p-3 rounded-lg border border-slate-200">
                                <p className="text-xs text-slate-400">Account Type</p>
                                <p className="font-medium text-slate-800">{CONFIG.bank.accountType}</p>
                            </div>
                            <div className="sm:col-span-2 bg-white p-3 rounded-lg border border-slate-200">
                                <p className="text-xs text-slate-400">Bank Address</p>
                                <div className="flex justify-between">
                                    <p className="font-medium text-slate-800 text-sm flex items-center gap-1">
                                        <MapPin className="w-3 h-3 text-slate-400"/> {CONFIG.bank.bankAddress}
                                    </p>
                                    <button onClick={() => handleCopy(CONFIG.bank.bankAddress)}><Copy className="w-3 h-3 text-slate-400"/></button>
                                </div>
                            </div>
                            <div className="sm:col-span-2 bg-white p-3 rounded-lg border border-slate-200">
                                <p className="text-xs text-slate-400">Beneficiary (Account Holder)</p>
                                <div className="flex justify-between">
                                    <p className="font-medium text-slate-800">{CONFIG.bank.accountHolder}</p>
                                    <button onClick={() => handleCopy(CONFIG.bank.accountHolder)}><Copy className="w-3 h-3 text-slate-400"/></button>
                                </div>
                            </div>
                            <div className="bg-white p-3 rounded-lg border border-slate-200">
                                <p className="text-xs text-slate-400">Routing Number (ACH/ABA)</p>
                                <div className="flex justify-between">
                                    <p className="font-mono font-medium text-slate-800">{CONFIG.bank.routingNumber}</p>
                                    <button onClick={() => handleCopy(CONFIG.bank.routingNumber)}><Copy className="w-3 h-3 text-slate-400"/></button>
                                </div>
                            </div>
                            <div className="bg-white p-3 rounded-lg border border-slate-200">
                                <p className="text-xs text-slate-400">Account Number</p>
                                <div className="flex justify-between">
                                    <p className="font-mono font-medium text-slate-800">{CONFIG.bank.accountNumber}</p>
                                    <button onClick={() => handleCopy(CONFIG.bank.accountNumber)}><Copy className="w-3 h-3 text-slate-400"/></button>
                                </div>
                            </div>
                        </div>
                  </div>
                  
                  <div className="flex items-start gap-2 bg-blue-50 p-3 rounded-lg text-xs text-blue-700">
                    <Info className="w-4 h-4 shrink-0 mt-0.5" />
                    <p>Compatible with domestic USA transfers (Chase, Wells Fargo, Cash App, Venmo, etc.) using Routing & Account number.</p>
                  </div>
                </div>
              )}

              {/* CRYPTO VIEW */}
              {activeTab === 'crypto' && (
                <div className="flex flex-col animate-fadeIn items-center">
                    
                    {/* TOGGLE BUTTONS */}
                    <div className="flex justify-center gap-2 mb-6">
                        <button 
                          onClick={() => setSelectedCrypto('USDT')} 
                          className={`px-4 py-2 rounded-lg text-sm font-bold border transition-all ${selectedCrypto === 'USDT' ? 'bg-green-50 border-green-200 text-green-700' : 'bg-white border-slate-200 text-slate-500'}`}
                        >
                          Tether (USDT)
                        </button>
                        <button 
                          onClick={() => setSelectedCrypto('USDC')} 
                          className={`px-4 py-2 rounded-lg text-sm font-bold border transition-all ${selectedCrypto === 'USDC' ? 'bg-blue-50 border-blue-200 text-blue-700' : 'bg-white border-slate-200 text-slate-500'}`}
                        >
                          USD Coin (USDC)
                        </button>
                    </div>
                    
                    {/* WARNING BANNER */}
                    <div className="w-full max-w-md bg-amber-50 border border-amber-200 text-amber-800 p-4 rounded-xl mb-6 flex items-start gap-3">
                        <AlertTriangle className="w-5 h-5 shrink-0 mt-0.5" />
                        <div className="text-xs">
                           <p className="font-bold uppercase mb-1">⚠️ Important Network Warning</p>
                           <p>Please send only <strong>{selectedCrypto}</strong> using the <strong>BEP20 (Binance Smart Chain)</strong> network.</p>
                           <p className="mt-1">Sending via other networks (like ERC20 or TRC20) may result in permanent loss of funds.</p>
                        </div>
                    </div>

                    {/* QR CODE */}
                    <div className="bg-white p-3 rounded-xl border-2 border-slate-100 shadow-inner mb-4">
                       <img 
                         src={`https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${CONFIG.crypto[selectedCrypto]}`} 
                         alt="QR Code" 
                         className="w-40 h-40 mix-blend-multiply"
                       />
                    </div>
                    
                    {/* ADDRESS COPY */}
                    <div className="w-full max-w-md">
                        <p className="text-xs text-center text-slate-400 mb-2 uppercase font-bold">Deposit Address ({selectedCrypto} - BEP20)</p>
                        <div className="bg-slate-50 p-3 rounded-xl border border-slate-200 flex items-center gap-2">
                            <code className="px-2 text-xs md:text-sm text-slate-600 font-mono break-all flex-1 text-center">
                              {CONFIG.crypto[selectedCrypto]}
                            </code>
                            <button 
                              onClick={() => handleCopy(CONFIG.crypto[selectedCrypto])}
                              className="p-2 bg-white hover:bg-slate-100 rounded-lg text-slate-600 shadow-sm border border-slate-200"
                            >
                              {copied ? <Check className="w-4 h-4 text-green-600" /> : <Copy className="w-4 h-4" />}
                            </button>
                        </div>
                    </div>

                </div>
              )}
            </div>

            {/* REPORT PAYMENT BUTTON */}
            <div className="bg-indigo-900 text-white p-6 rounded-2xl flex justify-between items-center shadow-lg">
                <div>
                    <h3 className="font-bold text-lg">Already made the payment?</h3>
                    <p className="text-indigo-200 text-sm">Let us know so we can update your balance.</p>
                </div>
                <button 
                    onClick={() => setShowReportModal(true)}
                    className="bg-white text-indigo-900 px-6 py-3 rounded-xl font-bold hover:bg-indigo-50 transition-colors flex items-center gap-2"
                >
                    <UploadCloud className="w-5 h-5"/> Report Payment
                </button>
            </div>
          </div>
        </div>
      </div>

      {/* REPORT MODAL */}
      {showReportModal && (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-in fade-in">
              <div className="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl">
                  <div className="flex justify-between items-center mb-6">
                      <h3 className="font-bold text-xl text-slate-900">Report Payment</h3>
                      <button onClick={() => setShowReportModal(false)}><X className="w-6 h-6 text-slate-400 hover:text-slate-600"/></button>
                  </div>
                  
                  <form onSubmit={handleReportPayment} className="space-y-4">
                      <div>
                          <label className="block text-sm font-bold text-slate-700 mb-1">Amount Sent ($)</label>
                          <input 
                              type="number" 
                              step="0.01" 
                              required
                              placeholder="e.g. 50.00"
                              className="w-full p-3 border border-slate-300 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 font-bold text-lg"
                              value={reportData.amount}
                              onChange={e => setReportData({...reportData, amount: e.target.value})}
                          />
                      </div>

                      <div>
                          <label className="block text-sm font-bold text-slate-700 mb-1">Transaction ID / Reference</label>
                          <input 
                              type="text" 
                              required
                              placeholder="e.g. PayPal Transaction ID or Hash"
                              className="w-full p-3 border border-slate-300 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500"
                              value={reportData.reference}
                              onChange={e => setReportData({...reportData, reference: e.target.value})}
                          />
                      </div>

                      <div className="p-3 bg-slate-50 rounded-lg text-xs text-slate-500 flex gap-2">
                          <Info className="w-4 h-4 shrink-0"/>
                          <p>We will verify the transaction with <strong>{activeTab.toUpperCase()}</strong>. This usually takes 1-2 hours.</p>
                      </div>

                      <button 
                          type="submit" 
                          disabled={reporting}
                          className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg transition-transform active:scale-95 disabled:opacity-70 flex justify-center gap-2"
                      >
                          {reporting ? <Loader2 className="w-5 h-5 animate-spin"/> : "Submit Report"}
                      </button>
                  </form>
              </div>
          </div>
      )}

    </div>
  )
}

--- FIN ARCHIVO: app\dashboard\student\wallet\page.tsx ---

--- INICIO ARCHIVO: app\dashboard\teacher\messages\page.tsx ---
'use client'

import { useState, useEffect, useRef } from 'react'
import { ArrowLeft, Send, Search, MessageSquare, Loader2, User } from 'lucide-react'
import Link from 'next/link'
import { createClient } from '@/utils/supabase/client'

// Tipos reales basados en Supabase
interface Contact {
  id: string
  name: string
  email: string
  lastMsg: string
  time: string
}

interface Message {
  id: string
  sender_id: string
  content: string
  created_at: string
  is_mine: boolean
}

export default function Messages() {
  const [supabase] = useState(() => createClient())
  const [loading, setLoading] = useState(true)
  const [currentUser, setCurrentUser] = useState<any>(null)
  
  const [activeChatId, setActiveChatId] = useState<string | null>(null)
  const [contacts, setContacts] = useState<Contact[]>([]) 
  const [messages, setMessages] = useState<Message[]>([]) 
  const [msgInput, setMsgInput] = useState("")
  
  const messagesEndRef = useRef<HTMLDivElement>(null)

  // 1. CARGAR USUARIO Y CONTACTOS
  useEffect(() => {
    const initData = async () => {
        const { data: { user } } = await supabase.auth.getUser()
        if (!user) return
        setCurrentUser(user)

        // Buscar mensajes donde soy emisor O receptor para sacar contactos únicos
        const { data: allMsgs } = await supabase
            .from('messages')
            .select(`
                *,
                sender:profiles!sender_id(first_name, last_name, email),
                receiver:profiles!receiver_id(first_name, last_name, email)
            `)
            .or(`sender_id.eq.${user.id},receiver_id.eq.${user.id}`)
            .order('created_at', { ascending: false })

        if (allMsgs) {
            // Procesar contactos únicos
            const uniqueContactsMap = new Map()
            
            allMsgs.forEach((msg: any) => {
                const isMeSender = msg.sender_id === user.id
                const otherId = isMeSender ? msg.receiver_id : msg.sender_id
                const otherProfile = isMeSender ? msg.receiver : msg.sender
                
                if (!uniqueContactsMap.has(otherId)) {
                    uniqueContactsMap.set(otherId, {
                        id: otherId,
                        name: otherProfile ? `${otherProfile.first_name || ''} ${otherProfile.last_name || ''}` : 'Usuario',
                        email: otherProfile?.email || '',
                        lastMsg: msg.content,
                        time: new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                    })
                }
            })
            setContacts(Array.from(uniqueContactsMap.values()))
        }
        setLoading(false)
    }
    initData()
  }, [])

  // 2. CARGAR MENSAJES DEL CHAT ACTIVO (POLLING SIMPLE O SUBSCRIPTION)
  useEffect(() => {
      if (!activeChatId || !currentUser) return

      const fetchMessages = async () => {
          const { data } = await supabase
              .from('messages')
              .select('*')
              .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${activeChatId}),and(sender_id.eq.${activeChatId},receiver_id.eq.${currentUser.id})`)
              .order('created_at', { ascending: true })
          
          if (data) {
              setMessages(data.map((m: any) => ({
                  id: m.id,
                  sender_id: m.sender_id,
                  content: m.content,
                  created_at: new Date(m.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                  is_mine: m.sender_id === currentUser.id
              })))
              scrollToBottom()
          }
      }

      fetchMessages()
      // Suscripción en tiempo real (Opcional, pero recomendada)
      const channel = supabase.channel('chat_room')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' },payload => {
            fetchMessages() // Recargar si hay nuevo mensaje
        })
        .subscribe()

      return () => { supabase.removeChannel(channel) }

  }, [activeChatId, currentUser])

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" })
  }

  // 3. ENVIAR MENSAJE
  const sendMessage = async (e: any) => {
    e.preventDefault();
    if (!msgInput.trim() || !activeChatId || !currentUser) return;

    const textToSend = msgInput
    setMsgInput("") // Limpiar UI rápido

    // Optimistic Update (Mostrarlo antes de confirmar)
    const tempId = Date.now().toString()
    setMessages(prev => [...prev, {
        id: tempId,
        sender_id: currentUser.id,
        content: textToSend,
        created_at: "Now",
        is_mine: true
    }])
    
    // Insertar en BD
    const { error } = await supabase.from('messages').insert({
        sender_id: currentUser.id,
        receiver_id: activeChatId,
        content: textToSend
    })

    if (error) {
        alert("Error enviando mensaje")
        // Aquí deberías revertir el optimistic update si falla
    }
  }

  const activeContact = contacts.find(c => c.id === activeChatId)

  if (loading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-indigo-600"/></div>

  return (
    <div className="h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-900 flex flex-col">
      
      {/* Header */}
      <div className="flex items-center gap-4 mb-6 shrink-0">
        <Link href="/dashboard/teacher" className="p-2 bg-white rounded-lg hover:bg-slate-100 border border-slate-200 text-slate-600">
          <ArrowLeft className="w-5 h-5" />
        </Link>
        <h1 className="text-2xl font-bold text-slate-900">Mensajes</h1>
      </div>

      {/* Chat Layout */}
      <div className="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex">
        
        {/* Sidebar de Contactos */}
        <div className="w-full md:w-1/3 border-r border-slate-100 bg-slate-50/50 flex flex-col">
          <div className="p-4 border-b border-slate-100">
            <div className="relative">
                <Search className="w-4 h-4 absolute left-3 top-3 text-slate-400" />
                <input type="text" placeholder="Buscar contactos..." className="w-full pl-9 pr-4 py-2 bg-white border border-slate-200 rounded-lg text-sm outline-none focus:border-indigo-500" />
            </div>
          </div>
          <div className="flex-1 overflow-y-auto">
            {contacts.length === 0 ? (
                <div className="p-8 text-center text-slate-500">
                    <MessageSquare className="w-8 h-8 mx-auto mb-2 opacity-50"/>
                    <p className="text-sm font-medium">No tienes conversaciones.</p>
                    <p className="text-xs mt-1">Los chats aparecerán aquí cuando hables con alguien.</p>
                </div>
            ) : (
                contacts.map((c) => (
                    <div key={c.id} onClick={() => setActiveChatId(c.id)} className={`p-4 cursor-pointer hover:bg-white transition-colors border-b border-slate-100 ${activeChatId === c.id ? 'bg-white border-l-4 border-l-indigo-600' : ''}`}>
                      <div className="flex justify-between items-start mb-1">
                          <span className={`font-bold ${activeChatId === c.id ? 'text-indigo-900' : 'text-slate-700'}`}>{c.name}</span>
                          <span className="text-[10px] text-slate-400">{c.time}</span>
                      </div>
                      <p className="text-xs text-slate-500 truncate">{c.lastMsg}</p>
                    </div>
                ))
            )}
          </div>
        </div>

        {/* Área de Chat */}
        <div className="hidden md:flex flex-1 flex-col bg-white">
            {!activeChatId ? (
                <div className="flex-1 flex flex-col items-center justify-center text-slate-400">
                    <MessageSquare className="w-12 h-12 mb-4 opacity-20"/>
                    <p className="text-center font-medium">Selecciona un contacto para chatear.</p>
                </div>
            ) : (
                <>
                    {/* Chat Header */}
                    <div className="p-4 border-b border-slate-100 flex items-center gap-3 bg-white shadow-sm z-10">
                        <div className="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold">
                            {activeContact?.name.charAt(0) || <User size={20}/>}
                        </div>
                        <div>
                            <p className="font-bold text-slate-800">{activeContact?.name}</p>
                            <p className="text-xs text-slate-500">{activeContact?.email}</p>
                        </div>
                    </div>
                    
                    {/* Contenedor de Mensajes */}
                    <div className="flex-1 p-6 overflow-y-auto space-y-4 bg-slate-50/30">
                        {messages.length === 0 ? (
                            <div className="text-center text-slate-400 pt-10">
                                <p>¡Es el comienzo de algo grande!</p>
                                <p className="text-sm">Envía un mensaje para empezar.</p>
                            </div>
                        ) : (
                             messages.map((msg) => (
                                <div key={msg.id} className={`flex ${msg.is_mine ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`px-4 py-2 rounded-2xl text-sm max-w-xs shadow-sm ${
                                        msg.is_mine ? 'bg-indigo-600 text-white rounded-tr-sm' : 'bg-white border border-slate-200 text-slate-700 rounded-tl-sm'
                                    }`}>
                                        <p>{msg.content}</p>
                                        <p className={`text-[10px] mt-1 text-right ${msg.is_mine ? 'text-indigo-200' : 'text-slate-400'}`}>{msg.created_at}</p>
                                    </div>
                                </div>
                             ))
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    {/* Input */}
                    <form onSubmit={sendMessage} className="p-4 border-t border-slate-100 bg-white">
                        <div className="flex gap-2">
                            <input 
                                type="text" 
                                placeholder="Escribe un mensaje..." 
                                value={msgInput}
                                onChange={(e) => setMsgInput(e.target.value)}
                                className="flex-1 border border-slate-200 rounded-lg px-4 py-3 text-sm outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all" 
                            />
                            <button type="submit" disabled={!msgInput.trim()} className="p-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                <Send className="w-5 h-5"/>
                            </button>
                        </div>
                    </form>
                </>
            )}
        </div>

      </div>
    </div>
  )
}

--- FIN ARCHIVO: app\dashboard\teacher\messages\page.tsx ---

--- INICIO ARCHIVO: app\dashboard\teacher\page.tsx ---
'use client'

import { useEffect, useState, useRef } from 'react'
import { createClient } from '@/utils/supabase/client'
import { 
  UploadCloud, Video, Users, Calendar, 
  Loader2, Camera, Edit2, Save, X, DollarSign, BookOpen, User, LogOut, Wallet, ChevronRight, FileText, Trash2, MessageSquare, Clock
} from 'lucide-react'
import Link from 'next/link'
import { useRouter } from 'next/navigation'

export default function TeacherDashboard() {
  const [supabase] = useState(() => createClient())
  const router = useRouter()
  
  // Estados Generales
  const [loading, setLoading] = useState(true)
  const [user, setUser] = useState<any>(null)
  
  // Estados del Dashboard
  const [todaySchedule, setTodaySchedule] = useState<any[]>([])
  const [incomingRequest, setIncomingRequest] = useState<any>(null)
  const [stats, setStats] = useState({ classes: 0, earnings: 0 })

  // Estados Perfil
  const [isEditingProfile, setIsEditingProfile] = useState(false)
  const [savingProfile, setSavingProfile] = useState(false)
  const fileInputRef = useRef<HTMLInputElement>(null)
  const [profileData, setProfileData] = useState({
    first_name: '', last_name: '', headline: '', biography: '',
    hourly_rate: 15, specialty: 'spanish', avatar_url: ''
  })

  // Estados Pagos
  const [showPayoutModal, setShowPayoutModal] = useState(false)
  const [payoutLoading, setPayoutLoading] = useState(false)
  const [payoutMethod, setPayoutMethod] = useState<'paypal' | 'crypto'>('paypal')
  const [payoutAddress, setPayoutAddress] = useState('')

  // Estados Recursos
  const [showResourceModal, setShowResourceModal] = useState(false)
  const [resources, setResources] = useState<any[]>([])
  const [uploadingResource, setUploadingResource] = useState(false)
  const resourceInputRef = useRef<HTMLInputElement>(null)

  // LOGOUT
  const handleLogout = async () => {
    await supabase.auth.signOut()
    router.refresh()
    router.push('/')
  }

  // CARGAR DATOS
  useEffect(() => {
    const initDashboard = async () => {
      try {
        const { data: { user } } = await supabase.auth.getUser()
        if (!user) { router.push('/login'); return }
        setUser(user)

        // 1. Perfil
        const { data: profile } = await supabase.from('profiles').select('*').eq('id', user.id).single()
        if (profile) {
          setProfileData({
            first_name: profile.first_name || '', last_name: profile.last_name || '',
            headline: profile.headline || '', biography: profile.biography || '',
            hourly_rate: profile.hourly_rate || 15, specialty: profile.specialty || 'spanish',
            avatar_url: profile.avatar_url || ''
          })
        }

        // 2. Agenda Hoy
        const today = new Date().toISOString().split('T')[0]
        const { data: bookings, count } = await supabase.from('bookings')
          .select(`id, date, time, status, topic, meeting_link, student:profiles!student_id(first_name, last_name)`, { count: 'exact' })
          .eq('teacher_id', user.id).gte('date', today).order('time', { ascending: true })

        // 3. Ganancias
        let totalEarnings = 0;
        const { data: completed } = await supabase.from('bookings').select('price_paid').eq('teacher_id', user.id).eq('status', 'completed')
        if (completed) totalEarnings = completed.reduce((sum, b) => sum + (b.price_paid || 0), 0)

        if (bookings) {
          const formatted = bookings.map((b: any) => ({
             id: b.id, time: b.time, student: b.student ? `${b.student.first_name} ${b.student.last_name}` : 'Disponible',
             type: b.topic || 'Clase', status: b.status, date: b.date, link: b.meeting_link || 'demo-room'
          })).filter((b: any) => b.date === today)
          setTodaySchedule(formatted)
          setStats({ classes: count || 0, earnings: totalEarnings })
        }

        // 4. Recursos del Maestro
        const { data: myResources } = await supabase.from('resources').select('*').eq('teacher_id', user.id).order('created_at', { ascending: false })
        if (myResources) setResources(myResources)

        // 5. Canal Realtime (SOLICITUDES DE LLAMADA)
        const channel = supabase.channel('room-requests')
          .on(
            'postgres_changes', 
            { event: 'INSERT', schema: 'public', table: 'class_requests', filter: `teacher_id=eq.${user.id}` }, 
            (payload: any) => {
                // Solo reaccionar si está en espera
                if(payload.new.status === 'waiting') {
                    setIncomingRequest({ 
                        id: payload.new.id, 
                        student: payload.new.student_name, 
                        roomId: payload.new.room_id 
                    })
                    // SONIDO DE ALERTA
                    try {
                        const audio = new Audio('/notification.mp3') // Asegúrate de tener este archivo en public/
                        audio.play().catch(e => console.log("Audio play failed interaction required"))
                    } catch(e) {}
                }
            }
          )
          .subscribe()

        return () => { supabase.removeChannel(channel) }

      } catch (error) { console.error(error) } finally { setLoading(false) }
    }
    initDashboard()
  }, [supabase, router])

  // --- CORRECCIÓN 1: ACEPTAR LLAMADA (HANDSHAKE) ---
  const handleAcceptCall = async () => {
      if(!incomingRequest) return
      
      try {
          // Actualizamos el estado a 'accepted' para que el alumno reciba la notificación
          await supabase
            .from('class_requests')
            .update({ status: 'accepted' })
            .eq('id', incomingRequest.id)

          // Redirigimos a la sala
          router.push(`/room/${incomingRequest.roomId}`)
      } catch (error) {
          console.error("Error aceptando llamada", error)
          // Fallback: ir a la sala de todos modos
          router.push(`/room/${incomingRequest.roomId}`)
      }
  }

  // --- FUNCIONES PERFIL ---
  const handleUpdateProfile = async () => {
    setSavingProfile(true)
    try {
      await supabase.from('profiles').update({ ...profileData, hourly_rate: Number(profileData.hourly_rate) }).eq('id', user.id)
      setIsEditingProfile(false)
    } catch (e) { alert('Error al guardar') } finally { setSavingProfile(false) }
  }

  const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    if (!e.target.files?.[0]) return
    const file = e.target.files[0]
    const filePath = `${user.id}-${Math.random()}.${file.name.split('.').pop()}`
    setSavingProfile(true)
    try {
      await supabase.storage.from('avatars').upload(filePath, file)
      const { data: { publicUrl } } = supabase.storage.from('avatars').getPublicUrl(filePath)
      setProfileData(prev => ({ ...prev, avatar_url: publicUrl }))
      await supabase.from('profiles').update({ avatar_url: publicUrl }).eq('id', user.id)
    } catch (e:any) { alert(e.message) } finally { setSavingProfile(false) }
  }

  // --- FUNCIONES PAGOS ---
  const handleRequestPayout = async () => {
    if(!payoutAddress) return alert("Ingresa una cuenta")
    setPayoutLoading(true)
    try {
      await supabase.from('payout_requests').insert({ teacher_id: user.id, amount: stats.earnings, method: payoutMethod, payment_address: payoutAddress })
      alert('Solicitud enviada'); setShowPayoutModal(false)
    } catch (e:any) { alert(e.message) } finally { setPayoutLoading(false) }
  }

  // --- CORRECCIÓN 2: BUCKET CORRECTO ('class-resources') ---
  const handleResourceUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
      if (!e.target.files?.[0]) return
      const file = e.target.files[0]
      const fileType = file.type.startsWith('image/') ? 'image' : 'pdf'
      const fileName = `${Date.now()}-${file.name}`
      
      setUploadingResource(true)
      try {
          // CORREGIDO: Usar 'class-resources' que es el bucket que creamos en SQL
          const { error: uploadError } = await supabase.storage.from('class-resources').upload(fileName, file)
          if(uploadError) throw uploadError

          const { data: { publicUrl } } = supabase.storage.from('class-resources').getPublicUrl(fileName)

          const { data: newResource, error: dbError } = await supabase.from('resources').insert({
              teacher_id: user.id,
              title: file.name,
              file_url: publicUrl,
              file_type: fileType
          }).select().single()

          if(dbError) throw dbError

          setResources([newResource, ...resources])

      } catch (error: any) {
          alert("Error subiendo recurso: " + error.message)
      } finally {
          setUploadingResource(false)
      }
  }

  const handleDeleteResource = async (id: string, url: string) => {
      if(!confirm("¿Borrar este archivo?")) return
      try {
          await supabase.from('resources').delete().eq('id', id)
          setResources(resources.filter(r => r.id !== id))
      } catch (e) { alert("Error eliminando") }
  }

  if (loading) return <div className="min-h-screen flex items-center justify-center bg-slate-50"><Loader2 className="w-8 h-8 animate-spin text-indigo-600"/></div>

  return (
    <div className="p-4 md:p-8 font-sans text-slate-900 bg-slate-50 min-h-screen relative">
      
      {/* HEADER */}
      <div className="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
        <div>
          <h1 className="text-3xl font-bold text-slate-900">Hola, {profileData.first_name}</h1>
          <p className="text-slate-500 mt-1">Gestiona tus clases y tu perfil profesional desde aquí.</p>
        </div>
        <div className="flex items-center gap-4">
           <button onClick={handleLogout} className="flex items-center gap-2 px-4 py-2 rounded-full border border-red-200 text-red-600 font-bold text-sm hover:bg-red-50 transition-colors">
             <LogOut className="w-4 h-4" /> Cerrar Sesión
           </button>
           <div className="flex items-center gap-2 bg-white px-4 py-2 rounded-full shadow-sm border border-slate-200">
             <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
             <p className="text-xs text-green-700 font-bold uppercase">Perfil Visible</p>
           </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        {/* COLUMNA PRINCIPAL */}
        <div className="lg:col-span-2 space-y-8">
            
            {/* ALERTAS (CORREGIDO: Botón conectado a handleAcceptCall) */}
            {incomingRequest && (
                <div className="bg-indigo-600 rounded-2xl p-6 text-white shadow-xl flex flex-col sm:flex-row justify-between items-center gap-4 animate-in slide-in-from-top duration-300">
                    <div className="flex items-center gap-4">
                         <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center text-2xl animate-bounce">🎓</div>
                         <div>
                            <h2 className="font-bold text-lg">¡Alumno Esperando!</h2>
                            <p className="text-indigo-100">El estudiante {incomingRequest.student} solicita una clase ahora.</p>
                         </div>
                    </div>
                    <div className="flex gap-2">
                        <button onClick={() => setIncomingRequest(null)} className="px-4 py-2 text-indigo-200 hover:text-white text-sm font-bold">Ignorar</button>
                        <button onClick={handleAcceptCall} className="px-6 py-3 bg-white text-indigo-600 font-bold rounded-xl shadow-lg hover:bg-indigo-50 flex items-center gap-2 transition-transform hover:scale-105">
                            <Video className="w-5 h-5" /> ACEPTAR Y ENTRAR
                        </button>
                    </div>
                </div>
            )}

            {/* PERFIL */}
            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative">
                <div className="h-24 bg-gradient-to-r from-indigo-500 to-violet-600"></div>
                <div className="px-8 pb-8">
                    <div className="flex justify-between items-start -mt-10 mb-6">
                         <div className="relative group">
                            <div className="w-24 h-24 rounded-full border-4 border-white bg-slate-200 overflow-hidden">
                                {profileData.avatar_url ? <img src={profileData.avatar_url} className="w-full h-full object-cover"/> : <User className="w-full h-full p-4 text-slate-400"/>}
                            </div>
                            <button onClick={() => fileInputRef.current?.click()} className="absolute bottom-0 right-0 bg-slate-900 text-white p-2 rounded-full"><Camera className="w-4 h-4"/></button>
                            <input type="file" hidden ref={fileInputRef} accept="image/*" onChange={handleImageUpload} />
                         </div>
                         <button onClick={isEditingProfile ? handleUpdateProfile : () => setIsEditingProfile(true)} className="mt-12 px-4 py-2 rounded-lg border border-slate-200 font-bold text-sm hover:bg-slate-50 flex gap-2">
                            {isEditingProfile ? <Save className="w-4 h-4"/> : <Edit2 className="w-4 h-4"/>} {isEditingProfile ? 'Guardar' : 'Editar'}
                         </button>
                    </div>

                    <div className="grid md:grid-cols-2 gap-8">
                        <div className="space-y-4">
                            <div>
                                <label className="text-xs font-bold text-slate-400 uppercase">Titular</label>
                                {isEditingProfile ? <input type="text" className="w-full p-2 border rounded font-bold" value={profileData.headline} onChange={e=>setProfileData({...profileData, headline: e.target.value})}/> : <h2 className="text-xl font-bold">{profileData.headline || 'Sin titular'}</h2>}
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-400 uppercase">Bio</label>
                                {isEditingProfile ? <textarea className="w-full p-2 border rounded" rows={3} value={profileData.biography} onChange={e=>setProfileData({...profileData, biography: e.target.value})}/> : <p className="text-sm text-slate-600">{profileData.biography || 'Sin biografía'}</p>}
                            </div>
                        </div>
                        <div className="space-y-4 bg-slate-50 p-6 rounded-xl">
                            <div>
                                <label className="text-xs font-bold text-slate-400 uppercase">Tarifa</label>
                                {isEditingProfile ? <input type="number" className="w-full p-2 border rounded font-bold" value={profileData.hourly_rate} onChange={e=>setProfileData({...profileData, hourly_rate: Number(e.target.value)})}/> : <div className="text-2xl font-black text-green-600">${profileData.hourly_rate}</div>}
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-400 uppercase">Idioma</label>
                                {isEditingProfile ? <select className="w-full p-2 border rounded" value={profileData.specialty} onChange={e=>setProfileData({...profileData, specialty: e.target.value})}><option value="spanish">Español</option><option value="english">Inglés</option></select> : <div className="font-bold text-indigo-700 capitalize">{profileData.specialty}</div>}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {/* 3. GESTIÓN DE RECURSOS */}
            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 flex justify-between items-center">
                <div>
                      <h3 className="font-bold text-slate-900 text-lg">Biblioteca de Recursos</h3>
                      <p className="text-slate-500 text-sm">{resources.length} archivos disponibles para tus clases.</p>
                </div>
                <button 
                    onClick={() => setShowResourceModal(true)} 
                    className="bg-indigo-600 text-white hover:bg-indigo-700 px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 transition-all shadow-md"
                >
                    <UploadCloud className="w-4 h-4" /> Gestionar Archivos
                </button>
            </div>
        </div>

        {/* SIDEBAR */}
        <div className="space-y-6">
            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 flex flex-col max-h-[400px]">
                <h3 className="font-bold text-slate-800 flex items-center gap-2 mb-6"><Calendar className="w-5 h-5 text-indigo-600" /> Agenda Hoy</h3>
                {todaySchedule.map(cls => (
                    <div key={cls.id} className="flex items-center gap-3 p-3 border-b border-slate-50">
                        <div className="bg-indigo-50 text-indigo-700 font-bold text-xs px-2 py-1 rounded">{cls.time}</div>
                        <div className="flex-1"><h4 className="text-sm font-bold">{cls.student}</h4></div>
                        <Link href={`/room/${cls.link}`}><Video className="w-8 h-8 p-2 bg-green-100 text-green-600 rounded-full hover:bg-green-600 hover:text-white"/></Link>
                    </div>
                ))}
                {todaySchedule.length === 0 && <p className="text-center text-sm text-slate-400">Sin clases hoy</p>}
            </div>
            
            {/* BOTONES DEL SIDEBAR */}
            <div className="space-y-3">
                <Link href="/dashboard/teacher/schedule" className="block bg-white rounded-2xl shadow-sm border border-slate-200 p-4 hover:shadow-md transition-shadow group">
                    <div className="flex items-center gap-4">
                        <div className="bg-purple-100 text-purple-600 p-3 rounded-xl group-hover:bg-purple-600 group-hover:text-white transition-colors">
                            <Clock className="w-6 h-6"/>
                        </div>
                        <div>
                            <h4 className="font-bold text-slate-800">Mi Horario</h4>
                            <p className="text-xs text-slate-500">Configura tu disponibilidad</p>
                        </div>
                        <ChevronRight className="ml-auto w-5 h-5 text-slate-300 group-hover:text-slate-500"/>
                    </div>
                </Link>

                <Link href="/dashboard/teacher/messages" className="block bg-white rounded-2xl shadow-sm border border-slate-200 p-4 hover:shadow-md transition-shadow group">
                    <div className="flex items-center gap-4">
                        <div className="bg-blue-100 text-blue-600 p-3 rounded-xl group-hover:bg-blue-600 group-hover:text-white transition-colors">
                            <MessageSquare className="w-6 h-6"/>
                        </div>
                        <div>
                            <h4 className="font-bold text-slate-800">Mensajes</h4>
                            <p className="text-xs text-slate-500">Chatea con tus alumnos</p>
                        </div>
                        <ChevronRight className="ml-auto w-5 h-5 text-slate-300 group-hover:text-slate-500"/>
                    </div>
                </Link>
            </div>

            <div className="bg-slate-900 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
                <div className="relative z-10">
                    <h3 className="text-sm font-bold text-slate-400 uppercase mb-4">Saldo Disponible</h3>
                    <div className="text-4xl font-black mb-6">${stats.earnings.toFixed(2)}</div>
                    <button onClick={() => setShowPayoutModal(true)} className="w-full bg-indigo-600 hover:bg-indigo-500 font-bold py-3 rounded-xl flex justify-center gap-2">Cobrar Salario <ChevronRight className="w-4 h-4"/></button>
                </div>
            </div>
        </div>
      </div>

      {/* MODAL DE RECURSOS */}
      {showResourceModal && (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4">
              <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full h-[600px] flex flex-col overflow-hidden animate-in fade-in zoom-in-95 duration-200">
                  <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                      <h3 className="font-bold text-lg text-slate-900">Mis Recursos de Clase</h3>
                      <button onClick={() => setShowResourceModal(false)} className="text-slate-400 hover:text-slate-600"><X className="w-5 h-5"/></button>
                  </div>

                  <div className="flex-1 overflow-y-auto p-6 bg-slate-50/50">
                      {resources.length === 0 ? (
                          <div className="h-full flex flex-col items-center justify-center text-slate-400">
                              <UploadCloud className="w-16 h-16 mb-4 opacity-20"/>
                              <p>No has subido archivos aún.</p>
                          </div>
                      ) : (
                          <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
                              {resources.map(file => (
                                  <div key={file.id} className="bg-white p-3 rounded-xl border border-slate-200 hover:shadow-md transition-shadow group relative">
                                      <div className="h-24 bg-slate-100 rounded-lg flex items-center justify-center mb-3 text-slate-400">
                                          {file.file_type === 'image' ? <Camera className="w-8 h-8"/> : <FileText className="w-8 h-8"/>}
                                      </div>
                                      <p className="text-xs font-bold text-slate-700 truncate" title={file.title}>{file.title}</p>
                                      <p className="text-[10px] text-slate-400">{new Date(file.created_at).toLocaleDateString()}</p>
                                      <button onClick={() => handleDeleteResource(file.id, file.file_url)} className="absolute top-2 right-2 bg-white text-red-500 p-1.5 rounded-md shadow-sm opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-50">
                                          <Trash2 className="w-3 h-3"/>
                                      </button>
                                  </div>
                              ))}
                          </div>
                      )}
                  </div>

                  <div className="p-4 border-t border-slate-200 bg-white">
                      <input 
                          type="file" 
                          hidden 
                          ref={resourceInputRef} 
                          accept="image/*,application/pdf"
                          onChange={handleResourceUpload}
                      />
                      <button 
                          onClick={() => resourceInputRef.current?.click()} 
                          disabled={uploadingResource}
                          className="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2 disabled:opacity-70"
                      >
                          {uploadingResource ? <Loader2 className="w-5 h-5 animate-spin"/> : <UploadCloud className="w-5 h-5"/>}
                          {uploadingResource ? 'Subiendo...' : 'Subir Nuevo Archivo (PDF o Imagen)'}
                      </button>
                  </div>
              </div>
          </div>
      )}

      {/* MODAL DE PAGOS */}
      {showPayoutModal && (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4">
              <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
                  <div className="flex justify-between mb-4">
                      <h3 className="font-bold text-lg">Retirar Fondos</h3>
                      <button onClick={() => setShowPayoutModal(false)}><X className="w-5 h-5"/></button>
                  </div>
                  <p className="text-3xl font-black mb-6 text-center">${stats.earnings.toFixed(2)}</p>
                  
                  <div className="space-y-4">
                      <div className="grid grid-cols-2 gap-2">
                            <button onClick={() => setPayoutMethod('paypal')} className={`p-2 border rounded ${payoutMethod==='paypal'?'bg-indigo-50 border-indigo-600':''}`}>PayPal</button>
                            <button onClick={() => setPayoutMethod('crypto')} className={`p-2 border rounded ${payoutMethod==='crypto'?'bg-indigo-50 border-indigo-600':''}`}>Crypto</button>
                      </div>
                      <input type="text" placeholder={payoutMethod==='paypal' ? 'Email PayPal' : 'Wallet Address'} className="w-full p-3 border rounded" value={payoutAddress} onChange={e=>setPayoutAddress(e.target.value)}/>
                      <button onClick={handleRequestPayout} disabled={payoutLoading} className="w-full bg-indigo-600 text-white font-bold py-3 rounded">
                          {payoutLoading ? 'Procesando...' : 'Confirmar'}
                      </button>
                  </div>
              </div>
          </div>
      )}

    </div>
  )
}
--- FIN ARCHIVO: app\dashboard\teacher\page.tsx ---

--- INICIO ARCHIVO: app\dashboard\teacher\resources\page.tsx ---
'use client'

import { useEffect, useState } from 'react'
import { createClient } from '@supabase/supabase-js'
import { UploadCloud, Plus, Video, Users, Calendar, MoreVertical, Loader2, ArrowRight } from 'lucide-react'
import Link from 'next/link'
import { useRouter } from 'next/navigation'

// Credenciales
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!

export default function TeacherDashboard() {
  const [supabase] = useState(() => createClient(supabaseUrl, supabaseAnonKey))
  const router = useRouter()
  
  const [loading, setLoading] = useState(true)
  const [teacherName, setTeacherName] = useState('')
  const [todaySchedule, setTodaySchedule] = useState<any[]>([])
  const [incomingRequest, setIncomingRequest] = useState<any>(null)
  
  // Estado para estadísticas reales
  const [stats, setStats] = useState({ classes: 0, earnings: 0 })

  useEffect(() => {
    const initDashboard = async () => {
      try {
        // 1. Obtener usuario autenticado
        const { data: { user } } = await supabase.auth.getUser()
        if (!user) {
          router.push('/login')
          return
        }

        // 2. Obtener Perfil
        const { data: profile } = await supabase
          .from('profiles')
          .select('first_name, last_name')
          .eq('id', user.id)
          .single()
        
        if (profile) setTeacherName(`${profile.first_name} ${profile.last_name}`)

        // 3. Obtener AGENDA DE HOY (Real)
        const today = new Date().toISOString().split('T')[0]
        
        const { data: bookings } = await supabase
          .from('bookings') 
          .select(`
            id, 
            date, 
            time, 
            status,
            topic,
            student:profiles!student_id(first_name, last_name)
          `)
          .eq('teacher_id', user.id)
          .eq('date', today)
          .order('time', { ascending: true })

        // 4. Obtener SALDO REAL (Wallet)
        const { data: wallet } = await supabase
          .from('wallets')
          .select('balance')
          .eq('user_id', user.id)
          .single()

        if (bookings) {
            const formatted = bookings.map((b: any) => ({
                id: b.id,
                time: b.time, 
                student: b.student ? `${b.student.first_name} ${b.student.last_name}` : 'Estudiante',
                type: b.topic || 'Clase General',
                status: b.status
            }))
            setTodaySchedule(formatted)
            
            // ACTUALIZACIÓN: Usamos datos reales de conteo y saldo
            setStats({
                classes: bookings.length,
                earnings: wallet ? wallet.balance : 0 // Dinero real de la DB
            })
        }

        // 5. SUSCRIPCIÓN REALTIME (Solicitudes)
        const channel = supabase
          .channel('room-requests')
          .on(
            'postgres_changes',
            {
              event: 'INSERT',
              schema: 'public',
              table: 'class_requests',
              filter: `teacher_id=eq.${user.id}`,
            },
            (payload: any) => {
              console.log('Nueva solicitud recibida:', payload)
              setIncomingRequest({
                  id: payload.new.id,
                  student: payload.new.student_name || 'Estudiante',
                  level: payload.new.level || 'General',
                  topic: payload.new.topic || 'Solicitud Inmediata',
                  roomId: payload.new.room_id
              })
            }
          )
          .subscribe()

        return () => {
            supabase.removeChannel(channel)
        }

      } catch (error) {
        console.error("Error cargando dashboard:", error)
      } finally {
        setLoading(false)
      }
    }

    initDashboard()
  }, [supabase, router])

  if (loading) {
      return <div className="min-h-screen flex items-center justify-center bg-slate-50"><Loader2 className="w-8 h-8 animate-spin text-indigo-600"/></div>
  }

  return (
    <div className="p-8 font-sans text-slate-900 bg-slate-50 min-h-screen">
      
      {/* HEADER */}
      <div className="flex justify-between items-end mb-8">
        <div>
          <h1 className="text-3xl font-bold text-slate-900">Bienvenido, {teacherName || 'Profesor'}</h1>
          <p className="text-slate-500 mt-1">Resumen de tu día y acciones.</p>
        </div>
        <div className="flex items-center gap-3">
             <div className="text-right hidden md:block">
                <p className="text-sm font-bold text-slate-900">{teacherName}</p>
                <div className="flex items-center justify-end gap-1">
                    <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <p className="text-xs text-green-600 font-bold">En Línea</p>
                </div>
             </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* COLUMNA PRINCIPAL */}
        <div className="lg:col-span-2 space-y-8">
            
            {/* TARJETA DE SOLICITUD EN VIVO */}
            {incomingRequest ? (
                <div className="bg-indigo-600 rounded-2xl p-6 text-white shadow-xl shadow-indigo-200 relative overflow-hidden animate-in fade-in slide-in-from-top-4 duration-500">
                    <div className="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                        <Video className="w-40 h-40" />
                    </div>
                    
                    <div className="relative z-10 flex flex-col md:flex-row items-center justify-between gap-6">
                        <div className="flex items-center gap-4">
                            <div className="relative">
                                <span className="absolute -top-1 -right-1 flex h-3 w-3">
                                    <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                    <span className="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                                </span>
                                <div className="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center text-3xl shadow-inner">🎓</div>
                            </div>
                            <div>
                                <h2 className="text-xl font-bold">¡Alumno Esperando!</h2>
                                <p className="text-indigo-100 flex items-center gap-2 mt-1">
                                    <Users className="w-4 h-4"/> Estudiante: <strong>{incomingRequest.student}</strong>
                                </p>
                                <p className="text-xs text-indigo-200 mt-1 uppercase tracking-wider font-bold bg-indigo-800/30 px-2 py-1 rounded inline-block">
                                    {incomingRequest.topic} • {incomingRequest.level}
                                </p>
                            </div>
                        </div>

                        <div className="flex gap-3 w-full md:w-auto">
                            <button 
                                onClick={() => setIncomingRequest(null)}
                                className="px-4 py-3 rounded-xl border border-white/20 hover:bg-white/10 text-white font-bold transition-all text-sm"
                            >
                                Omitir
                            </button>
                            <button 
                                onClick={() => router.push(`/room/${incomingRequest.roomId}`)}
                                className="px-6 py-3 rounded-xl bg-white text-indigo-600 font-bold hover:bg-indigo-50 shadow-lg transition-all flex items-center gap-2 animate-pulse"
                            >
                                <Video className="w-5 h-5" />
                                ENTRAR A SALA
                            </button>
                        </div>
                    </div>
                </div>
            ) : (
                <div className="bg-white p-6 rounded-2xl border border-slate-200 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        <div className="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center text-slate-400">
                            <Video className="w-5 h-5" />
                        </div>
                        <div>
                            <h3 className="font-bold text-slate-700">Sin solicitudes en vivo</h3>
                            <p className="text-xs text-slate-500">Aparecerán aquí cuando un estudiante te llame.</p>
                        </div>
                    </div>
                    <div className="h-2 w-2 bg-slate-300 rounded-full"></div>
                </div>
            )}

            {/* GESTIÓN DE CONTENIDO - BOTÓN REPARADO */}
            <div>
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold text-slate-800">Recursos de Clase</h2>
                    <Link href="/dashboard/teacher/resources" className="bg-white border border-slate-200 text-slate-600 hover:border-indigo-500 hover:text-indigo-600 px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 transition-all">
                        <Plus className="w-4 h-4" /> Nuevo Recurso
                    </Link>
                </div>

                {/* AHORA TODA LA TARJETA ES UN LINK */}
                <Link href="/dashboard/teacher/resources">
                    <div className="bg-white border-2 border-dashed border-slate-300 rounded-2xl p-10 flex flex-col items-center justify-center text-center hover:border-indigo-400 hover:bg-indigo-50/10 transition-all cursor-pointer group">
                        <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform group-hover:bg-indigo-100">
                            <UploadCloud className="w-8 h-8 text-slate-400 group-hover:text-indigo-600" />
                        </div>
                        <h3 className="text-lg font-bold text-slate-900">Sube material didáctico</h3>
                        <p className="text-slate-500 max-w-md mt-2 mb-6 text-sm">
                            Documentos PDF, Audios o Imágenes para usar en la pizarra.
                        </p>
                        {/* Botón visual (dentro del link) */}
                        <div className="bg-green-600 group-hover:bg-green-700 text-white px-8 py-3 rounded-full font-bold shadow-lg shadow-green-200 transition-all transform active:scale-95 inline-block">
                            IR A BIBLIOTECA
                        </div>
                    </div>
                </Link>
            </div>

        </div>

        {/* COLUMNA LATERAL - AGENDA REAL */}
        <div className="space-y-6">
            
            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 h-full flex flex-col">
                <div className="flex justify-between items-center mb-6">
                    <h3 className="font-bold text-slate-800 flex items-center gap-2">
                        <Calendar className="w-5 h-5 text-indigo-600" />
                        Agenda de Hoy
                    </h3>
                    <Link href="/dashboard/teacher/schedule" className="text-xs font-bold text-indigo-600 hover:underline flex items-center gap-1">
                        Ver Calendario <ArrowRight className="w-3 h-3"/>
                    </Link>
                </div>

                {todaySchedule.length > 0 ? (
                    <div className="space-y-4 overflow-y-auto max-h-[400px]">
                        {todaySchedule.map((cls) => (
                            <div key={cls.id} className="flex items-start gap-3 p-3 rounded-xl hover:bg-slate-50 transition-colors border-b border-slate-50 last:border-0 cursor-pointer group">
                                <div className="bg-indigo-50 text-indigo-700 font-bold text-xs px-2 py-1 rounded-md min-w-[65px] text-center flex items-center justify-center">
                                    {cls.time}
                                </div>
                                <div className="flex-1">
                                    <h4 className="text-sm font-bold text-slate-900 group-hover:text-indigo-600 transition-colors">{cls.student}</h4>
                                    <p className="text-xs text-slate-500">{cls.type}</p>
                                </div>
                                <button className="text-slate-300 hover:text-indigo-600">
                                    <MoreVertical className="w-4 h-4" />
                                </button>
                            </div>
                        ))}
                    </div>
                ) : (
                    <div className="flex-1 flex flex-col items-center justify-center text-center p-4">
                        <div className="w-12 h-12 bg-slate-50 rounded-full flex items-center justify-center mb-2">
                            <Calendar className="w-6 h-6 text-slate-300" />
                        </div>
                        <p className="text-sm font-bold text-slate-400">Sin clases para hoy</p>
                        <p className="text-xs text-slate-300">Relájate o prepara material.</p>
                        <Link href="/dashboard/teacher/schedule" className="mt-4 px-4 py-2 border border-slate-200 rounded-lg text-xs font-bold text-slate-600 hover:bg-slate-50">
                            Configurar Horario
                        </Link>
                    </div>
                )}
            </div>

            {/* ESTADÍSTICAS REALES (Wallet) */}
            <div className="bg-slate-900 rounded-2xl p-6 text-white shadow-lg">
                <h3 className="text-sm font-bold text-slate-400 uppercase mb-4">Saldo Disponible</h3>
                <div className="flex justify-between items-end">
                    <div>
                        <span className="text-3xl font-bold">{stats.classes}</span>
                        <span className="text-sm text-slate-400 ml-2">Clases Hoy</span>
                    </div>
                    <div className="text-right">
                        <span className="text-3xl font-bold text-green-400">${stats.earnings.toFixed(2)}</span>
                    </div>
                </div>
                <div className="mt-4 w-full bg-slate-800 h-2 rounded-full overflow-hidden">
                    {/* Barra de progreso decorativa */}
                    <div className="bg-indigo-500 h-full transition-all" style={{ width: '70%' }}></div>
                </div>
                <p className="text-xs text-slate-500 mt-2 text-right">Saldo total en billetera</p>
            </div>

        </div>

      </div>
    </div>
  )
}
--- FIN ARCHIVO: app\dashboard\teacher\resources\page.tsx ---

--- INICIO ARCHIVO: app\dashboard\teacher\schedule\page.tsx ---
'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import { ArrowLeft, ChevronLeft, ChevronRight, Plus, Trash2, Clock, Calendar as CalIcon, Loader2 } from 'lucide-react'
import Link from 'next/link'
import { createClient } from '@/utils/supabase/client'

export default function TeacherSchedule() {
  const router = useRouter()
  const [supabase] = useState(() => createClient())
  
  // Estado del Calendario
  const [currentDate, setCurrentDate] = useState(new Date())
  const [selectedDate, setSelectedDate] = useState<Date | null>(null)
  const [selectedSlots, setSelectedSlots] = useState<any[]>([])
  
  // Estado para Nuevo Rango
  const [rangeStart, setRangeStart] = useState("09:00")
  const [rangeEnd, setRangeEnd] = useState("13:00")
  
  // Carga de datos
  const [existingBookings, setExistingBookings] = useState<any[]>([])
  const [loading, setLoading] = useState(true)
  const [saving, setSaving] = useState(false)

  // 1. CARGAR RESERVAS
  useEffect(() => {
      fetchMonthBookings()
  }, [currentDate])

  const fetchMonthBookings = async () => {
      setLoading(true)
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) return router.push('/login')

      const year = currentDate.getFullYear()
      const month = currentDate.getMonth()
      const firstDay = new Date(year, month, 1).toISOString()
      const lastDay = new Date(year, month + 1, 0).toISOString()

      const { data } = await supabase
          .from('bookings')
          .select('*')
          .eq('teacher_id', user.id)
          .gte('date', firstDay)
          .lte('date', lastDay)
      
      if (data) setExistingBookings(data)
      setLoading(false)
  }

  // --- LÓGICA DEL CALENDARIO ---
  const getDaysInMonth = (year: number, month: number) => new Date(year, month + 1, 0).getDate()
  const getFirstDayOfMonth = (year: number, month: number) => new Date(year, month, 1).getDay()

  const handlePrevMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))
  const handleNextMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))

  const handleDayClick = (day: number) => {
      const clickedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day)
      setSelectedDate(clickedDate)
      
      const dateStr = clickedDate.toISOString().split('T')[0]
      const slots = existingBookings.filter(b => b.date === dateStr).sort((a,b) => a.time.localeCompare(b.time))
      setSelectedSlots(slots)
  }

  // --- GESTIÓN DE RANGOS ---
  const addTimeRange = async () => {
      if (!selectedDate) return
      
      const startHour = parseInt(rangeStart.split(':')[0])
      const endHour = parseInt(rangeEnd.split(':')[0])

      if (startHour >= endHour) {
          alert("La hora de fin debe ser posterior a la de inicio.")
          return
      }

      setSaving(true)
      
      try {
        const { data: { user } } = await supabase.auth.getUser()
        if(!user) throw new Error("No hay usuario")

        // Formato seguro de fecha local YYYY-MM-DD
        const year = selectedDate.getFullYear()
        const month = String(selectedDate.getMonth() + 1).padStart(2, '0')
        const day = String(selectedDate.getDate()).padStart(2, '0')
        const dateStr = `${year}-${month}-${day}`
        
        const newSlots = []

        // Generar bloques de 1 hora
        for (let h = startHour; h < endHour; h++) {
            const timeStr = `${h.toString().padStart(2, '0')}:00:00`
            
            // Verificar si ya existe para no duplicar
            const exists = selectedSlots.some(s => s.time.startsWith(timeStr.slice(0,5)))
            
            if (!exists) {
                newSlots.push({
                    teacher_id: user.id,
                    date: dateStr,
                    time: timeStr,
                    status: 'pending',
                    meeting_link: `room-${user.id}-${Date.now()}-${h}`,
                    topic: 'Disponible',
                    student_id: null
                })
            }
        }

        if (newSlots.length > 0) {
            const { data, error } = await supabase.from('bookings').insert(newSlots).select()
            
            if (error) throw error

            if (data) {
                const updatedGlobal = [...existingBookings, ...data]
                setExistingBookings(updatedGlobal)
                setSelectedSlots([...selectedSlots, ...data].sort((a,b) => a.time.localeCompare(b.time)))
            }
        } else {
            alert("Esas horas ya están agregadas.")
        }

      } catch (error: any) {
          alert("Error al guardar: " + error.message)
      } finally {
          setSaving(false)
      }
  }

  const deleteSlot = async (id: string) => {
      if(!confirm("¿Eliminar este horario?")) return
      setSaving(true)
      const { error } = await supabase.from('bookings').delete().eq('id', id)
      
      if (error) {
           alert("Error al eliminar: " + error.message)
      } else {
           setExistingBookings(existingBookings.filter(b => b.id !== id))
           setSelectedSlots(selectedSlots.filter(b => b.id !== id))
      }
      setSaving(false)
  }

  // --- RENDERIZADO DEL CALENDARIO ---
  const renderCalendarDays = () => {
      const days = []
      const daysInMonth = getDaysInMonth(currentDate.getFullYear(), currentDate.getMonth())
      const startDay = getFirstDayOfMonth(currentDate.getFullYear(), currentDate.getMonth()) 

      for (let i = 0; i < startDay; i++) days.push(<div key={`empty-${i}`} className="h-24 bg-slate-50/50 border border-slate-100"></div>)

      for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = new Date(currentDate.getFullYear(), currentDate.getMonth(), day).toISOString().split('T')[0]
          const daySlots = existingBookings.filter(b => b.date === dateStr)
          const isSelected = selectedDate?.getDate() === day && selectedDate?.getMonth() === currentDate.getMonth()
          
          days.push(
              <div key={day} onClick={() => handleDayClick(day)} className={`h-24 border border-slate-100 p-2 cursor-pointer hover:bg-indigo-50 relative ${isSelected ? 'bg-indigo-50 ring-2 ring-indigo-500 z-10' : 'bg-white'}`}>
                  <span className={`text-sm font-bold w-6 h-6 flex items-center justify-center rounded-full ${isSelected ? 'bg-indigo-600 text-white' : 'text-slate-700'}`}>{day}</span>
                  <div className="mt-2 space-y-1 overflow-hidden h-12">
                      {daySlots.slice(0, 3).map(slot => (
                          <div key={slot.id} className={`text-[10px] px-1 rounded truncate ${slot.student_id ? 'bg-green-100 text-green-700 font-bold' : 'bg-slate-100 text-slate-500'}`}>{slot.time.slice(0,5)}</div>
                      ))}
                      {daySlots.length > 3 && <div className="text-[10px] text-slate-400">+{daySlots.length - 3}</div>}
                  </div>
              </div>
          )
      }
      return days
  }

  const hoursOptions = [...Array(24)].map((_, i) => `${i.toString().padStart(2,'0')}:00`)

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-900 flex flex-col md:flex-row">
      
      {/* 1. CALENDARIO */}
      <div className="flex-1 p-6 md:p-8 overflow-y-auto">
          {/* HEADER CON BOTÓN ATRÁS CORREGIDO */}
          <div className="flex items-center gap-4 mb-6">
            <Link 
                href="/dashboard/teacher" 
                className="p-2 bg-white rounded-lg hover:bg-slate-100 border border-slate-200 text-slate-600 transition-colors flex items-center justify-center"
            >
                <ArrowLeft className="w-5 h-5" />
            </Link>
            <h1 className="text-2xl font-bold">Mi Agenda</h1>
          </div>

          <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
              <div className="p-4 flex justify-between border-b border-slate-200">
                  <h2 className="text-xl font-bold capitalize flex items-center gap-2"><CalIcon className="w-5 h-5 text-indigo-600"/> {currentDate.toLocaleString('es-ES', { month: 'long', year: 'numeric' })}</h2>
                  <div className="flex gap-2">
                      <button onClick={handlePrevMonth} className="p-2 hover:bg-slate-100 rounded"><ChevronLeft/></button>
                      <button onClick={handleNextMonth} className="p-2 hover:bg-slate-100 rounded"><ChevronRight/></button>
                  </div>
              </div>
              <div className="grid grid-cols-7 bg-slate-50 border-b text-center py-2 font-bold text-xs text-slate-400 uppercase">
                  {['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'].map(d => <div key={d}>{d}</div>)}
              </div>
              <div className="grid grid-cols-7 bg-slate-200 gap-[1px]">{loading ? <div className="col-span-7 h-64 flex justify-center items-center bg-white"><Loader2 className="animate-spin"/></div> : renderCalendarDays()}</div>
          </div>
      </div>

      {/* 2. PANEL LATERAL (RANGOS) */}
      <div className="w-full md:w-96 bg-white border-l border-slate-200 p-6 flex flex-col shadow-xl z-20">
          {!selectedDate ? (
              <div className="flex-1 flex flex-col items-center justify-center text-slate-400 text-center"><CalIcon className="w-16 h-16 mb-4 opacity-20"/><p>Selecciona un día para gestionar.</p></div>
          ) : (
              <>
                  <div className="mb-6 pb-6 border-b border-slate-100">
                      <h3 className="text-2xl font-bold text-slate-800 capitalize">{selectedDate.toLocaleDateString('es-ES', {weekday: 'long', day: 'numeric', month: 'long'})}</h3>
                      <p className="text-sm text-slate-500">{selectedSlots.length} horas disponibles</p>
                  </div>

                  {/* FORMULARIO DE RANGO */}
                  <div className="bg-slate-50 p-4 rounded-xl mb-6 border border-slate-200">
                      <p className="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2"><Clock className="w-3 h-3"/> Agregar Bloque de Horas</p>
                      <div className="flex items-center gap-2 mb-4">
                          <select value={rangeStart} onChange={e=>setRangeStart(e.target.value)} className="bg-white border p-2 rounded w-full font-bold text-sm">{hoursOptions.map(h=><option key={h} value={h}>{h}</option>)}</select>
                          <span className="text-slate-400">-</span>
                          <select value={rangeEnd} onChange={e=>setRangeEnd(e.target.value)} className="bg-white border p-2 rounded w-full font-bold text-sm">{hoursOptions.map(h=><option key={h} value={h}>{h}</option>)}</select>
                      </div>
                      <button onClick={addTimeRange} disabled={saving} className="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-indigo-700 disabled:opacity-50 flex justify-center items-center gap-2">
                          {saving ? <Loader2 className="w-4 h-4 animate-spin"/> : <Plus className="w-4 h-4"/>} Generar y Guardar
                      </button>
                  </div>

                  {/* LISTA DE SLOTS */}
                  <div className="flex-1 overflow-y-auto space-y-2">
                      {selectedSlots.map((slot) => (
                          <div key={slot.id} className={`p-3 rounded-lg border flex justify-between items-center ${slot.student_id ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-100'}`}>
                              <span className="font-bold text-slate-700">{slot.time.slice(0,5)}</span>
                              {slot.student_id ? <span className="text-xs font-bold text-indigo-600">RESERVADO</span> : 
                                <button onClick={() => deleteSlot(slot.id)} className="text-slate-300 hover:text-red-500"><Trash2 className="w-4 h-4"/></button>
                              }
                          </div>
                      ))}
                  </div>
              </>
          )}
      </div>
    </div>
  )
}

--- FIN ARCHIVO: app\dashboard\teacher\schedule\page.tsx ---

--- INICIO ARCHIVO: app\globals.css ---
@import "tailwindcss";

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}

--- FIN ARCHIVO: app\globals.css ---

--- INICIO ARCHIVO: app\layout.tsx ---
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
      >
        {children}
      </body>
    </html>
  );
}

--- FIN ARCHIVO: app\layout.tsx ---

--- INICIO ARCHIVO: app\login\page.tsx ---
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import Link from 'next/link'
import { createClient } from '@/utils/supabase/client'
import { Loader2, AlertCircle, ArrowLeft, Globe } from 'lucide-react'

export default function LoginPage() {
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [error, setError] = useState<string | null>(null)
  const [loading, setLoading] = useState(false)
  
  const router = useRouter()
  // Asegúrate de que este createClient() esté correctamente importado y configurado
  const supabase = createClient()

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault()
    setError(null)
    setLoading(true)

    try {
      // 1. Sign In
      const { data: { user }, error: signInError } = await supabase.auth.signInWithPassword({
        email,
        password,
      })

      if (signInError) throw signInError
      if (!user) throw new Error('Could not identify the user.')

      // 2. CHECK ROLE
      const { data: profile, error: profileError } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single()

      // Si no encuentra perfil, asumimos estudiante por defecto para evitar bloqueos,
      // pero si eres admin, DEBE decir 'admin' en la base de datos.
      const userRole = profile?.role || 'student'

      // 3. Smart Redirection
      router.refresh()

      if (userRole === 'admin') {
         router.push('/admin/dashboard') // <--- ¡AQUI ESTÁ LA MAGIA PARA TI!
      } else if (userRole === 'teacher') {
        router.push('/dashboard/teacher') // If Teacher
      } else {
        router.push('/dashboard/student') // If Student
      }
      
    } catch (err: any) {
      console.error("Login error:", err)
      setError(err.message || 'Error signing in')
      setLoading(false)
    }
  }

  return (
    <div className="min-h-screen flex flex-col md:flex-row bg-white font-sans text-slate-900">
      
      {/* --- LEFT SIDE (Visual / English Content) --- */}
      <div className="hidden md:flex md:w-1/2 bg-slate-900 text-white p-12 flex-col justify-between relative overflow-hidden">
        <div className="relative z-10">
          <Link href="/" className="flex items-center gap-2 text-indigo-400 font-bold text-xl mb-2">
            <Globe className="w-6 h-6"/> Tutorio
          </Link>
          <p className="text-slate-400">Welcome back to your classroom.</p>
        </div>
        
        <div className="relative z-10">
          <blockquote className="text-xl font-medium leading-relaxed">
            "The limits of my language mean the limits of my world."
          </blockquote>
          <p className="mt-4 text-slate-500 font-semibold">— Ludwig Wittgenstein</p>
        </div>

        <div className="absolute top-0 right-0 w-96 h-96 bg-indigo-600 rounded-full blur-[100px] opacity-20 translate-x-1/2 -translate-y-1/2"></div>
        <div className="absolute bottom-0 left-0 w-96 h-96 bg-violet-600 rounded-full blur-[100px] opacity-20 -translate-x-1/2 translate-y-1/2"></div>
      </div>

      {/* --- RIGHT SIDE (Form / English Interface) --- */}
      <div className="flex-1 flex flex-col justify-center p-8 md:p-24 relative">
        <Link href="/" className="absolute top-8 left-8 text-slate-500 hover:text-indigo-600 flex items-center gap-2 text-sm font-bold md:hidden">
            <ArrowLeft className="w-4 h-4" /> Back
        </Link>

        <div className="max-w-sm w-full mx-auto">
          <h1 className="text-3xl font-extrabold text-slate-900 mb-2">Sign In</h1>
          <p className="text-slate-500 mb-8">Enter your credentials to access your account.</p>

          {error && (
            <div className="mb-6 p-4 bg-red-50 border border-red-200 text-red-600 rounded-xl flex items-center gap-3 text-sm font-medium animate-shake">
              <AlertCircle className="w-5 h-5 shrink-0" />
              {error}
            </div>
          )}

          <form onSubmit={handleLogin} className="space-y-5">
            <div>
              <label className="block text-sm font-bold text-slate-700 mb-2">Email Address</label>
              <input
                type="email"
                required
                className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all font-medium text-slate-900"
                placeholder="john.doe@example.com"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
              />
            </div>

            <div>
              <div className="flex justify-between items-center mb-2">
                <label className="block text-sm font-bold text-slate-700">Password</label>
                <a href="#" className="text-xs font-bold text-indigo-600 hover:text-indigo-700">Forgot password?</a>
              </div>
              <input
                type="password"
                required
                className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all font-medium text-slate-900"
                placeholder="••••••••"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
              />
            </div>

            <button
              type="submit"
              disabled={loading}
              className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl transition-all shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {loading ? (
                <>
                  <Loader2 className="w-5 h-5 animate-spin" />
                  Signing In...
                </>
              ) : (
                'Log In'
              )}
            </button>
          </form>

          <p className="mt-8 text-center text-sm text-slate-500">
            Don't have an account?{' '}
            <Link href="/register" className="font-bold text-indigo-600 hover:text-indigo-700">
              Create one for free
            </Link>
          </p>
        </div>
      </div>
    </div>
  )
}

--- FIN ARCHIVO: app\login\page.tsx ---

--- INICIO ARCHIVO: app\page.tsx ---
import Link from 'next/link';
import { Video, Mic, Globe, CheckCircle, ArrowRight, Play, Star, Calendar, Shield, CreditCard, Clock, Laptop, ChevronDown, Check } from 'lucide-react';

export default function Home() {
  return (
    <main className="min-h-screen bg-white text-slate-900 font-sans selection:bg-indigo-100 selection:text-indigo-700 scroll-smooth">
      
      {/* --- NAVBAR --- */}
      <nav className="fixed top-0 w-full z-50 bg-white/90 backdrop-blur-lg border-b border-slate-200 shadow-sm transition-all">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center h-20">
            <Link href="/" className="flex items-center gap-2 group">
              <div className="bg-gradient-to-br from-indigo-600 to-violet-700 p-2 rounded-xl shadow-lg shadow-indigo-200 group-hover:scale-105 transition-transform">
                <Globe className="w-6 h-6 text-white" />
              </div>
              <span className="text-2xl font-extrabold tracking-tight text-slate-900">
                Tutorio
              </span>
            </Link>
            
            <div className="hidden md:flex items-center gap-8 font-medium text-slate-600 text-sm">
              <Link href="/browse" className="hover:text-indigo-600 transition-colors">Find Tutors</Link>
              <a href="#features" className="hover:text-indigo-600 transition-colors">Features</a>
              <a href="#how-it-works" className="hover:text-indigo-600 transition-colors">How it works</a>
              <a href="#maestros" className="hover:text-indigo-600 transition-colors">Soy Maestro</a>
              <a href="#faq" className="hover:text-indigo-600 transition-colors">FAQ</a>
            </div>

            <div className="flex items-center gap-4">
              <Link href="/login" className="hidden sm:inline-flex px-5 py-2.5 text-slate-700 font-bold hover:text-indigo-600 transition-colors">
                Log in
              </Link>
              <Link href="/register" className="inline-flex items-center gap-2 px-6 py-3 bg-slate-900 text-white rounded-full font-bold hover:bg-slate-800 transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5">
                Get Started
              </Link>
            </div>
          </div>
        </div>
      </nav>

      {/* --- HERO SECTION --- */}
      <section className="pt-36 pb-20 lg:pt-48 lg:pb-32 relative overflow-hidden">
         {/* Fondo sutil */}
         <div className="absolute top-0 right-0 -z-10 opacity-40">
            <div className="w-[600px] h-[600px] bg-indigo-100 rounded-full blur-[100px] absolute -top-20 -right-20"></div>
            <div className="w-[500px] h-[500px] bg-blue-50 rounded-full blur-[100px] absolute top-40 right-40"></div>
         </div>

        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
          <div className="grid lg:grid-cols-2 gap-16 items-center">
            
            <div className="max-w-2xl">
              <div className="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-indigo-50 border border-indigo-100 text-indigo-700 text-xs font-bold uppercase tracking-wider mb-8">
                <span className="w-2 h-2 rounded-full bg-indigo-600 animate-pulse"></span>
                New: Integrated Digital Wallet
              </div>
              
              <h1 className="text-5xl lg:text-7xl font-extrabold tracking-tight leading-[1.1] mb-6 text-slate-900">
                Learn Spanish <br/>
                <span className="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-violet-600">
                  The Real Way.
                </span>
              </h1>
              
              <p className="text-lg text-slate-600 mb-10 leading-relaxed">
                Forget boring apps. Connect with verified native tutors in a professional video classroom designed for serious learning. Pay per class, learn at your pace.
              </p>

              <div className="flex flex-col sm:flex-row gap-4 mb-12">
                <Link href="/register" className="flex items-center justify-center gap-3 px-8 py-4 bg-indigo-600 text-white rounded-2xl font-bold text-lg hover:bg-indigo-700 transition-all shadow-xl shadow-indigo-200">
                  Find a Tutor
                  <ArrowRight className="w-5 h-5" />
                </Link>
                <a href="#how-it-works" className="flex items-center justify-center gap-3 px-8 py-4 bg-white text-slate-700 border-2 border-slate-200 rounded-2xl font-bold text-lg hover:border-indigo-600 hover:text-indigo-600 transition-all">
                   <Play className="w-5 h-5 fill-current" />
                   How it works
                </a>
              </div>

              <div className="flex items-center gap-4 text-sm font-medium text-slate-500">
                <div className="flex -space-x-3">
                   <div className="w-10 h-10 rounded-full bg-slate-200 border-2 border-white"></div>
                   <div className="w-10 h-10 rounded-full bg-slate-300 border-2 border-white"></div>
                   <div className="w-10 h-10 rounded-full bg-slate-400 border-2 border-white"></div>
                </div>
                <p>Join our growing community</p>
              </div>
            </div>

            {/* Hero Image */}
            <div className="relative mx-auto w-full max-w-[600px]">
              <div className="relative rounded-3xl overflow-hidden shadow-2xl border-8 border-white bg-slate-100">
                <img 
                  src="https://images.unsplash.com/photo-1522202176988-66273c2fd55f?auto=format&fit=crop&w=800&q=80" 
                  alt="Online tutoring session" 
                  className="w-full h-auto object-cover"
                />
              </div>
              <div className="absolute -bottom-6 -left-6 bg-white p-4 rounded-xl shadow-xl border border-slate-100 flex items-center gap-3 animate-bounce-slow">
                 <div className="bg-green-100 p-2 rounded-full"><CheckCircle className="w-6 h-6 text-green-600"/></div>
                 <div>
                    <p className="text-xs text-slate-500 font-bold uppercase">Certified</p>
                    <p className="font-bold text-slate-900">Native Speakers</p>
                 </div>
              </div>
            </div>

          </div>
        </div>
      </section>

      {/* --- DETAILED FEATURES --- */}
      <section id="features" className="py-24 bg-white">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div className="text-center max-w-3xl mx-auto mb-20">
                <h2 className="text-indigo-600 font-bold tracking-wide uppercase mb-4">Why Choose Tutorio?</h2>
                <p className="text-4xl font-extrabold text-slate-900">Everything you need to become fluent.</p>
            </div>

            {/* FEATURE 1: EL AULA */}
            <div className="flex flex-col md:flex-row items-center gap-12 mb-24">
                <div className="flex-1 order-2 md:order-1">
                    <div className="w-12 h-12 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center mb-6">
                        <Laptop className="w-6 h-6"/>
                    </div>
                    <h3 className="text-3xl font-bold text-slate-900 mb-4">Interactive Video Classroom</h3>
                    <p className="text-lg text-slate-600 leading-relaxed mb-6">
                        No need to install Zoom or Skype. Our classroom runs directly in your browser. It features:
                    </p>
                    <ul className="space-y-3">
                        <li className="flex items-center gap-3 text-slate-700 font-medium"><CheckCircle className="w-5 h-5 text-green-500"/> HD Video & Audio</li>
                        <li className="flex items-center gap-3 text-slate-700 font-medium"><CheckCircle className="w-5 h-5 text-green-500"/> Screen Sharing & Whiteboard</li>
                        <li className="flex items-center gap-3 text-slate-700 font-medium"><CheckCircle className="w-5 h-5 text-green-500"/> Chat with instant translation</li>
                    </ul>
                </div>
                <div className="flex-1 order-1 md:order-2">
                    <img src="https://images.unsplash.com/photo-1516321318423-f06f85e504b3?auto=format&fit=crop&w=800&q=80" alt="Classroom feature" className="rounded-3xl shadow-lg border border-slate-100"/>
                </div>
            </div>

            {/* FEATURE 2: PAGOS Y BILLETERA */}
            <div className="flex flex-col md:flex-row items-center gap-12 mb-24">
                <div className="flex-1">
                    <img src="https://images.unsplash.com/photo-1573164713988-8665fc963095?auto=format&fit=crop&w=800&q=80" alt="Secure Payment Easy" className="rounded-3xl shadow-lg border border-slate-100"/>
                </div>
                <div className="flex-1">
                    <div className="w-12 h-12 bg-green-100 text-green-600 rounded-2xl flex items-center justify-center mb-6">
                        <CreditCard className="w-6 h-6"/>
                    </div>
                    <h3 className="text-3xl font-bold text-slate-900 mb-4">Pay Per Lesson, Not Subscriptions</h3>
                    <p className="text-lg text-slate-600 leading-relaxed mb-6">
                        We believe in freedom. Load your wallet and pay only for the classes you book.
                    </p>
                    <ul className="space-y-3">
                        <li className="flex items-center gap-3 text-slate-700 font-medium"><CheckCircle className="w-5 h-5 text-green-500"/> Secure Wallet System</li>
                        <li className="flex items-center gap-3 text-slate-700 font-medium"><CheckCircle className="w-5 h-5 text-green-500"/> Transparent Pricing (Set by Tutors)</li>
                        <li className="flex items-center gap-3 text-slate-700 font-medium"><CheckCircle className="w-5 h-5 text-green-500"/> Money-back guarantee on cancellations</li>
                    </ul>
                </div>
            </div>

            {/* FEATURE 3: AGENDA */}
            <div className="flex flex-col md:flex-row items-center gap-12">
                <div className="flex-1 order-2 md:order-1">
                    <div className="w-12 h-12 bg-purple-100 text-purple-600 rounded-2xl flex items-center justify-center mb-6">
                        <Calendar className="w-6 h-6"/>
                    </div>
                    <h3 className="text-3xl font-bold text-slate-900 mb-4">Smart Scheduling</h3>
                    <p className="text-lg text-slate-600 leading-relaxed mb-6">
                        Booking a class is as easy as one click. We handle the time-zone math so you don't have to.
                    </p>
                    <ul className="space-y-3">
                        <li className="flex items-center gap-3 text-slate-700 font-medium"><CheckCircle className="w-5 h-5 text-green-500"/> Auto Time-zone Conversion</li>
                        <li className="flex items-center gap-3 text-slate-700 font-medium"><CheckCircle className="w-5 h-5 text-green-500"/> Instant Calendar Sync</li>
                        <li className="flex items-center gap-3 text-slate-700 font-medium"><CheckCircle className="w-5 h-5 text-green-500"/> Reminders before class</li>
                    </ul>
                </div>
                <div className="flex-1 order-1 md:order-2">
                    <img src="https://images.unsplash.com/photo-1506784983877-45594efa4cbe?auto=format&fit=crop&w=800&q=80" alt="Scheduling feature" className="rounded-3xl shadow-lg border border-slate-100"/>
                </div>
            </div>
        </div>
      </section>

      {/* --- HOW IT WORKS --- */}
      <section id="how-it-works" className="py-24 bg-slate-50 border-y border-slate-200">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div className="text-center mb-16">
                <h2 className="text-3xl font-extrabold text-slate-900">Start Speaking in 3 Steps</h2>
                <p className="text-slate-500 mt-4 max-w-2xl mx-auto">No complicated assessments. Just sign up and start learning.</p>
            </div>

            <div className="grid md:grid-cols-3 gap-8">
                {[
                    { step: "01", icon: <Shield className="w-8 h-8"/>, title: "Browse Profiles", desc: "Filter tutors by price, country, and specialty. Watch their intro videos to see if you click." },
                    { step: "02", icon: <CreditCard className="w-8 h-8"/>, title: "Book & Pay", desc: "Choose a time slot that works for you. Pay securely using your Tutorio Wallet." },
                    { step: "03", icon: <Video className="w-8 h-8"/>, title: "Connect", desc: "At the scheduled time, enter the Virtual Classroom and start your lesson instantly." },
                ].map((item, i) => (
                    <div key={i} className="bg-white p-10 rounded-3xl border border-slate-100 shadow-sm relative group hover:-translate-y-2 transition-transform duration-300">
                        <div className="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center mb-6 group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                            {item.icon}
                        </div>
                        <h3 className="text-xl font-bold text-slate-900 mb-3">{item.title}</h3>
                        <p className="text-slate-600 leading-relaxed">{item.desc}</p>
                        <span className="absolute top-6 right-8 text-6xl font-black text-slate-100 -z-0 select-none">{item.step}</span>
                    </div>
                ))}
            </div>
        </div>
      </section>

      {/* --- AUDIENCE SECTION --- */}
      <section className="py-24 bg-white">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              <div className="grid md:grid-cols-2 gap-12 items-center bg-slate-900 rounded-[3rem] p-12 text-white relative overflow-hidden">
                  <div className="relative z-10">
                      <h2 className="text-3xl md:text-4xl font-bold mb-6">Perfect for...</h2>
                      <div className="space-y-6">
                          <div className="flex gap-4">
                              <div className="bg-white/10 p-3 rounded-xl h-fit"><BriefcaseIcon /></div>
                              <div>
                                  <h4 className="font-bold text-lg">Professionals</h4>
                                  <p className="text-slate-400 text-sm">Improve your Business English or Spanish for better job opportunities.</p>
                              </div>
                          </div>
                          <div className="flex gap-4">
                              <div className="bg-white/10 p-3 rounded-xl h-fit"><PlaneIcon /></div>
                              <div>
                                  <h4 className="font-bold text-lg">Travelers</h4>
                                  <p className="text-slate-400 text-sm">Learn conversational skills to survive and thrive in your next trip.</p>
                              </div>
                          </div>
                          <div className="flex gap-4">
                              <div className="bg-white/10 p-3 rounded-xl h-fit"><GraduationIcon /></div>
                              <div>
                                  <h4 className="font-bold text-lg">Students</h4>
                                  <p className="text-slate-400 text-sm">Get help with homework or prepare for international exams.</p>
                              </div>
                          </div>
                      </div>
                  </div>
                  <div className="relative z-10 hidden md:block">
                      <img src="https://images.unsplash.com/photo-1523240795612-9a054b0db644?auto=format&fit=crop&w=800&q=80" className="rounded-2xl shadow-2xl transform rotate-3 hover:rotate-0 transition-transform duration-500" alt="Students"/>
                  </div>
                  
                  {/* Decorative Circles */}
                  <div className="absolute top-0 right-0 w-64 h-64 bg-indigo-600 rounded-full blur-[80px] opacity-40"></div>
                  <div className="absolute bottom-0 left-0 w-64 h-64 bg-violet-600 rounded-full blur-[80px] opacity-40"></div>
              </div>
          </div>
      </section>

      {/* --- NUEVA SECCIÓN: CONVIÉRTETE EN MAESTRO (ESPAÑOL) --- */}
      <section id="maestros" className="py-24 bg-slate-50 border-t border-slate-200">
        <div className="max-w-6xl mx-auto px-6 grid md:grid-cols-2 gap-12 items-center">
            
            {/* Texto de Venta */}
            <div>
              <span className="text-indigo-600 font-bold tracking-wider uppercase text-sm">Para Profesores</span>
              <h2 className="text-4xl font-extrabold mt-2 mb-6 text-slate-900 leading-tight">
                Comparte tu conocimiento. <br/>
                <span className="text-indigo-600">Gana bajo tus propios términos.</span>
              </h2>
              <p className="text-lg text-slate-600 mb-8 leading-relaxed">
                Únete a la plataforma que se encarga de lo aburrido (cobros, agenda, video) para que tú solo te enfoques en enseñar.
              </p>
              
              <div className="space-y-4 mb-8">
                <div className="flex gap-4">
                  <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center gap-3 w-full">
                     <span className="text-2xl">💰</span> 
                     <div>
                        <strong>Define tu Tarifa:</strong> 
                        <span className="block text-sm text-slate-500">Tú decides cuánto vale tu hora.</span>
                     </div>
                  </div>
                </div>
                <div className="flex gap-4">
                  <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center gap-3 w-full">
                     <span className="text-2xl">📅</span> 
                     <div>
                        <strong>Horario Flexible:</strong> 
                        <span className="block text-sm text-slate-500">Trabaja solo cuando quieras.</span>
                     </div>
                  </div>
                </div>
                <div className="flex gap-4">
                  <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center gap-3 w-full">
                     <span className="text-2xl">🔒</span> 
                     <div>
                        <strong>Pagos Seguros:</strong> 
                        <span className="block text-sm text-slate-500">Sin perseguir alumnos para cobrar.</span>
                     </div>
                  </div>
                </div>
              </div>

              <Link href="/register?role=teacher" className="inline-flex items-center justify-center px-8 py-4 text-base font-bold text-white transition-all duration-200 bg-indigo-600 border border-transparent rounded-full hover:bg-indigo-700 shadow-lg hover:shadow-indigo-500/30">
                Empezar a Enseñar Hoy
                <ArrowRight className="w-5 h-5 ml-2" />
              </Link>
            </div>

            {/* Visual */}
            <div className="relative">
                <div className="absolute inset-0 bg-gradient-to-tr from-indigo-600 to-purple-600 rounded-3xl transform rotate-3 opacity-10"></div>
                <div className="bg-white p-8 rounded-3xl shadow-xl border border-slate-100 relative">
                    <div className="flex items-center gap-4 mb-6 border-b border-slate-50 pb-6">
                        <div className="w-16 h-16 bg-slate-200 rounded-full overflow-hidden">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="Profesor" />
                        </div>
                        <div>
                            <h3 className="font-bold text-lg text-slate-900">Carlos Mendoza</h3>
                            <p className="text-indigo-600 text-sm font-medium">Profesor de Español</p>
                        </div>
                        <div className="ml-auto text-right">
                            <p className="text-2xl font-bold text-slate-900">$25<span className="text-sm font-normal text-slate-400">/h</span></p>
                        </div>
                    </div>
                    <div className="space-y-3">
                        <div className="h-2 bg-slate-100 rounded-full w-3/4"></div>
                        <div className="h-2 bg-slate-100 rounded-full w-1/2"></div>
                        <div className="h-2 bg-slate-100 rounded-full w-full"></div>
                    </div>
                    <div className="mt-6 flex justify-between items-center text-sm font-bold text-slate-600">
                        <span className="flex items-center gap-1"><Star className="w-4 h-4 text-yellow-400 fill-current"/> 4.9 (120 Clases)</span>
                        <span className="text-green-600 flex items-center gap-1"><CheckCircle className="w-4 h-4"/> Verificado</span>
                    </div>
                </div>
            </div>

        </div>
      </section>

      {/* --- FAQ SECTION --- */}
      <section id="faq" className="py-24 bg-white">
          <div className="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
              <h2 className="text-3xl font-extrabold text-center text-slate-900 mb-12">Frequently Asked Questions</h2>
              <div className="space-y-4">
                  {[
                      { q: "How do I pay for lessons?", a: "You can load funds into your Tutorio Wallet using a credit card or PayPal. Then, use that balance to book individual lessons." },
                      { q: "What happens if I cancel a class?", a: "If you cancel more than 24 hours in advance, you get a 100% refund to your wallet. Cancellations within 24 hours are paid to the tutor to respect their time." },
                      { q: "Do I need to download Zoom?", a: "No! We have a built-in video classroom that works in Chrome, Firefox, and Safari on your computer or phone." },
                      { q: "Can I become a tutor?", a: "Yes, we are always looking for passionate educators. Click 'Find Tutors' -> 'Become a Teacher' in the footer to apply." }
                  ].map((item, i) => (
                      <div key={i} className="bg-white border border-slate-200 rounded-xl p-6 hover:shadow-md transition-shadow">
                          <h3 className="font-bold text-lg text-slate-900 mb-2 flex justify-between items-center">
                              {item.q}
                              <ChevronDown className="w-5 h-5 text-slate-400"/>
                          </h3>
                          <p className="text-slate-600">{item.a}</p>
                      </div>
                  ))}
              </div>
          </div>
      </section>

      {/* --- FINAL CTA --- */}
      <section className="py-20 bg-white border-t border-slate-100">
        <div className="max-w-4xl mx-auto px-4 text-center">
          <h2 className="text-4xl font-extrabold text-slate-900 mb-6">
            Ready to start your journey?
          </h2>
          <p className="text-xl text-slate-500 mb-10">
            Join Tutorio today and connect with the perfect tutor for you.
          </p>
          <div className="flex flex-col sm:flex-row justify-center gap-4">
            <Link href="/register" className="inline-flex items-center justify-center gap-2 px-8 py-4 bg-indigo-600 text-white rounded-full font-bold text-lg hover:bg-indigo-700 transition-all shadow-xl">
                Create Free Account
            </Link>
            <Link href="/browse" className="inline-flex items-center justify-center gap-2 px-8 py-4 bg-slate-100 text-slate-700 rounded-full font-bold text-lg hover:bg-slate-200 transition-all">
                Browse Tutors First
            </Link>
          </div>
        </div>
      </section>

      {/* --- FOOTER --- */}
      <footer className="bg-slate-950 text-slate-400 py-12">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center gap-6">
            <div className="text-center md:text-left">
                <span className="text-2xl font-bold text-white">Tutorio</span>
                <p className="text-sm mt-2">© 2024 Tutorio Inc. All rights reserved.</p>
            </div>
            <div className="flex gap-8 text-sm font-medium">
                <Link href="/terms" className="hover:text-indigo-400">Terms</Link>
                <Link href="/privacy" className="hover:text-indigo-400">Privacy</Link>
                <Link href="/cookies" className="hover:text-indigo-400">Cookies</Link>
            </div>
        </div>
      </footer>

    </main>
  );
}

// Iconos Auxiliares
function BriefcaseIcon() { return <svg className="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg> }
function PlaneIcon() { return <svg className="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg> }
function GraduationIcon() { return <svg className="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M12 14l9-5-9-5-9 5 9 5z" /><path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222" /></svg> }

--- FIN ARCHIVO: app\page.tsx ---

--- INICIO ARCHIVO: app\privacy\page.tsx ---
import Link from 'next/link';
import { ArrowLeft } from 'lucide-react';

export default function PrivacyPage() {
  return (
    <main className="min-h-screen bg-slate-50 font-sans text-slate-900">
      <nav className="bg-white border-b border-slate-200 p-6 sticky top-0 z-10">
        <div className="max-w-4xl mx-auto flex items-center gap-4">
            <Link href="/" className="text-slate-500 hover:text-indigo-600 flex items-center gap-2 text-sm font-bold">
                <ArrowLeft className="w-4 h-4" /> Back to Home
            </Link>
            <span className="text-xl font-bold text-slate-900">Privacy Policy</span>
        </div>
      </nav>

      <div className="max-w-4xl mx-auto p-8 md:p-12 bg-white mt-8 mb-20 shadow-sm rounded-xl border border-slate-200">
        <h1 className="text-4xl font-extrabold mb-2 text-slate-900">Privacy Policy</h1>
        <p className="text-slate-500 mb-10">Effective Date: December 16, 2025</p>

        <div className="space-y-8 text-slate-700 leading-relaxed">
            <section>
                <h2 className="text-xl font-bold text-slate-900 mb-3">1. Information We Collect</h2>
                <p>We collect information you provide directly to us, such as when you create an account, update your profile, or communicate with us. This may include:</p>
                <ul className="list-disc pl-5 mt-2 space-y-1">
                    <li>Name and Contact Information (Email).</li>
                    <li>Payment Information (processed by Stripe/PayPal).</li>
                    <li>Profile Data (Biography, Languages spoken).</li>
                </ul>
            </section>

            <section>
                <h2 className="text-xl font-bold text-slate-900 mb-3">2. How We Use Your Information</h2>
                <p>We use the information we collect to:</p>
                <ul className="list-disc pl-5 mt-2 space-y-1">
                    <li>Connect students with tutors.</li>
                    <li>Process transactions and send related information.</li>
                    <li>Facilitate video calls and chat features.</li>
                    <li>Send technical notices, updates, and security alerts.</li>
                </ul>
            </section>

            <section>
                <h2 className="text-xl font-bold text-slate-900 mb-3">3. Data Sharing</h2>
                <p>We do not sell your personal data. We share information only in the following circumstances:</p>
                <ul className="list-disc pl-5 mt-2 space-y-1">
                    <li><strong>With Tutors/Students:</strong> To facilitate the lesson (e.g., displaying your name).</li>
                    <li><strong>Service Providers:</strong> Vendors who perform services for us (hosting, customer support).</li>
                    <li><strong>Legal Requirements:</strong> If required by law or to protect rights and safety.</li>
                </ul>
            </section>

            <section>
                <h2 className="text-xl font-bold text-slate-900 mb-3">4. Data Security</h2>
                <p>We implement appropriate technical and organizational measures to protect your personal data against unauthorized access, alteration, disclosure, or destruction.</p>
            </section>
        </div>
      </div>
    </main>
  )
}
--- FIN ARCHIVO: app\privacy\page.tsx ---

--- INICIO ARCHIVO: app\register\page.tsx ---
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import Link from 'next/link'
import { createClient } from '@/utils/supabase/client'
import { Loader2, AlertCircle, ArrowLeft, GraduationCap, School, Check, User, Mail, Lock } from 'lucide-react'

export default function RegisterPage() {
  const [role, setRole] = useState<'student' | 'teacher'>('student')
  const [fullName, setFullName] = useState('')
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  
  const [error, setError] = useState<string | null>(null)
  const [loading, setLoading] = useState(false)
  
  const router = useRouter()
  const supabase = createClient()

  // --- LÓGICA DE TEXTOS DINÁMICOS ---
  const texts = {
    student: {
      back: "Back to Home",
      heroTitle: "Start your journey.",
      heroDesc: "Join thousands of students mastering Spanish through real human connection.",
      formTitle: "Create Account",
      subTitle: "Select your role to get started",
      roleStudent: "I'm a Student",
      roleTeacher: "Soy Profesor", // Mantenemos este en español para que el maestro lo entienda
      labelName: "Full Name",
      placeholderName: "e.g. John Doe",
      labelEmail: "Email Address",
      labelPass: "Password",
      btnSubmit: "Create Student Account",
      loading: "Creating Account...",
      footerText: "Already have an account?",
      footerLink: "Sign in here",
      note: null
    },
    teacher: {
      back: "Volver al Inicio",
      heroTitle: "Comparte tu pasión.",
      heroDesc: "Sé parte de una red selecta de educadores latinos y genera ingresos enseñando tu idioma.",
      formTitle: "Crear Cuenta",
      subTitle: "Selecciona tu perfil para comenzar",
      roleStudent: "I'm a Student",
      roleTeacher: "Soy Profesor",
      labelName: "Nombre Completo",
      placeholderName: "Ej. María González",
      labelEmail: "Correo Electrónico",
      labelPass: "Contraseña",
      btnSubmit: "Unirme como Instructor",
      loading: "Creando Cuenta...",
      footerText: "¿Ya tienes una cuenta?",
      footerLink: "Inicia sesión aquí",
      note: "Nota Profesional: Al registrarte, aceptas pasar por nuestro proceso de verificación. Configurarás tus tarifas en el siguiente paso."
    }
  }

  const t = texts[role] // Selecciona el idioma según el rol actual

  const handleRegister = async (e: React.FormEvent) => {
    e.preventDefault()
    setError(null)
    setLoading(true)

    try {
      const { error } = await supabase.auth.signUp({
        email,
        password,
        options: {
          data: {
            full_name: fullName,
            role: role,
          },
        },
      })

      if (error) throw error

      router.refresh()
      if (role === 'teacher') {
        router.push('/dashboard/teacher/profile-setup') 
      } else {
        router.push('/dashboard/student') 
      }
      
    } catch (err: any) {
      setError(err.message || (role === 'student' ? 'Error creating account' : 'Error al crear cuenta'))
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="min-h-screen flex flex-col md:flex-row bg-white font-sans text-slate-900">
      
      {/* --- LADO IZQUIERDO (Visual + Texto Dinámico) --- */}
      <div className="hidden md:flex md:w-5/12 bg-slate-900 text-white p-12 flex-col justify-between relative overflow-hidden">
        <div className="relative z-10">
          <Link href="/" className="flex items-center gap-2 text-indigo-400 font-bold text-xl mb-6">
            <ArrowLeft className="w-5 h-5"/> {t.back}
          </Link>
          <h2 className="text-3xl font-bold mb-4">{t.heroTitle}</h2>
          <p className="text-indigo-200 text-lg leading-relaxed">
            {t.heroDesc}
          </p>
        </div>

        {/* Decoración */}
        <div className="absolute top-0 right-0 w-96 h-96 bg-indigo-600 rounded-full blur-[120px] opacity-20 translate-x-1/2 -translate-y-1/2"></div>
        <div className="absolute bottom-0 left-0 w-96 h-96 bg-violet-600 rounded-full blur-[120px] opacity-20 -translate-x-1/2 translate-y-1/2"></div>
        <div className="absolute inset-0 z-0 opacity-10 mix-blend-overlay" style={{backgroundImage: 'url("https://www.transparenttextures.com/patterns/cubes.png")'}}></div>
      </div>

      {/* --- LADO DERECHO (Formulario Dinámico) --- */}
      <div className="flex-1 flex flex-col justify-center p-6 md:p-20 overflow-y-auto">
        <div className="max-w-md w-full mx-auto">
          
          <div className="mb-10 text-center">
            <h1 className="text-4xl font-extrabold text-slate-900 mb-2">{t.formTitle}</h1>
            <p className="text-slate-500">{t.subTitle}</p>
          </div>

          {/* SELECTOR DE ROL */}
          <div className="grid grid-cols-2 gap-4 mb-8">
            <button
              type="button"
              onClick={() => setRole('student')}
              className={`p-4 rounded-2xl border-2 flex flex-col items-center gap-3 transition-all ${
                role === 'student' 
                  ? 'border-indigo-600 bg-indigo-50 text-indigo-700 ring-2 ring-indigo-200 ring-offset-2' 
                  : 'border-slate-200 text-slate-500 hover:border-slate-300 hover:bg-slate-50'
              }`}
            >
              <GraduationCap className={`w-8 h-8 ${role === 'student' ? 'text-indigo-600' : 'text-slate-400'}`} />
              <span className="font-bold text-sm">{t.roleStudent}</span>
              {role === 'student' && <div className="absolute top-2 right-2"><Check className="w-4 h-4 text-indigo-600"/></div>}
            </button>

            <button
              type="button"
              onClick={() => setRole('teacher')}
              className={`p-4 rounded-2xl border-2 flex flex-col items-center gap-3 transition-all ${
                role === 'teacher' 
                  ? 'border-violet-600 bg-violet-50 text-violet-700 ring-2 ring-violet-200 ring-offset-2' 
                  : 'border-slate-200 text-slate-500 hover:border-slate-300 hover:bg-slate-50'
              }`}
            >
              <School className={`w-8 h-8 ${role === 'teacher' ? 'text-violet-600' : 'text-slate-400'}`} />
              <span className="font-bold text-sm">{t.roleTeacher}</span>
              {role === 'teacher' && <div className="absolute top-2 right-2"><Check className="w-4 h-4 text-violet-600"/></div>}
            </button>
          </div>

          {error && (
            <div className="mb-6 p-4 bg-red-50 border border-red-200 text-red-600 rounded-xl flex items-center gap-3 text-sm font-medium animate-shake">
              <AlertCircle className="w-5 h-5 shrink-0" />
              {error}
            </div>
          )}

          {/* FORMULARIO */}
          <form onSubmit={handleRegister} className="space-y-5">
            
            <div className="relative">
              <label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 ml-1">{t.labelName}</label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <User className="h-5 w-5 text-slate-400" />
                </div>
                <input
                  type="text"
                  required
                  className="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all font-medium text-slate-900"
                  placeholder={t.placeholderName}
                  value={fullName}
                  onChange={(e) => setFullName(e.target.value)}
                />
              </div>
            </div>

            <div className="relative">
              <label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 ml-1">{t.labelEmail}</label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <Mail className="h-5 w-5 text-slate-400" />
                </div>
                <input
                  type="email"
                  required
                  className="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all font-medium text-slate-900"
                  placeholder="name@example.com"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                />
              </div>
            </div>

            <div className="relative">
              <label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 ml-1">{t.labelPass}</label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <Lock className="h-5 w-5 text-slate-400" />
                </div>
                <input
                  type="password"
                  required
                  minLength={6}
                  className="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all font-medium text-slate-900"
                  placeholder="••••••••"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                />
              </div>
            </div>

            {/* Mensaje solo para maestro */}
            {role === 'teacher' && t.note && (
               <div className="bg-violet-50 p-4 rounded-xl border border-violet-100 text-xs text-violet-700 leading-relaxed">
                  {t.note}
               </div>
            )}

            <button
              type="submit"
              disabled={loading}
              className={`w-full font-bold py-4 rounded-xl transition-all shadow-lg flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed ${
                role === 'student' 
                  ? 'bg-indigo-600 hover:bg-indigo-700 text-white shadow-indigo-200'
                  : 'bg-slate-900 hover:bg-slate-800 text-white shadow-slate-300'
              }`}
            >
              {loading ? (
                <>
                  <Loader2 className="w-5 h-5 animate-spin" />
                  {t.loading}
                </>
              ) : (
                t.btnSubmit
              )}
            </button>
          </form>

          <p className="mt-8 text-center text-sm text-slate-500">
            {t.footerText}{' '}
            <Link href="/login" className="font-bold text-indigo-600 hover:text-indigo-700">
              {t.footerLink}
            </Link>
          </p>
        </div>
      </div>
    </div>
  )
}
--- FIN ARCHIVO: app\register\page.tsx ---

--- INICIO ARCHIVO: app\room\[roomid]\page.tsx ---
'use client'

import { useState, useEffect, useRef, useCallback } from 'react'
import { useParams, useRouter } from 'next/navigation'
import { createClient } from '@/utils/supabase/client'
import { useWebRTC } from '@/hooks/useWebRTC' // <--- IMPORTACIÓN AGREGADA
import { Mic, MicOff, Video, VideoOff, Send, Languages, Loader2, MessageSquare, User, FileText, X, Image as ImageIcon, DollarSign, CheckCircle, ZoomIn, ZoomOut, RotateCw, RotateCcw, Move, Trash2 } from 'lucide-react'
import { Whiteboard } from '../../../components/whiteboard'



// --- CREDENCIALES ---
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!

interface Message {
    sender: string;
    text: string;
    isTranslation?: boolean;
}

declare global {
    interface Window {
        SpeechRecognition: any;
        webkitSpeechRecognition: any;
    }
}

export default function Classroom() {
    const params = useParams()
    const router = useRouter()
    const roomId = params.roomid
    const [supabase] = useState(() => createClient())

    // --- ESTADOS ---
    const [userRole, setUserRole] = useState<'teacher' | 'student' | null>(null)
    const [userId, setUserId] = useState<string | null>(null)
    const [isRoleLoading, setIsRoleLoading] = useState(true)
    
    const [hasJoined, setHasJoined] = useState(false)
    const [micOn, setMicOn] = useState(true)
    const [cameraOn, setCameraOn] = useState(true)

    // Chat
    const [messages, setMessages] = useState<Message[]>([])
    const [messageInput, setMessageInput] = useState('')

    // Traducción
    const [isTranscribing, setIsTranscribing] = useState(false);
    const [liveTranscription, setLiveTranscription] = useState('');
    const [liveTranslation, setLiveTranslation] = useState('');
    
    // Idiomas
    const [targetLang, setTargetLang] = useState('es');
    const [sourceLang, setSourceLang] = useState('en');
    const [isTranslatorActive, setIsTranslatorActive] = useState(true)

    // Recursos
    const [showResources, setShowResources] = useState(false)
    const [resources, setResources] = useState<any[]>([])
    const [activeResource, setActiveResource] = useState<string | null>(null)

    // --- NUEVO: ESTADOS PARA CONTROLAR EL RECURSO ---
    const [resourceScale, setResourceScale] = useState(1);
    const [resourceRotation, setResourceRotation] = useState(0);
    const [resourcePosition, setResourcePosition] = useState({ x: 0, y: 0 });

    // --- ESTADO DE COBRO ---
    const [bookingDetails, setBookingDetails] = useState<any>(null)
    const [isFinishing, setIsFinishing] = useState(false)

    // Refs
    const localVideoRef = useRef<HTMLVideoElement>(null)
    const remoteVideoRef = useRef<HTMLVideoElement>(null)
    const streamRef = useRef<MediaStream | null>(null)
    const recognitionRef = useRef<any>(null);
    const messagesEndRef = useRef<HTMLDivElement>(null)

    // --- INTEGRACIÓN WEBRTC (AGREGADO) ---
    // Determinamos quién inicia la llamada (Profesor)
    const isInitiator = userRole === 'teacher';
    // Llamamos al hook solo si ya tenemos el userId y hemos pulsado "Entrar" (hasJoined)
    // Pasamos strings vacíos si no están listos para evitar errores antes del join
    const { localStream, remoteStream, isConnected } = useWebRTC(
        hasJoined ? (roomId as string) : '', 
        userId || '', 
        isInitiator
    );

    const TEXTS = {
        teacher: {
            joinBtn: 'Iniciar Clase',
            check: 'Verifica tu equipo antes de entrar',
            waitingRemote: 'Esperando al Estudiante...',
            labelRemote: 'Estudiante',
            labelLocal: 'Tú (Maestro)',
            placeholder: 'Escribe un mensaje...',
            chatTitle: 'Chat del Aula',
            translateBtn: 'ACTIVAR VOZ',
            translatingBtn: 'ESCUCHANDO...',
            mute: 'Silenciar',
            unmute: 'Audio',
            stopCam: 'Apagar',
            startCam: 'Cámara',
            exit: 'SALIR',
            emptyChat: 'La clase ha comenzado. ¡Saluda!',
            resourcesBtn: 'Mis Recursos',
            resourcesTitle: 'Biblioteca de Clase',
            finishClass: 'TERMINAR Y COBRAR'
        },
        student: {
            joinBtn: 'Join Class',
            check: 'Check your mic & cam',
            waitingRemote: 'Waiting for Tutor...',
            labelRemote: 'Tutor',
            labelLocal: 'You (Student)',
            placeholder: 'Type a message...',
            chatTitle: 'Class Chat',
            translateBtn: 'START VOICE',
            translatingBtn: 'LISTENING...',
            mute: 'Mute',
            unmute: 'Unmute',
            stopCam: 'Stop Cam',
            startCam: 'Start Cam',
            exit: 'LEAVE',
            emptyChat: 'Say hello to your Tutor!',
            resourcesBtn: 'Resources',
            resourcesTitle: 'Class Library',
            finishClass: 'Waiting for teacher...'
        }
    }

    // --- 2. DETECTAR ROL Y BUSCAR RESERVA ACTIVA ---
    useEffect(() => {
        const fetchUserRoleAndBooking = async () => {
            setIsRoleLoading(true);
            try {
                const { data: { user } } = await supabase.auth.getUser();

                if (!user) {
                    setUserRole('student');
                } else {
                    setUserId(user.id);
                    const { data: profile } = await supabase.from('profiles').select('role').eq('id', user.id).single();
                    
                    const role = (profile?.role || 'student') as 'teacher' | 'student';
                    setUserRole(role);

                    if (role === 'teacher') {
                        setSourceLang('es'); setTargetLang('en');
                        
                        const today = new Date().toISOString().split('T')[0]
                        const { data: booking } = await supabase
                            .from('bookings')
                            .select('*')
                            .eq('teacher_id', user.id)
                            .eq('status', 'confirmed')
                            // .gte('date', today) // Comentado para pruebas
                            .order('time', { ascending: true })
                            .limit(1)
                            .single()
                        
                        if (booking) {
                            console.log("Reserva activa encontrada:", booking)
                            setBookingDetails(booking)
                        }
                    } else {
                        setSourceLang('en'); setTargetLang('es');
                    }
                }
            } catch (error) { 
                console.error("Error:", error);
            } finally {
                setIsRoleLoading(false);
            }
        }
        fetchUserRoleAndBooking()
    }, [supabase, router])

    // --- CARGAR RECURSOS ---
    useEffect(() => {
        if (userRole === 'teacher' && userId) {
            const fetchResources = async () => {
                const { data } = await supabase.from('resources').select('*').eq('teacher_id', userId).order('created_at', { ascending: false });
                if (data) setResources(data);
            };
            fetchResources();
        }
    }, [userRole, userId, supabase]);

    const t = userRole === 'teacher' ? TEXTS.teacher : TEXTS.student;

    // --- 3. CÁMARA (MODIFICADO: Usa el stream del Hook en lugar de pedirlo manualmente) ---
    useEffect(() => {
        // Cuando el hook nos da el localStream, lo asignamos a las referencias existentes
        // para no romper la lógica de mute/unmute que ya tenías
        if (localStream) {
            streamRef.current = localStream;
            if (localVideoRef.current) {
                localVideoRef.current.srcObject = localStream;
            }
        }
    }, [localStream])

    // --- 3.1 VIDEO REMOTO (AGREGADO) ---
    useEffect(() => {
        if (remoteStream && remoteVideoRef.current) {
            remoteVideoRef.current.srcObject = remoteStream;
        }
    }, [remoteStream])

    // Mantenemos tu lógica de "Preview" antes de entrar (HasJoined = false)
    // Si no ha entrado, forzamos una carga inicial simple para el preview
    useEffect(() => {
        const initPreview = async () => {
            if (!hasJoined && !streamRef.current) {
                try {
                     const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'user', width: { ideal: 1920 }, height: { ideal: 1080 } },
                        audio: true
                    })
                    streamRef.current = stream;
                    if (localVideoRef.current) localVideoRef.current.srcObject = stream;
                } catch (e) { console.error("Error preview", e) }
            }
        }
        initPreview();
    }, [hasJoined])

    useEffect(() => {
        if (hasJoined && localVideoRef.current && streamRef.current) {
            localVideoRef.current.srcObject = streamRef.current;
        }
    }, [hasJoined]);

    useEffect(() => {
        const stream = streamRef.current;
        if (!stream) return;
        stream.getAudioTracks().forEach(track => track.enabled = micOn);
        stream.getVideoTracks().forEach(track => track.enabled = cameraOn);
    }, [micOn, cameraOn]);

    useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }) }, [messages])

    // --- 4. TRADUCCIÓN API ---
    const translateText = async (text: string, source: string, target: string) => {
        if (!text.trim() || source === target) return text;
        try {
            const response = await fetch('/api/translate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text, source, target })
            });
            const data = await response.json();
            return data.translatedText || text;
        } catch (error) { return text; }
    };

    // --- 5. VOZ ---
    const handleToggleTranscription = useCallback(() => {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) { alert("Use Chrome"); return; }
        if (isTranscribing) {
            if (recognitionRef.current) recognitionRef.current.stop();
            setIsTranscribing(false); setLiveTranscription(''); setLiveTranslation(''); return;
        }
        const recognition = new SpeechRecognition();
        recognition.continuous = true; recognition.interimResults = true;
        recognition.lang = sourceLang === 'en' ? 'en-US' : (sourceLang === 'es' ? 'es-ES' : sourceLang);
        recognitionRef.current = recognition;
        recognition.onstart = () => setIsTranscribing(true);
        recognition.onresult = async (event: any) => {
            const result = event.results[event.results.length - 1];
            const transcript = result[0].transcript;
            setLiveTranscription(transcript);
            if (result.isFinal) {
                const translated = await translateText(transcript, sourceLang, targetLang);
                setLiveTranslation(translated);
            }
        };
        recognition.onerror = () => setIsTranscribing(false);
        recognition.start();
    }, [isTranscribing, sourceLang, targetLang]);

    // --- CHAT ---
    const handleSendMessage = async (e: React.FormEvent) => {
        e.preventDefault(); if (!messageInput.trim()) return;
        const originalText = messageInput;
        setMessages(prev => [...prev, { sender: t.labelLocal, text: originalText }]);
        setMessageInput('');
        if (isTranslatorActive) {
            const translatedText = await translateText(originalText, sourceLang, targetLang);
            if (translatedText && translatedText.toLowerCase() !== originalText.toLowerCase()) {
                setMessages(prev => [...prev, { sender: "AI Bot", text: translatedText, isTranslation: true }]);
            }
        }
    }

    const handleShareResource = (url: string) => {
        setActiveResource(url); setShowResources(false);
        // Reset transformaciones
        setResourceScale(1); setResourceRotation(0); setResourcePosition({x:0, y:0});
        setMessages(prev => [...prev, { sender: "Sistema", text: "📷 Recurso compartido en pizarra.", isTranslation: true }]);
    }

    // --- TERMINAR CLASE ---
    const handleFinishClass = async () => {
        if (!bookingDetails) return alert("No hay una reserva activa vinculada a esta sesión.");
        if (!confirm(`¿Terminar clase y cobrar?`)) return;

        setIsFinishing(true);
        try {
            const totalPaid = Number(bookingDetails.price_paid || 0);
            const platformFee = totalPaid * 0.20; 
            const teacherEarnings = totalPaid - platformFee;

            console.log(`Procesando pago: Total $${totalPaid}, Maestro +$${teacherEarnings}`);

            const { error: bookingError } = await supabase
                .from('bookings')
                .update({ status: 'completed' })
                .eq('id', bookingDetails.id);
            
            if (bookingError) throw new Error("Error actualizando reserva");

            const { data: wallet } = await supabase.from('wallets').select('balance').eq('user_id', userId).single();
            const currentBalance = Number(wallet?.balance || 0);
            
            const { error: walletError } = await supabase
                .from('wallets')
                .update({ balance: currentBalance + teacherEarnings })
                .eq('user_id', userId);

            if (walletError) throw new Error("Error depositando fondos");

            alert(`✅ ¡Clase finalizada!\nGanaste: $${teacherEarnings.toFixed(2)}\n(Comisión plataforma: $${platformFee.toFixed(2)})`);
            router.push('/dashboard/teacher');

        } catch (error: any) {
            console.error(error);
            alert("Error al procesar el cierre: " + error.message);
        } finally {
            setIsFinishing(false);
        }
    }

    if (isRoleLoading) return <div className="min-h-screen flex items-center justify-center bg-slate-50"><Loader2 className="animate-spin text-indigo-600 w-10 h-10" /></div>

    if (!hasJoined) {
        return (
            <div className="min-h-screen bg-slate-950 flex items-center justify-center p-4">
                <div className="w-full max-w-lg bg-slate-900 rounded-2xl overflow-hidden border border-slate-800 shadow-2xl">
                    <div className="h-64 bg-black relative">
                        <video ref={localVideoRef} autoPlay muted playsInline className={`w-full h-full object-cover transform scale-x-[-1] ${!cameraOn && 'hidden'}`} />
                        <div className="absolute bottom-4 flex justify-center w-full gap-4">
                            <button onClick={() => setMicOn(!micOn)} className={`p-3 rounded-full ${micOn ? 'bg-slate-700 hover:bg-slate-600' : 'bg-red-500'} text-white`}>{micOn ? <Mic size={20} /> : <MicOff size={20} />}</button>
                            <button onClick={() => setCameraOn(!cameraOn)} className={`p-3 rounded-full ${cameraOn ? 'bg-slate-700 hover:bg-slate-600' : 'bg-red-500'} text-white`}>{cameraOn ? <Video size={20} /> : <VideoOff size={20} />}</button>
                        </div>
                    </div>
                    <div className="p-8 text-center">
                        <h2 className="text-xl font-bold text-white mb-2">{t.joinBtn}</h2>
                        <button onClick={() => setHasJoined(true)} className="w-full mt-4 bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-xl font-bold transition-all">{userRole === 'teacher' ? 'ENTRAR' : 'ENTER'}</button>
                    </div>
                </div>
            </div>
        )
    }

    return (
        <div className="h-screen bg-slate-100 flex flex-col font-sans overflow-hidden">
            <header className="h-14 bg-white border-b border-slate-200 flex items-center justify-between px-6 shrink-0 z-10 shadow-sm">
                <div className="flex items-center gap-3">
                    {/* INDICADOR DE CONEXIÓN WEBRTC */}
                    <div className={`w-2.5 h-2.5 rounded-full ${isConnected ? 'bg-green-500' : 'bg-amber-500 animate-pulse'}`}/>
                    <span className="font-bold text-slate-700">AULA <span className="text-indigo-600">#{roomId}</span></span>
                    {bookingDetails && userRole === 'teacher' && (
                        <span className="ml-4 text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-bold flex items-center gap-1">
                            <DollarSign className="w-3 h-3"/> Clase Pagada
                        </span>
                    )}
                </div>
                <div className="flex items-center gap-2 text-sm bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-200">
                    <Languages className="w-4 h-4 text-slate-400"/>
                    <select value={sourceLang} onChange={(e) => setSourceLang(e.target.value)} className="bg-transparent font-medium text-slate-700 outline-none cursor-pointer">
                        <option value="en">English</option>
                        <option value="es">Español</option>
                        <option value="fr">Français</option>
                        <option value="pt">Português</option>
                    </select>
                    <span className="text-slate-300">→</span>
                    <select value={targetLang} onChange={(e) => setTargetLang(e.target.value)} className="bg-transparent font-bold text-indigo-600 outline-none cursor-pointer">
                        <option value="es">Español</option>
                        <option value="en">English</option>
                        <option value="fr">Français</option>
                        <option value="pt">Português</option>
                    </select>
                </div>
            </header>

            <div className="flex-1 flex overflow-hidden relative">
                {/* ZONA CENTRAL: PIZARRA + RECURSOS */}
                <div className="flex-1 bg-slate-50 relative flex flex-col items-center justify-center p-4 overflow-hidden">
                    
                    <div className="w-full max-w-5xl h-full border border-slate-200 rounded-xl overflow-hidden shadow-sm bg-white relative group">
                          
                         <Whiteboard roomId={roomId as string} /> 
                         
                         {/* --- RENDERIZADO INTELIGENTE DE RECURSOS (PDF/IMG) + CONTROLES --- */}
                         {activeResource && (
                            <>
                                {/* CAPA DE FONDO DEL RECURSO */}
                                <div 
                                    className="absolute inset-0 pointer-events-none flex items-center justify-center z-0"
                                    style={{
                                        transform: `translate(${resourcePosition.x}px, ${resourcePosition.y}px) scale(${resourceScale}) rotate(${resourceRotation}deg)`,
                                        transition: 'transform 0.1s linear',
                                        transformOrigin: 'center center'
                                    }}
                                >
                                    {activeResource.toLowerCase().includes('.pdf') ? (
                                        <embed src={activeResource} type="application/pdf" className="w-full h-full object-contain pointer-events-none" />
                                    ) : (
                                        <img src={activeResource} className="w-full h-full object-contain pointer-events-none" alt="Recurso" />
                                    )}
                                </div>

                                {/* BARRA DE CONTROLES FLOTANTE - VISIBLE SIEMPRE */}
                                <div className="absolute bottom-6 left-1/2 transform -translate-x-1/2 z-[9999] bg-white shadow-xl border border-slate-300 rounded-full px-4 py-2 flex items-center gap-4">
                                    <div className="flex items-center bg-slate-100 rounded-full p-1">
                                        <button onClick={() => setResourceScale(s => Math.max(0.5, s - 0.1))} className="p-2 hover:bg-white rounded-full text-slate-700 transition-colors"><ZoomOut size={16}/></button>
                                        <span className="text-xs font-mono font-bold w-10 text-center">{Math.round(resourceScale * 100)}%</span>
                                        <button onClick={() => setResourceScale(s => Math.min(3, s + 0.1))} className="p-2 hover:bg-white rounded-full text-slate-700 transition-colors"><ZoomIn size={16}/></button>
                                    </div>

                                    <div className="flex items-center bg-slate-100 rounded-full p-1">
                                        <button onClick={() => setResourceRotation(r => r - 90)} className="p-2 hover:bg-white rounded-full text-slate-700 transition-colors"><RotateCcw size={16}/></button>
                                        <button onClick={() => setResourceRotation(r => r + 90)} className="p-2 hover:bg-white rounded-full text-slate-700 transition-colors"><RotateCw size={16}/></button>
                                    </div>

                                    <div className="hidden md:flex gap-1 items-center bg-slate-100 rounded-lg p-1">
                                        <Move size={14} className="text-slate-400 ml-1"/>
                                        <button onClick={() => setResourcePosition(p => ({...p, y: p.y + 50}))} className="p-1.5 hover:bg-white rounded shadow-sm text-xs">⬇️</button>
                                        <button onClick={() => setResourcePosition(p => ({...p, y: p.y - 50}))} className="p-1.5 hover:bg-white rounded shadow-sm text-xs">⬆️</button>
                                        <button onClick={() => setResourcePosition(p => ({...p, x: p.x + 50}))} className="p-1.5 hover:bg-white rounded shadow-sm text-xs">➡️</button>
                                        <button onClick={() => setResourcePosition(p => ({...p, x: p.x - 50}))} className="p-1.5 hover:bg-white rounded shadow-sm text-xs">⬅️</button>
                                    </div>

                                    <button onClick={() => { setActiveResource(null); setResourceScale(1); setResourceRotation(0); setResourcePosition({x:0,y:0}) }} className="bg-red-100 text-red-600 hover:bg-red-200 p-2 rounded-full transition-colors" title="Cerrar Recurso"><Trash2 size={16}/></button>
                                </div>
                            </>
                         )}
                    </div>

                    {(liveTranscription || isTranscribing) && (<div className="absolute bottom-24 z-20 w-[90%] max-w-2xl"><div className="bg-black/90 backdrop-blur p-4 rounded-xl text-center shadow-2xl"><p className="text-slate-300 text-lg font-light mb-1">"{liveTranscription}"</p>{liveTranslation && <p className="text-yellow-400 text-xl font-bold">{liveTranslation}</p>}</div></div>)}
                </div>

                <div className="w-[400px] bg-white border-l border-slate-200 flex flex-col shrink-0 shadow-xl z-30">
                    <div className="bg-slate-900 p-3 flex flex-col gap-3 shrink-0 h-[400px]">
                        <div className="flex-1 bg-slate-800 rounded-lg overflow-hidden relative border border-slate-700">
                            {/* VIDEO REMOTO CONECTADO AL HOOK */}
                            <video ref={remoteVideoRef} autoPlay playsInline className="w-full h-full object-cover" />
                            {!isConnected && (
                                <div className="absolute inset-0 flex items-center justify-center text-white/50 text-xs gap-2">
                                    <Loader2 className="animate-spin w-4 h-4"/> Esperando video...
                                </div>
                            )}
                            <span className="absolute bottom-2 left-2 text-[10px] bg-indigo-600 text-white px-2 py-0.5 rounded font-bold">{t.labelRemote}</span>
                        </div>
                        <div className="h-32 bg-black rounded-lg overflow-hidden relative border border-slate-800">
                            <video ref={localVideoRef} autoPlay muted playsInline className={`w-full h-full object-cover transform scale-x-[-1] ${!cameraOn && 'opacity-0'}`} />
                            {!cameraOn && <div className="absolute inset-0 flex items-center justify-center text-white text-xs">📷 Off</div>}
                            <span className="absolute bottom-2 right-2 text-[10px] bg-black/60 text-white px-2 py-0.5 rounded font-bold">{t.labelLocal}</span>
                        </div>
                    </div>
                    <div className="flex-1 flex flex-col min-h-0 bg-slate-50/50 border-t border-slate-200">
                        <div className="p-3 bg-white border-b border-slate-100 flex justify-between items-center shadow-sm"><span className="text-xs font-bold text-slate-600 uppercase flex items-center gap-2"><MessageSquare size={14} className="text-indigo-500"/> {t.chatTitle}</span><div className="flex items-center gap-1"><span className="text-[10px] font-semibold text-slate-400">AI TRANSLATE</span><div onClick={() => setIsTranslatorActive(!isTranslatorActive)} className={`w-8 h-4 rounded-full p-0.5 cursor-pointer transition-colors ${isTranslatorActive ? 'bg-indigo-500' : 'bg-slate-300'}`}><div className={`w-3 h-3 bg-white rounded-full shadow-sm transform transition-transform ${isTranslatorActive ? 'translate-x-4' : 'translate-x-0'}`}/></div></div></div>
                        <div className="flex-1 overflow-y-auto p-3 space-y-3">{messages.map((msg, i) => (<div key={i} className={`flex flex-col ${msg.isTranslation ? 'items-center' : (msg.sender === t.labelLocal) ? 'items-end' : 'items-start'}`}><div className={`px-3 py-2 rounded-xl text-xs max-w-[90%] shadow-sm ${msg.isTranslation ? 'bg-amber-50 text-amber-900 border border-amber-200 text-center w-full italic' : (msg.sender === t.labelLocal) ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white border border-slate-200 text-slate-700 rounded-tl-none'}`}>{msg.text}</div>{!msg.isTranslation && <span className="text-[10px] text-slate-400 mt-1 mx-1">{msg.sender}</span>}</div>))}<div ref={messagesEndRef} /></div>
                        <form onSubmit={handleSendMessage} className="p-3 bg-white border-t border-slate-200 flex gap-2"><input value={messageInput} onChange={(e) => setMessageInput(e.target.value)} placeholder={t.placeholder} className="flex-1 bg-slate-100 text-xs px-3 py-2.5 rounded-lg outline-none" /><button type="submit" disabled={!messageInput.trim()} className="bg-indigo-600 hover:bg-indigo-700 text-white p-2.5 rounded-lg shadow-sm disabled:opacity-50"><Send size={16} /></button></form>
                    </div>
                </div>

                {showResources && userRole === 'teacher' && (
                    <div className="absolute left-0 top-0 bottom-0 w-64 bg-white border-r border-slate-200 shadow-2xl z-40 flex flex-col animate-in slide-in-from-left duration-200">
                        <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50"><h3 className="font-bold text-slate-800 text-sm flex items-center gap-2"><FileText className="w-4 h-4 text-indigo-600"/> {t.resourcesTitle}</h3><button onClick={() => setShowResources(false)} className="text-slate-400 hover:text-slate-600"><X className="w-4 h-4"/></button></div>
                        <div className="flex-1 overflow-y-auto p-3 space-y-2 bg-slate-50/50">{resources.map(res => (<div key={res.id} onClick={() => handleShareResource(res.file_url)} className="p-3 bg-white rounded-lg border border-slate-200 hover:border-indigo-300 hover:shadow-md cursor-pointer group transition-all"><div className="flex items-center gap-3"><div className="w-10 h-10 bg-slate-100 rounded-md flex items-center justify-center text-slate-400 group-hover:bg-indigo-50 group-hover:text-indigo-600">{res.file_type === 'image' ? <ImageIcon className="w-5 h-5"/> : <FileText className="w-5 h-5"/>}</div><div className="flex-1 min-w-0"><p className="text-xs font-bold text-slate-700 truncate">{res.title}</p></div></div></div>))}</div>
                    </div>
                )}
            </div>

            <footer className="h-14 bg-white border-t border-slate-200 flex items-center justify-between px-6 shrink-0 z-40 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.02)]">
                <div className="flex gap-2">
                    <button onClick={() => setMicOn(!micOn)} className={`px-3 py-2 rounded-lg transition-all flex items-center gap-2 text-xs font-bold ${micOn ? 'bg-slate-50 text-slate-600' : 'bg-red-50 text-red-600'}`}>{micOn ? <Mic size={16}/> : <MicOff size={16}/>}</button>
                    <button onClick={() => setCameraOn(!cameraOn)} className={`px-3 py-2 rounded-lg transition-all flex items-center gap-2 text-xs font-bold ${cameraOn ? 'bg-slate-50 text-slate-600' : 'bg-red-50 text-red-600'}`}>{cameraOn ? <Video size={16}/> : <VideoOff size={16}/>}</button>
                </div>

                {userRole === 'teacher' && (
                    <div className="flex gap-3">
                         <button onClick={() => setShowResources(!showResources)} className="px-4 py-2 rounded-lg text-xs font-bold border border-slate-200 flex items-center gap-2 bg-white hover:bg-slate-50 text-slate-600"><FileText className="w-4 h-4"/> {t.resourcesBtn}</button>
                         <button 
                            onClick={handleFinishClass} 
                            disabled={isFinishing || !bookingDetails}
                            className="px-6 py-2 bg-green-600 text-white hover:bg-green-700 text-xs font-bold rounded-lg border border-green-500 transition-colors shadow-sm flex items-center gap-2"
                        >
                            {isFinishing ? <Loader2 className="w-4 h-4 animate-spin"/> : <CheckCircle className="w-4 h-4"/>}
                            {t.finishClass}
                        </button>
                    </div>
                )}

                <div className="flex gap-3">
                    <button onClick={handleToggleTranscription} className={`px-4 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-2 shadow-sm ${isTranscribing ? 'bg-indigo-600 text-white animate-pulse' : 'bg-slate-800 text-white'}`}><Languages size={14} className={isTranscribing ? 'animate-spin' : ''} />{isTranscribing ? t.translatingBtn : t.translateBtn}</button>
                    <button onClick={() => { if(confirm('¿Salir sin terminar?')) router.push('/') }} className="px-4 py-2 bg-white text-red-600 hover:bg-red-50 text-xs font-bold rounded-lg border border-red-100 transition-colors">{t.exit}</button>
                </div>
            </footer>
        </div>
    )
}
--- FIN ARCHIVO: app\room\[roomid]\page.tsx ---

--- INICIO ARCHIVO: app\terms\page.tsx ---
import Link from 'next/link';
import { ArrowLeft } from 'lucide-react';

export default function TermsPage() {
  return (
    <main className="min-h-screen bg-slate-50 font-sans text-slate-900">
      <nav className="bg-white border-b border-slate-200 p-6 sticky top-0 z-10">
        <div className="max-w-4xl mx-auto flex items-center gap-4">
            <Link href="/" className="text-slate-500 hover:text-indigo-600 flex items-center gap-2 text-sm font-bold">
                <ArrowLeft className="w-4 h-4" /> Back to Home
            </Link>
            <span className="text-xl font-bold text-slate-900">Terms of Service</span>
        </div>
      </nav>

      <div className="max-w-4xl mx-auto p-8 md:p-12 bg-white mt-8 mb-20 shadow-sm rounded-xl border border-slate-200">
        <h1 className="text-4xl font-extrabold mb-2 text-slate-900">Terms of Service</h1>
        <p className="text-slate-500 mb-10">Last updated: December 16, 2025</p>

        <div className="space-y-8 text-slate-700 leading-relaxed">
            <section>
                <h2 className="text-xl font-bold text-slate-900 mb-3">1. Acceptance of Terms</h2>
                <p>By accessing and using Tutorio ("the Platform"), you agree to comply with and be bound by these Terms of Service. If you do not agree to these terms, please do not use our services.</p>
            </section>

            <section>
                <h2 className="text-xl font-bold text-slate-900 mb-3">2. User Accounts</h2>
                <p>To access certain features, you must register for an account. You agree to provide accurate, current, and complete information during the registration process and to update such information to keep it accurate, current, and complete.</p>
            </section>

            <section>
                <h2 className="text-xl font-bold text-slate-900 mb-3">3. Payments and Refunds</h2>
                <p><strong>Students:</strong> Payments for lessons are processed securely via our payment providers. You are charged at the time of booking.</p>
                <p><strong>Refunds:</strong> You may cancel a lesson up to 24 hours before the scheduled time for a full refund. Cancellations made within 24 hours are non-refundable to compensate the tutor's time.</p>
            </section>

            <section>
                <h2 className="text-xl font-bold text-slate-900 mb-3">4. User Conduct</h2>
                <p>You agree not to use the Platform to:</p>
                <ul className="list-disc pl-5 mt-2 space-y-1">
                    <li>Harass, abuse, or harm another person.</li>
                    <li>Record sessions without the explicit consent of all parties.</li>
                    <li>Distribute spam or malicious software.</li>
                </ul>
            </section>

            <section>
                <h2 className="text-xl font-bold text-slate-900 mb-3">5. Termination</h2>
                <p>We reserve the right to suspend or terminate your account at our sole discretion, without notice, for conduct that we believe violates these Terms or is harmful to other users of the Platform.</p>
            </section>
        </div>
      </div>
    </main>
  )
}
--- FIN ARCHIVO: app\terms\page.tsx ---

--- INICIO ARCHIVO: components\whiteboard.tsx ---
'use client'

import { useEffect, useRef, useState } from 'react'
import { createClient } from '@/utils/supabase/client'
import { Eraser, Pencil, Trash2, Undo, Download, MousePointer2 } from 'lucide-react'

interface WhiteboardProps {
  roomId: string
}

interface Point {
  x: number
  y: number
  color: string
  width: number
  type: 'start' | 'draw' | 'end' | 'clear'
}

export function Whiteboard({ roomId }: WhiteboardProps) {
  const [supabase] = useState(() => createClient())
  const canvasRef = useRef<HTMLCanvasElement>(null)
  const containerRef = useRef<HTMLDivElement>(null)
  
  // Estado local
  const [isDrawing, setIsDrawing] = useState(false)
  const [color, setColor] = useState('#4f46e5') // Indigo por defecto
  const [brushSize, setBrushSize] = useState(3)
  const [tool, setTool] = useState<'pencil' | 'eraser'>('pencil')
  
  // Referencia para el canal de comunicación
  const channelRef = useRef<any>(null)
  const lastPos = useRef<{ x: number; y: number } | null>(null)

  useEffect(() => {
    // 1. Configurar Canvas responsive
    const canvas = canvasRef.current
    const container = containerRef.current
    if (!canvas || !container) return

    const resizeCanvas = () => {
      // Guardamos la imagen actual para no perderla al redimensionar
      const tempCanvas = document.createElement('canvas')
      const tempCtx = tempCanvas.getContext('2d')
      tempCanvas.width = canvas.width
      tempCanvas.height = canvas.height
      tempCtx?.drawImage(canvas, 0, 0)

      // Redimensionamos
      canvas.width = container.clientWidth
      canvas.height = container.clientHeight
      
      // Restauramos la imagen (escalada si fuera necesario, aquí simple)
      const ctx = canvas.getContext('2d')
      if (ctx) {
        ctx.lineCap = 'round'
        ctx.lineJoin = 'round'
        ctx.drawImage(tempCanvas, 0, 0)
      }
    }

    window.addEventListener('resize', resizeCanvas)
    resizeCanvas() // Inicial

    // 2. Conectar a Supabase Realtime
    const channel = supabase.channel(`room-board-${roomId}`)

    channel
      .on('broadcast', { event: 'draw' }, ({ payload }: { payload: Point }) => {
        // Dibujar lo que viene del otro usuario
        drawOnCanvas(payload, false)
      })
      .subscribe()

    channelRef.current = channel

    return () => {
      window.removeEventListener('resize', resizeCanvas)
      supabase.removeChannel(channel)
    }
  }, [roomId])

  // Función principal de dibujo
  const drawOnCanvas = (point: Point, isLocal: boolean) => {
    const ctx = canvasRef.current?.getContext('2d')
    if (!ctx) return

    if (point.type === 'clear') {
      ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height)
      return
    }

    ctx.lineWidth = point.width
    ctx.strokeStyle = point.color
    
    // Si es borrador, usamos 'destination-out' para borrar transparencia, 
    // o pintamos blanco si preferimos (destination-out es mejor para capas)
    if (point.color === '#ffffff' && !isLocal) {
        ctx.globalCompositeOperation = 'destination-out'
    } else {
        ctx.globalCompositeOperation = 'source-over'
    }

    if (point.type === 'start') {
      ctx.beginPath()
      ctx.moveTo(point.x, point.y)
    } else if (point.type === 'draw') {
      ctx.lineTo(point.x, point.y)
      ctx.stroke()
    } else if (point.type === 'end') {
      ctx.closePath()
    }
  }

  // --- MANEJADORES DE EVENTOS LOCALES ---

  const getCoords = (e: React.MouseEvent | React.TouchEvent) => {
    const canvas = canvasRef.current
    if (!canvas) return { x: 0, y: 0 }
    
    const rect = canvas.getBoundingClientRect()
    const clientX = 'touches' in e ? e.touches[0].clientX : (e as React.MouseEvent).clientX
    const clientY = 'touches' in e ? e.touches[0].clientY : (e as React.MouseEvent).clientY
    
    return {
      x: clientX - rect.left,
      y: clientY - rect.top
    }
  }

  const startDrawing = (e: React.MouseEvent | React.TouchEvent) => {
    setIsDrawing(true)
    const { x, y } = getCoords(e)
    lastPos.current = { x, y }
    
    const ctx = canvasRef.current?.getContext('2d')
    if (ctx) {
        ctx.beginPath()
        ctx.moveTo(x, y)
    }

    // Emitir inicio
    broadcast({
      x, y, 
      color: tool === 'eraser' ? '#ffffff' : color, 
      width: brushSize, 
      type: 'start' 
    })
  }

  const draw = (e: React.MouseEvent | React.TouchEvent) => {
    if (!isDrawing) return
    const { x, y } = getCoords(e) // Posición actual

    const ctx = canvasRef.current?.getContext('2d')
    if (ctx) {
        // Configurar estilo local
        ctx.lineWidth = brushSize
        ctx.lineCap = 'round'
        ctx.lineJoin = 'round'
        ctx.strokeStyle = tool === 'eraser' ? '#ffffff' : color
        ctx.globalCompositeOperation = tool === 'eraser' ? 'destination-out' : 'source-over'
        
        // Dibujar línea
        ctx.lineTo(x, y)
        ctx.stroke()
    }
    
    // Emitir movimiento
    broadcast({
      x, y, 
      color: tool === 'eraser' ? '#ffffff' : color, 
      width: brushSize, 
      type: 'draw' 
    })
    
    lastPos.current = { x, y }
  }

  const stopDrawing = () => {
    if (!isDrawing) return
    setIsDrawing(false)
    const ctx = canvasRef.current?.getContext('2d')
    if(ctx) ctx.closePath()

    if (lastPos.current) {
        broadcast({
            x: lastPos.current.x,
            y: lastPos.current.y,
            color: tool === 'eraser' ? '#ffffff' : color,
            width: brushSize,
            type: 'end'
        })
    }
    lastPos.current = null
  }

  const clearBoard = () => {
    const ctx = canvasRef.current?.getContext('2d')
    if (!ctx) return
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height)
    
    broadcast({ x: 0, y: 0, color: '', width: 0, type: 'clear' })
  }

  const broadcast = (point: Point) => {
    channelRef.current?.send({
      type: 'broadcast',
      event: 'draw',
      payload: point
    })
  }

  const downloadBoard = () => {
      const link = document.createElement('a');
      link.download = `pizarra-${roomId}.png`;
      link.href = canvasRef.current?.toDataURL() || '';
      link.click();
  }

  return (
    <div className="w-full h-full flex flex-col relative" ref={containerRef}>
      {/* BARRA DE HERRAMIENTAS FLOTANTE */}
      <div className="absolute top-4 left-1/2 -translate-x-1/2 bg-white shadow-lg border border-slate-200 rounded-full px-4 py-2 flex items-center gap-4 z-10">
        
        {/* Colores */}
        <div className="flex items-center gap-2 pr-4 border-r border-slate-200">
            {['#000000', '#4f46e5', '#ef4444', '#22c55e', '#eab308'].map((c) => (
                <button
                    key={c}
                    onClick={() => { setColor(c); setTool('pencil') }}
                    className={`w-6 h-6 rounded-full border-2 transition-all ${color === c && tool === 'pencil' ? 'border-slate-800 scale-110' : 'border-transparent hover:scale-110'}`}
                    style={{ backgroundColor: c }}
                />
            ))}
        </div>

        {/* Herramientas */}
        <div className="flex items-center gap-2">
            <button 
                onClick={() => setTool('pencil')} 
                className={`p-2 rounded-lg transition-colors ${tool === 'pencil' ? 'bg-indigo-100 text-indigo-700' : 'hover:bg-slate-100 text-slate-600'}`}
                title="Lápiz"
            >
                <Pencil size={18} />
            </button>
            
            <button 
                onClick={() => setTool('eraser')} 
                className={`p-2 rounded-lg transition-colors ${tool === 'eraser' ? 'bg-indigo-100 text-indigo-700' : 'hover:bg-slate-100 text-slate-600'}`}
                title="Borrador"
            >
                <Eraser size={18} />
            </button>

            <div className="w-px h-6 bg-slate-200 mx-1"></div>

            <input 
                type="range" 
                min="1" max="20" 
                value={brushSize} 
                onChange={(e) => setBrushSize(parseInt(e.target.value))}
                className="w-20 cursor-pointer accent-indigo-600"
                title="Grosor"
            />
        </div>

        {/* Acciones */}
        <div className="flex items-center gap-2 pl-4 border-l border-slate-200">
            <button onClick={clearBoard} className="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Limpiar todo">
                <Trash2 size={18}/>
            </button>
            <button onClick={downloadBoard} className="p-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors" title="Guardar imagen">
                <Download size={18}/>
            </button>
        </div>
      </div>

      <canvas
        ref={canvasRef}
        onMouseDown={startDrawing}
        onMouseMove={draw}
        onMouseUp={stopDrawing}
        onMouseLeave={stopDrawing}
        onTouchStart={startDrawing}
        onTouchMove={draw}
        onTouchEnd={stopDrawing}
        className={`w-full h-full touch-none cursor-[url('https://api.iconify.design/lucide:pencil.svg'),_auto] ${tool === 'eraser' ? 'cursor-cell' : ''}`}
      />
    </div>
  )
}
--- FIN ARCHIVO: components\whiteboard.tsx ---

--- INICIO ARCHIVO: hooks\useWebRTC.ts ---
import { useEffect, useState, useRef } from 'react'
import { createClient } from '@/utils/supabase/client'
import SimplePeer from 'simple-peer'

// Definimos la estructura de la señal
interface SignalData {
  type: 'signal'
  payload: any
  userId: string
}

export const useWebRTC = (roomId: string, userId: string, isInitiator: boolean) => {
  const [supabase] = useState(() => createClient())
  const [stream, setStream] = useState<MediaStream | null>(null)
  const [remoteStream, setRemoteStream] = useState<MediaStream | null>(null)
  const [error, setError] = useState<string | null>(null)
  const [isConnected, setIsConnected] = useState(false)
  
  const peerRef = useRef<SimplePeer.Instance | null>(null)
  const channelRef = useRef<any>(null)

  useEffect(() => {
    // 1. Obtener media local (Cámara/Mic)
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then((currentStream) => {
        setStream(currentStream)
        initializePeer(currentStream)
      })
      .catch((err) => {
        console.error("Error accediendo a media:", err)
        setError("No se pudo acceder a la cámara o micrófono.")
      })

    return () => {
      // Cleanup al salir
      peerRef.current?.destroy()
      if (channelRef.current) supabase.removeChannel(channelRef.current)
      stream?.getTracks().forEach(track => track.stop())
    }
  }, [roomId, userId]) // Reiniciar si cambia la sala o usuario

  const initializePeer = (localStream: MediaStream) => {
    // Configuración del Peer
    const peer = new SimplePeer({
      initiator: isInitiator,
      trickle: false,
      stream: localStream,
      config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
    })

    // Evento: Cuando tenemos "señal" (datos de conexión) para enviar al otro
    // CORRECCIÓN: Agregado ': any' para evitar error de TypeScript
    peer.on('signal', (data: any) => {
      channelRef.current?.send({
        type: 'broadcast',
        event: 'signal',
        payload: { userId, signal: data }
      })
    })

    // Evento: Cuando recibimos video del otro
    // CORRECCIÓN: Agregado ': any' para evitar error de TypeScript
    peer.on('stream', (remoteStream: any) => {
      setRemoteStream(remoteStream)
      setIsConnected(true)
    })

    // CORRECCIÓN: Agregado ': any' para evitar error de TypeScript
    peer.on('error', (err: any) => {
      console.error('Peer error:', err)
      setIsConnected(false)
    })
    
    peer.on('close', () => {
        setIsConnected(false)
        setRemoteStream(null)
    })

    peerRef.current = peer
    subscribeToSignaling()
  }

  const subscribeToSignaling = () => {
    // Usamos Supabase Realtime como servidor de señalización
    const channel = supabase.channel(`room-${roomId}`)

    channel
      .on('broadcast', { event: 'signal' }, ({ payload }: { payload: any }) => {
        // Si la señal viene de MÍ MISMO, la ignoro
        if (payload.userId === userId) return

        // Si tengo un peer activo, le paso la señal del otro usuario
        if (peerRef.current) {
          peerRef.current.signal(payload.signal)
        }
      })
      .subscribe((status) => {
        if (status === 'SUBSCRIBED') {
           console.log("Conectado a señalización de Supabase")
        }
      })

    channelRef.current = channel
  }

  return { 
    localStream: stream, 
    remoteStream, 
    isConnected, 
    error 
  }
}
--- FIN ARCHIVO: hooks\useWebRTC.ts ---

--- INICIO ARCHIVO: middleware.ts ---
import { createServerClient, type CookieOptions } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function middleware(request: NextRequest) {
  // 1. Crear una respuesta inicial
  let response = NextResponse.next({
    request: {
      headers: request.headers,
    },
  })

  // 2. Configurar el cliente de Supabase para manejar las cookies de sesión
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return request.cookies.get(name)?.value
        },
        set(name: string, value: string, options: CookieOptions) {
          request.cookies.set({
            name,
            value,
            ...options,
          })
          response = NextResponse.next({
            request: {
              headers: request.headers,
            },
          })
          response.cookies.set({
            name,
            value,
            ...options,
          })
        },
        remove(name: string, options: CookieOptions) {
          request.cookies.set({
            name,
            value: '',
            ...options,
          })
          response = NextResponse.next({
            request: {
              headers: request.headers,
            },
          })
          response.cookies.set({
            name,
            value: '',
            ...options,
          })
        },
      },
    }
  )

  // 3. Refrescar la sesión si ha expirado (IMPORTANTE para que no te saque)
  const { data: { user } } = await supabase.auth.getUser()

  // 4. PROTECCIÓN BÁSICA SIN BUCLE
  // Solo si NO tienes usuario y tratas de entrar a una ruta protegida (/dashboard)
  if (!user && request.nextUrl.pathname.startsWith('/dashboard')) {
    return NextResponse.redirect(new URL('/login', request.url))
  }

  // 5. NO AGREGAMOS NINGUNA OTRA REDIRECCIÓN
  // Eliminamos cualquier lógica que diga "Si estás en login, vete a dashboard"
  // para evitar el bucle infinito. Dejamos que la página decida.

  return response
}

export const config = {
  matcher: [
    /*
     * Aplica a todas las rutas excepto estáticas e imágenes para no saturar
     */
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
}
--- FIN ARCHIVO: middleware.ts ---

--- INICIO ARCHIVO: next-env.d.ts ---
/// <reference types="next" />
/// <reference types="next/image-types/global" />
import "./.next/dev/types/routes.d.ts";

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.

--- FIN ARCHIVO: next-env.d.ts ---

--- INICIO ARCHIVO: next.config.ts ---
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
};

export default nextConfig;

--- FIN ARCHIVO: next.config.ts ---

--- INICIO ARCHIVO: package.json ---
{
  "name": "tutorio",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@supabase/auth-helpers-nextjs": "^0.15.0",
    "@supabase/ssr": "^0.8.0",
    "@supabase/supabase-js": "^2.87.3",
    "google-translate-api-x": "^10.7.2",
    "lucide-react": "^0.561.0",
    "next": "16.0.10",
    "react": "19.2.1",
    "react-dom": "19.2.1",
    "simple-peer": "^9.11.1"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "@types/simple-peer": "^9.11.9",
    "eslint": "^9",
    "eslint-config-next": "16.0.10",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}

--- FIN ARCHIVO: package.json ---

--- INICIO ARCHIVO: tsconfig.json ---
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}

--- FIN ARCHIVO: tsconfig.json ---

--- INICIO ARCHIVO: utils\supabase\client.ts ---
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}
--- FIN ARCHIVO: utils\supabase\client.ts ---
